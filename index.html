<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>webOS Connect - Preview 구현 버전</title>
  <script src="https://cdn.tailwindcss.com"></script>

<style>
input, select, textarea {
  border: 1.5px solid #999 !important;
  color: #111111 !important;
  font-weight: 550 !important;
  font-size: 14px !important;
}
input:focus, select:focus, textarea:focus {
  outline: 2px solid #2563eb;
  border-color: #2563eb;
}
label {
  font-weight: 600 !important;
  color: #333 !important;
}
body {
  font-weight: 500;
  color: #222;
}
</style>
</head>
<body class="bg-gray-100 text-gray-900 font-sans h-screen flex flex-col">
<div class="flex flex-1 overflow-hidden">
    
<aside id="sidebar" class="w-55 bg-[#1a2238] text-gray-200 border-r border-gray-800 p-5 space-y-6 flex flex-col transition-all duration-300">
    
<h1 class="text-2xl font-black tracking-tight mb-13 text-red-600 drop-shadow-lg select-none">
    webOS <span>Connect</span> </h1>    

    
<nav class="flex flex-col gap-3 text-lg font-semibold">
  <button onclick="navigate('dashboard')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">📊</span> Dashboard
  </button>
  <button onclick="navigate('features')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">🧩</span> Features
  </button>
  <button onclick="navigate('devices')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">🎛️</span> Devices
  </button>
  <button onclick="navigate('experiments')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">🧪</span> Experiments
  </button>
  <button onclick="navigate('segments')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">🗂️</span> Segments
  </button>
  <button onclick="navigate('environments')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">🌐</span> Environments
  </button>
  <button onclick="navigate('admin')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">⚙️</span> Admin
  </button>
</nav>

    <button id="sidebarToggle"
      onclick="toggleSidebar()"
      class="flex items-center gap-3 px-2 py-2 rounded-lg hover:bg-gray-800 transition text-3sm flex items-center justify-start gap-2">
      <span id="toggleIcon">◀</span><span id="toggleLabel">Collapse</span>
    </button>
  </aside>
  <main class="flex flex-1 flex-col overflow-visible">
    <div id="main-content" class="flex-1"></div>
    <template id="features-view-template">
          
        <div class="bg-gradient-to-r from-red-400 from-red-300 border-b border-gray-200 shadow-sm p-1 my-2 flex flex-wrap gap-3 items-center sticky top-0 z-20" id="filter-bar">
        <div class="flex flex-wrap gap-2 items-center" id="filters">
          <div class="relative overflow-visible z-50" id="add-filter-dropdown">
            <button class="px-4 py-1.5 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow hover:bg-blue-700 transition" onclick="toggleFilterMenu()">More</button>
            <div class="absolute right-0 mt-1 w-48 bg-white border border-gray-400 rounded shadow-lg hidden z-50" id="filter-menu"></div>
          </div>
        </div>
      </div>
      
      
      
      <div class="flex flex-1 overflow-hidden divide-x divide-gray-300">
        <section class="w-1/3 p-6 overflow-y-auto bg-white h-[calc(108vh-12rem)]">

<div class="flex items-center justify-between mb-4">
  <h2 class="text-xl font-semibold leading-none mb-0">Feature List</h2>
  <input id="feature-search" type="text"
         placeholder="Search features..."
         class="ml-3 px-3 py-2 border border-gray-300 rounded-lg text-base bg-gray-100 focus:outline-none focus:border-blue-400"
         style="width: 170px; height: 42px;" />
</div>

          <div class="space-y-6" id="feature-list"></div>
          
        </section>
        <section class="w-1/3 p-6 overflow-y-auto bg-white h-[calc(108vh-12rem)]" id="strategy-section" >
          
          
<div class="flex items-center mb-4" style="min-height:42px;">
  <h2 class="text-xl font-semibold leading-none mb-0">Feature Strategy</h2>
</div>
          
          
          <div class="text-sm text-gray-600" id="strategy-editor"></div>
        </section>
        <section class="w-1/3 p-6 overflow-y-auto bg-white h-[calc(108vh-12rem)]">
          <h2 class="text-xl font-semibold mb-4">Preview</h2>
          <div id="preview-panel"></div>
        </section>
      </div>
      <div class="bg-white border-t border-gray-400 p-4 flex justify-end gap-3">
        <button class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">Save</button>
        <button class="px-4 py-2 bg-white border border-gray-400 text-gray-800 rounded hover:bg-[#26314f]">Export</button>
      </div>
    </template>
  </main>
</div>
<!-- 🌐 Global Modal -->
<div id="globalModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white text-black p-6 rounded-lg shadow-lg w-80 text-center">
    <h2 id="modalTitle" class="text-xl font-bold mb-2">Notice</h2>
    <p id="modalMessage" class="mb-4">Your message goes here.</p>
    <button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
  </div>
</div>

<!-- Feature Matrix Modal & 팝오버 -->
<div id="matrixModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-[950px] max-w-full p-7 relative">
    <h3 class="text-xl font-bold mb-4">
      Feature Matrix – <span id="matrixFeatureName"></span>
    </h3>
    <div class="flex gap-5 mb-4 items-center">
      <label class="font-semibold">Row:</label>
      <select id="matrixRowField" class="border px-2 py-1 rounded"></select>
      <label class="font-semibold">Column:</label>
      <select id="matrixColField" class="border px-2 py-1 rounded"></select>
    </div>
    <div id="matrixTable" class="relative"></div>
    <button onclick="closeMatrixModal()" class="absolute top-3 right-5 text-lg font-bold text-gray-400 hover:text-red-600">✕</button>
  </div>
</div>
<div id="matrixCellPopover" class="absolute z-50 hidden"></div>

<script>

let currentEnv = "production"; // 기본 환경

const environmentNames = ["development", "staging", "production"];

const appData = {
  features: [
    // 1. 홈런처
    {
      id: "homeLauncher",
      name: "Home Launcher",
      defaultValue: { enabled: true, homeType: "full-home" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          homeType: {
            type: "string",
            enum: ["full-home", "smart-screen", "ad-optimized"]
          }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 2. 음성인식
    {
      id: "voice",
      name: "Voice",
      defaultValue: { enabled: false, mode: "basic" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          mode: { type: "string", enum: ["basic", "advanced"] }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 3. 방송
    {
      id: "broadcast",
      name: "Broadcast",
      defaultValue: { enabled: true,channel: "DVB", regionLock: true },
      schema: {
        type: "object",
        properties: {
            enabled: { type: "boolean" },
          channel: { type: "string", enum: ["DVB", "ATSC", "ISDB"] },
          regionLock: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 4. 네트워크
    {
      id: "network",
      name: "Network",
      defaultValue: { enabled: true, ethernet: true, wifi: true, wifiBand: "5GHz" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          ethernet: { type: "boolean" },
          wifi: { type: "boolean" },
          wifiBand: { type: "string", enum: ["2.4GHz", "5GHz"] }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 5. 앱스토어 (Tizen, Android TV)
    {
      id: "appStore",
      name: "App Store",
      defaultValue: { enabled: true, autoUpdate: false },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          autoUpdate: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 6. 미디어 플레이어 (Media Playback)
    {
      id: "mediaPlayer",
      name: "Media Player",
      defaultValue: { enabled: true, codec: "universal" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          codec: { type: "string", enum: ["universal", "h264", "vp9", "av1"] }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 7. 화면 미러링 (Cast/Miracast/AirPlay)
    {
      id: "screenMirroring",
      name: "Screen Mirroring",
      defaultValue: { enabled: true, type: "miracast" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          type: { type: "string", enum: ["miracast", "airplay", "chromecast"] }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 8. HDMI CEC
    {
      id: "hdmiCec",
      name: "HDMI CEC",
      defaultValue: { enabled: true, autoSwitch: true },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          autoSwitch: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 9. 음장/사운드 설정 (Sound Mode)
    {
      id: "soundMode",
      name: "Sound Mode",
      defaultValue: { enabled: true, mode: "standard" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          mode: { type: "string", enum: ["standard", "cinema", "sports", "game", "music"] }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 10. 블루투스
    {
      id: "bluetooth",
      name: "Bluetooth",
      defaultValue: { enabled: true, multiPair: false },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          multiPair: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 11. 음량 레벨러 (Volume Leveler)
    {
      id: "volumeLeveler",
      name: "Volume Leveler",
      defaultValue: { enabled: false },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 12. 광고 (Ad)
    {
      id: "ads",
      name: "Ads",
      defaultValue: { enabled: true, adType: "standard" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          adType: { type: "string", enum: ["standard", "interactive", "none"] }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 13. 키즈모드 (Kids Mode)
    {
      id: "kidsMode",
      name: "Kids Mode",
      defaultValue: { enabled: false, timeLimit: 60 },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          timeLimit: { type: "number" } // 분 단위
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 14. 절전모드 (Energy Saving)
    {
      id: "energySaving",
      name: "Energy Saving",
      defaultValue: { enabled: false, level: "normal" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          level: { type: "string", enum: ["off", "normal", "max"] }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 15. 다국어 (Locale)
    {
      id: "locale",
      name: "Locale",
      defaultValue: { language: "en", country: "US" },
      schema: {
        type: "object",
        properties: {
          language: { type: "string", enum: ["en", "ko", "zh", "vi", "th"] },
          country: { type: "string", enum: ["US", "KR", "CN", "VN", "TH"] }
        }
      },
      strategies: [],
      applyMode: "build"
    }
    // ... 필요 시 추가 가능
  ],

  platforms: [
    { id: "25", version: "webOS 25", deviceGroups: ["O22-2024", "k8lp-2024", "O24-2025", "K24-2025"] },
    { id: "26", version: "webOS 26", deviceGroups: ["O22-2024", "k8lp-2024", "O24-2025", "K24-2025", "O26-2026", "K26-2026"] }
  ],
  deviceGroups: [
    { id: "O22-2024", name: "2024 OLED", machine: "O22", manufactureYear: "2024", devices: ["oled24", "oled24-gaming", "oled24-starwars"] },
    { id: "k8lp-2024", name: "2024 Nano", machine: "k8lp", manufactureYear: "2024", devices: ["nano24"] },
    { id: "O24-2025", name: "2025 OLED", machine: "O24", manufactureYear: "2025", devices: ["oled25", "oled25-senior"] },
    { id: "K24-2025", name: "2025 QNED", machine: "K24", manufactureYear: "2025", devices: ["qn25"] },
    { id: "O26-2026", name: "2026 OLED", machine: "O26", manufactureYear: "2026", devices: ["oled26"] },
    { id: "K26-2026", name: "2026 QNED", machine: "K26", manufactureYear: "2026", devices: ["qn26"] }
  ],
  devices: [
    { id: "oled24", name: "24 OLED", memory: "2.5", tier: "premium", edition: "standard" },
    { id: "nano24", name: "24 Nano", memory: "1.5", tier: "basic", edition: "standard" },
    { id: "oled24-gaming", name: "24 OLED Gaming", memory: "2.5", tier: "premium", edition: "gaming" },
    { id: "oled24-starwars", name: "24 OLED StarWars", memory: "2.5", tier: "premium", edition: "starwars" },
    { id: "oled25-senior", name: "25 OLED Senior", memory: "2.5", tier: "standard", edition: "senior" },
    { id: "oled25", name: "25 OLED", memory: "2.5", tier: "premium", edition: "standard" },
    { id: "qn25", name: "25 QNED", memory: "2.0", tier: "standard", edition: "standard" },
    { id: "oled26", name: "26 OLED", memory: "2.5", tier: "premium", edition: "standard" },
    { id: "qn26", name: "26 QNED", memory: "2.0", tier: "standard", edition: "standard" }
  ],
  countryData: ["KR", "US", "VN", "TH"]
};

const filterFields = [
  { key: "platform.version", title: "Platform", path: "platforms", field: "version" },
  { key: "deviceGroup.name", title: "Device Group", path: "deviceGroups", field: "name" },
  { key: "device.name", title: "Device", path: "devices", field: "name" },
  { key: "country", title: "Country", path: "countryData" },
  { key: "deviceGroup.manufactureYear", title: "Manufacture Year", path: "deviceGroups", field: "manufactureYear" },
  { key: "deviceGroup.machine", title: "Machine", path: "deviceGroups", field: "machine" },
  { key: "device.memory", title: "Memory", path: "devices", field: "memory" },
  { key: "device.tier", title: "Tier", path: "devices", field: "tier" },
  { key: "device.edition", title: "Edition", path: "devices", field: "edition" }
];

let currentFilters = {
  "platform.version": undefined,
  "deviceGroup.name": undefined,
  "device.name": undefined,
  "country": undefined
};
let selectedFeatureId = null;
let defaultSettingsOpen = true;


function getFilterValues(config) {
  const dataSource = appData[config.path];
  const field = config.field;
  if (!field) return dataSource;
  const set = new Set(dataSource.map(d => d[field]).filter(Boolean));
  return [...set];
}

function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const icon = document.getElementById("toggleIcon");
  const label = document.getElementById("toggleLabel");
  const isCollapsed = sidebar.classList.toggle("w-16");
  sidebar.classList.toggle("w-55");
  sidebar.classList.toggle("overflow-hidden");
  if (isCollapsed) {
    icon.textContent = "▶";
    label.textContent = "";
  } else {
    icon.textContent = "◀";
    label.textContent = "Collapse";
  }
}
</script>


<script>
function toggleFeature(id, newValue) {
  const feature = appData.features.find(f => f.id === id);
  if (feature && 'enabled' in feature.defaultValue) {
    feature.defaultValue.enabled = newValue;
    renderFeatures();
    renderPreview();
  }
}

function renderFeatures() {
  const container = document.getElementById("feature-list");
  if (!container) return;
  container.innerHTML = "";

  // 필터/검색 적용된 리스트
  const q = (document.getElementById("feature-search")?.value || "").trim().toLowerCase();
  const features = !q
    ? appData.features
    : appData.features.filter(f =>
        f.name.toLowerCase().includes(q) ||
        f.id.toLowerCase().includes(q)
      );

  features.forEach((f, idx) => {
    const card = document.createElement("div");
    let baseClass = `
      bg-white rounded-2xl
      p-6 mb-6
      border-2 border-gray-400
      shadow-lg
      hover:shadow-2xl
      transition
      cursor-pointer
    `.replace(/\s+/g, ' ');

    if (f.id === selectedFeatureId) {
      baseClass += " border-blue-500 ring-2 ring-blue-300";
    } else {
      baseClass += " border-gray-400 shadow-[0_2px_6px_rgba(0,0,0,0.12)]";
    }
    card.className = baseClass;

    // ---- 드래그앤드랍 핵심 (id 기반) ----
    card.setAttribute('draggable', true);

    card.ondragstart = (e) => {
      e.dataTransfer.setData("featureId", f.id); // idx가 아니라 id만 사용!
      card.style.opacity = 0.6;
    };
    card.ondragend = (e) => {
      card.style.opacity = "";
      document.querySelectorAll(".feature-dropzone").forEach(el => el.classList.remove("ring-4", "ring-blue-400"));
    };
    card.ondragover = (e) => {
      e.preventDefault();
      card.classList.add("feature-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondragleave = (e) => {
      card.classList.remove("feature-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondrop = (e) => {
      e.preventDefault();
      card.classList.remove("feature-dropzone", "ring-4", "ring-blue-400");
      const fromId = e.dataTransfer.getData("featureId");
      const toId = f.id;
      if (fromId === toId) return;

      // 항상 원본 배열에서 이동!
      const fromIdx = appData.features.findIndex(ff => ff.id === fromId);
      const toIdx = appData.features.findIndex(ff => ff.id === toId);
      if (fromIdx === -1 || toIdx === -1) return;
      // 실제 이동
      const [moved] = appData.features.splice(fromIdx, 1);
      appData.features.splice(toIdx, 0, moved);
      renderFeatures();
    };

    // 선택 이벤트 (클릭)
    card.addEventListener("click", () => {
      selectedFeatureId = f.id;
      renderFeatures();
      renderStrategyEditor();
      renderPreview();
    });

    // 기존 카드 내용(생략 없이)
    const tagKeys = Object.keys(f.defaultValue);
    let tagHTML = tagKeys.slice(0, 2).map(k => {
      const value = f.defaultValue[k];
      let color = "bg-blue-100 text-blue-800";
      if (typeof value === "boolean") {
        color = value
          ? "bg-green-100 text-green-800"
          : "bg-red-100 text-red-800";
      }
      return `<span class='inline-block ${color} px-2 py-0.5 rounded-full text-xs'>${k}: ${value}</span>`;
    }).join(" ");

    if (tagKeys.length > 2) {
      tagHTML += ` <span class='text-xs text-gray-500'>+${tagKeys.length - 2} more...</span>`;
    }

    let toggle = "";
    if ("enabled" in f.defaultValue) {
      toggle = `
        <label class='relative inline-flex items-center cursor-pointer'>
          <input type='checkbox' class='sr-only peer'
                 ${f.defaultValue.enabled ? "checked" : ""}
                 onchange="event.stopPropagation(); toggleFeature('${f.id}', this.checked)" />
          <div class='w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 transition-colors'></div>
          <div class='absolute left-[2px] top-[2px] bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-full'></div>
        </label>`;
    }

    card.innerHTML = `
      <div class='flex justify-between items-center'>
        <h3 class='text-lg font-semibold'>${f.name}</h3>
        ${toggle}
      </div>
      <p class='text-sm text-gray-500 mt-1'>Default Values</p>
      <div class='mt-3 text-sm text-gray-600 space-x-1'>${tagHTML}</div>
    `;

    container.appendChild(card);
  });
}

function renderFilterBar() {
  const filtersDiv = document.getElementById("filters");
  const dropdown = document.getElementById("add-filter-dropdown");
  filtersDiv.innerHTML = "";

  for (const key in currentFilters) {
    const config = filterFields.find(f => f.key === key);
    if (!config) continue;

    const wrapper = document.createElement("div");
    wrapper.className = "flex items-center gap-2 bg-transparent px-2 py-1 rounded";

    const label = document.createElement("label");
    label.textContent = config.title;
    label.className = "font-semibold text-base text-gray-700";
    wrapper.appendChild(label);

    const select = document.createElement("select");
    select.className = "border rounded-lg px-2 py-1 font-bold text-base bg-blue-50 shadow focus:ring-2 focus:ring-blue-400";;
    select.onchange = (e) => {
      currentFilters[key] = e.target.value === "All" ? undefined : e.target.value;
      renderPreview();
    };

    const values = getFilterValues(config);
    [undefined, ...values].forEach(v => {
      const opt = document.createElement("option");
      opt.value = v || "All";
      opt.text = v || "All";
      if (currentFilters[key] === v || (v === undefined && currentFilters[key] === undefined)) {
        opt.selected = true;
      }
      select.appendChild(opt);
    });

    wrapper.appendChild(select);

    if (!["platform.version", "deviceGroup.name", "device.name", "country"].includes(key)) {
      const del = document.createElement("button");
      del.textContent = "✕";
      del.className = "ml-1 text-2xs font-semibold text-black hover:text-red-700";
      del.onclick = () => {
        delete currentFilters[key];
        renderFilterBar();
        renderPreview();
      };
      wrapper.appendChild(del);
    }

    filtersDiv.appendChild(wrapper);
  }

  if (dropdown) filtersDiv.appendChild(dropdown);
}

function toggleFilterMenu() {
  const menu = document.getElementById("filter-menu");
  menu.classList.toggle("hidden");
  renderFilterMenu();
}

function renderFilterMenu() {
  const menu = document.getElementById("filter-menu");
  menu.innerHTML = "";
  const unused = filterFields.filter(f => !(f.key in currentFilters));
  unused.forEach(f => {
    const btn = document.createElement("button");
    btn.textContent = f.title;
    btn.className = "w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-[#26314f]";
    btn.onclick = () => {
      currentFilters[f.key] = undefined;
      menu.classList.add("hidden");
      renderFilterBar();
      renderPreview();
    };
    menu.appendChild(btn);
  });
}

// ------ 전략 평가/프리뷰 렌더 ------

function evaluateStrategyForPreview(feature, filters) {
  if (!feature || !feature.strategies) return { type: "default", value: feature.defaultValue };

  for (let strat of feature.strategies) {
    if (!strat.conditions || strat.conditions.length === 0) continue;
    let match = strat.conditions.every(cond => {
      const filterValue = filters[cond.field];
      
      /*
  alert("condition.field:"+ cond.field+
    "| filterValue:"+ filterValue+
    "| cond.value:"+cond.value+
    "| op:"+ cond.op);
      */
      if (filterValue === undefined) return false;
      if (cond.op === "=") return String(filterValue) === String(cond.value);
if (cond.op === "!=") return String(filterValue) !== String(cond.value);

      if (cond.op === "in") return Array.isArray(cond.value) ? cond.value.includes(filterValue) : false;
      if (cond.op === "not in") return Array.isArray(cond.value) ? !cond.value.includes(filterValue) : false;
      return false;
    });
    if (match) {
      if (strat.type === "experiment") {
        return { type: "experiment", strat };
      }
      if (strat.type === "canary") {
        return { type: "canary", strat };
      }
      return { type: "rule", strat };
    }
  }
  return { type: "default", value: feature.defaultValue };
}

function renderPrettyObject(obj) {
  if (!obj || typeof obj !== 'object') return '';
  return `
    <table class="min-w-[180px] bg-white border border-gray-300 rounded shadow-sm text-sm mb-2">
      <tbody>
      ${Object.entries(obj).map(([k, v]) => `
        <tr>
          <td class="py-1 px-2 font-base font-semibold text-right align-top text-blue-700 bg-gray-50 border-b border-gray-200">${k}</td>
          <td class="py-1 px-2">
            ${typeof v === 'boolean'
              ? `<span class="inline-block px-2 py-0.5 rounded-full font-bold ${v ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${v ? 'true' : 'false'}</span>`
              : `<span class="inline-block px-2 py-0.5 rounded font-bold bg-gray-100 text-gray-900">${v}</span>`
            }
          </td>
        </tr>
      `).join('')}
      </tbody>
    </table>
  `;
}

function renderPreview() {
  const previewDiv = document.getElementById("preview-panel");
  previewDiv.innerHTML = "";

  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) {
    previewDiv.innerHTML = `<div class="text-gray-400 italic">No feature selected.</div>`;
    return;
  }

  const result = evaluateStrategyForPreview(feature, currentFilters);

  if (result.type === "default") {
    previewDiv.innerHTML = `
      <div class="mb-2 text-gray-800"> 
        <span class="font-semibold">Default Settings Applied</span>
        <div class="text-gray-500 text-xs">No strategy matches the current filters; default values are used.</div>
      </div>
      ${renderPrettyObject(result.value)}
    `;
  } else if (result.type === "rule") {
    previewDiv.innerHTML = `
      <div class="mb-2">
        <span class="font-semibold text-blue-600">🎯 Rule Strategy Applie : ${result.strat.customLabel || "Rule"}</span>
        <div class="text-gray-500 text-xs mb-1">Conditions: ${result.strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
      </div>

      ${renderPrettyObject(result.strat.value)}
    `;
  } else if (result.type === "experiment") {
    const { strat } = result;
    previewDiv.innerHTML = `
      <div class="mb-2">
        <span class="font-semibold text-green-600">🧪 Experiment Strategy Applied: ${strat.customLabel || "Experiment"}</span>
        <div class="text-gray-500 text-xs mb-1">Conditions: ${strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
      </div>
      <div class="space-y-2">
        ${strat.variants.map(variant => `
          <div class="flex items-center gap-2">
            <span class="px-2 py-0.5 bg-gray-200 rounded">${variant.name}</span>
            <span class="text-xs text-gray-500">Rollout: ${variant.rollout}%</span>
            ${renderPrettyObject(variant.value)}
          </div>
        `).join("")}
      </div>
    `;
  } else if (result.type === "canary") {
    const { strat } = result;
    previewDiv.innerHTML = `
      <div class="mb-2">
        <span class="font-semibold text-yellow-600">🐤 Canary Strategy Applie: ${strat.customLabel || "Canary"}</span>
        <div class="text-gray-500 text-xs mb-1">Conditions: ${strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
        <div class="text-base text-yellow-800 font-bold mb-2">Rollout: ${strat.rollout}%</div>
      </div>
${renderPrettyObject(strat.value)}
    `;
  }
}
</script>

<script>



function renderStrategyEditor() {
  const editor = document.getElementById("strategy-editor");
  editor.innerHTML = "";

const envBar = document.createElement("div");
envBar.className = "flex justify-end items-center mb-4";

const feature = appData.features.find(f => f.id === selectedFeatureId);

if (!feature) {
  editor.innerHTML = `<div class="text-gray-400 text-base italic">No feature selected.</div>`;
  return;
}

if (!feature.strategies) feature.strategies = [];

// 라벨(선택적)
const envLabel = document.createElement("span");
envLabel.textContent = "Environment";
envLabel.className = "mr-2 text-sm font-semibold text-blue-700";
envBar.appendChild(envLabel);

// 셀렉트박스
const envSelector = document.createElement("select");
envSelector.className = "px-2 py-1 border rounded bg-blue-50 text-blue-900 font-semibold text-sm";
environmentNames.forEach(env => {
  const opt = document.createElement("option");
  opt.value = env;
  opt.textContent = env.charAt(0).toUpperCase() + env.slice(1);
  if (currentEnv === env) opt.selected = true;
  envSelector.appendChild(opt);
});
envSelector.onchange = (e) => {
  currentEnv = e.target.value;
  renderStrategyEditor();
  renderPreview();
};
envBar.appendChild(envSelector);

const applyModeLabel = document.createElement("span");
applyModeLabel.textContent = "Deploy";
applyModeLabel.className = "ml-6 mr-2 text-sm font-semibold text-blue-700";
envBar.appendChild(applyModeLabel);

const applyModeSelect = document.createElement("select");
applyModeSelect.className = "px-2 py-1 border rounded bg-blue-50 text-blue-900 font-semibold text-sm";

["build", "remote", "both"].forEach(mode => {
  const opt = document.createElement("option");
  opt.value = mode;
  opt.textContent = mode === "build" ? "Build" : mode === "remote" ? "Remote" : "Both";
  if (feature.applyMode === mode) opt.selected = true;
  applyModeSelect.appendChild(opt);
});
applyModeSelect.onchange = (e) => {
  feature.applyMode = e.target.value;
  renderStrategyEditor();
};
envBar.appendChild(applyModeSelect);
// 실제 에디터 맨 위에 붙이기
editor.appendChild(envBar);


 
  // --- Default Settings Box ---
  const defaultBox = document.createElement("div");
  defaultBox.className = "border-2 border-gray-300 bg-gray-50 shadow-lg p-4 mb-5 hover:shadow-2xl"; 
  const headerDiv = document.createElement("div");
  headerDiv.className = "flex items-center justify-between mb-3 ";
  const title = document.createElement("h3");
  title.className = "text-base font-semibold text-black";
  title.innerText = "Default Settings";
  const toggleBtn = document.createElement("button");
  toggleBtn.className = "text-sm border px-2 py-1 rounded";
  toggleBtn.innerHTML = "📂";
  let form = document.createElement("form");
  form.className = "space-y-4" + (defaultSettingsOpen ? "" : " hidden");;
  form.onsubmit = e => {
    e.preventDefault();
    const data = new FormData(form);
    for (let [k, v] of data.entries()) {
      if (feature.schema.properties[k].type === "boolean") {
        feature.defaultValue[k] = v === "true";
      } else {
        feature.defaultValue[k] = v;
      }
    }
    renderFeatures();
    renderPreview();
    showModal("Default Settings Saved", "Your default settings have been saved successfully.");
  };

  Object.entries(feature.schema.properties).forEach(([key, def]) => {
    const fieldWrapper = document.createElement("div");
    const label = `<label class='block font-medium mb-1'>${key}</label>`;
    let input = "";
    const currentValue = feature.defaultValue[key];

    if (def.enum) {
      input += `<select name='${key}' class='w-full border px-2 py-1 rounded'>
        ${def.enum.map(val => `<option value='${val}' ${val === currentValue ? "selected" : ""}>${val}</option>`).join("")}
      </select>`;
    } else if (def.type === "boolean") {
      input += `<select name='${key}' class='w-full border px-2 py-1 rounded'>
        <option value='true' ${currentValue === true ? "selected" : ""}>true</option>
        <option value='false' ${currentValue === false ? "selected" : ""}>false</option>
      </select>`;
    } else {
      input += `<input name='${key}' value='${currentValue}' class='w-full border px-2 py-1 rounded' />`;
    }

    fieldWrapper.innerHTML = label + input;
    form.appendChild(fieldWrapper);
  });

  const saveBtn = document.createElement("button");
  saveBtn.type = "submit";
  saveBtn.className = "px-4 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700";
  saveBtn.textContent = "Save Default";
  form.appendChild(saveBtn);

  toggleBtn.onclick = () => {
    defaultSettingsOpen = !defaultSettingsOpen;
    form.classList.toggle("hidden", !defaultSettingsOpen);
    toggleBtn.innerHTML = defaultSettingsOpen ? "📂" : "📁";
  };

  headerDiv.appendChild(title);
  headerDiv.appendChild(toggleBtn);
  defaultBox.appendChild(headerDiv);
  defaultBox.appendChild(form);
  editor.appendChild(defaultBox);

  // --- Divider
  const divider = document.createElement("hr");
  divider.className = "my-6 border-gray-400";
  editor.appendChild(divider);

  // --- Strategies Toolbar ---
  const strategyTitle = document.createElement("div");
  strategyTitle.className = "flex justify-between items-center mb-3 w-full";
  const titleText = document.createElement("h3");
  titleText.className = "text-base font-semibold";
  titleText.textContent = "Feature Strategies";
  const collapseBtn = document.createElement("button");
  collapseBtn.innerHTML = "📂";
  collapseBtn.className = "text-sm px-2 py-1 border rounded whitespace-nowrap";
  strategyTitle.appendChild(titleText);
  strategyTitle.appendChild(collapseBtn);
  editor.appendChild(strategyTitle);

  // --- Strategy List ---
  const strategyList = document.createElement("div");
  strategyList.className = "space-y-3 mb-4";
  feature.strategies.forEach((s, i) => {
    const card = document.createElement("div");
    card.setAttribute('draggable', true);
    card.dataset.index = i;
    card.ondragstart = (e) => {
      e.dataTransfer.setData("strategyIndex", i);
      card.style.opacity = 0.6;
    };
    card.ondragend = (e) => {
      card.style.opacity = "";
      document.querySelectorAll(".strategy-dropzone").forEach(el => el.classList.remove("ring-4", "ring-blue-400"));
    };
    card.ondragover = (e) => {
      e.preventDefault();
      card.classList.add("strategy-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondragleave = (e) => {
      card.classList.remove("strategy-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondrop = (e) => {
      e.preventDefault();
      card.classList.remove("strategy-dropzone", "ring-4", "ring-blue-400");
      const fromIndex = Number(e.dataTransfer.getData("strategyIndex"));
      const toIndex = Number(card.dataset.index);
      if (fromIndex === toIndex) return;
      const moved = feature.strategies.splice(fromIndex, 1)[0];
      feature.strategies.splice(toIndex, 0, moved);
      renderStrategyEditor();
      renderPreview();
    };

    // 카드 유형 표시
    const typeMap = {
      rule: { label: "Rule", emoji: "🎯", border: "border-blue-500", text: "text-blue-800" },
      experiment: { label: "Experiment", emoji: "🧪", border: "border-green-500", text: "text-green-800" },
      canary: { label: "Canary", emoji: "🐤", border: "border-yellow-500", text: "text-yellow-800" }
    };
    const type = typeMap[s.type] || { label: s.type, emoji: "❓", border: "border-gray-400", text: "text-gray-800" };
   // card.className = "bg-white rounded-lg shadow-md p-3 border-l-4 " + type.border;
   //card.className = "bg-white rounded-lg  shadow-md p-5 my-3 shadow-xl border-2 border-blue-500 border-l-4 " + type.border;
   card.className = `
  bg-white rounded-2xl
  border-2 border-gray-400
  shadow-lg
  hover:shadow-2xl
  transition
  cursor-pointer
  p-5 my-4
  ${type.border}
`.replace(/\s+/g, ' ');

    // 카드 헤더
    const header = document.createElement("div");
    header.className = "flex justify-between items-start mb-1";
    const labelBox = document.createElement("div");
    labelBox.className = "flex items-center gap-2 font-semibold " + type.text + " text-sm";
    labelBox.innerHTML = `
      <span>${type.emoji}</span>
      <span class="strategy-label w-38 truncate">${s.customLabel || type.label}</span>
      <input type="text" class="strategy-input hidden border px-1 py-0.5 rounded text-sm w-38 truncate"
             value="${s.customLabel || type.label}"
             onblur='saveStrategyLabel(this,"${feature.id}", "${s.id}")'
             onkeydown="if(event.key==='Enter'){this.blur();}" />
    `;
    const actionBox = document.createElement("div");
    actionBox.className = "flex items-center gap-1";

    const toggleBtn = document.createElement("button");
    toggleBtn.innerHTML = s.collapsed ? "📁" : "📂";
    toggleBtn.title = "Toggle Strategy Body";
    toggleBtn.onclick = () => {
      const panel = document.getElementById('strategy-section');
      const prevScroll = panel.scrollTop;
      body.classList.toggle("hidden");
      s.collapsed = body.classList.contains("hidden");
      toggleBtn.innerHTML = s.collapsed ? "📁" : "📂";
      panel.scrollTop = prevScroll;
    };

    const upBtn = document.createElement("button");
    upBtn.textContent = "▲";
    upBtn.title = "Move Up";
    upBtn.onclick = () => moveStrategyUp(feature.id, i);

    const downBtn = document.createElement("button");
    downBtn.textContent = "▼";
    downBtn.title = "Move Down";
    downBtn.onclick = () => moveStrategyDown(feature.id, i);

    const delBtn = document.createElement("button");
    delBtn.textContent = "❌";
    delBtn.title = "Delete";
    delBtn.className = "text-gray-400 hover:text-red-500 text-sm";
    delBtn.onclick = () => removeStrategy(feature.id, s.id);

    const editBtn = document.createElement("button");
    editBtn.textContent = "✏️";
    editBtn.title = "Edit";
    editBtn.className = "text-blue-600 text-sm";
    editBtn.onclick = () => {
      const label = labelBox.querySelector(".strategy-label");
      const input = labelBox.querySelector(".strategy-input");
      if (label && input) {
        label.classList.add("hidden");
        input.classList.remove("hidden");
        input.focus();
        input.select();
      }
    };

    actionBox.appendChild(editBtn);
    actionBox.appendChild(toggleBtn);
    actionBox.appendChild(upBtn);
    actionBox.appendChild(downBtn);
    actionBox.appendChild(delBtn);

    header.appendChild(labelBox);
    header.appendChild(actionBox);
    card.appendChild(header);

    // 카드 바디
    const body = document.createElement("div");
    body.className = "strategy-body" + (s.collapsed ? " hidden" : "");
    body.appendChild(renderStrategyFormUI(feature, s));
    card.appendChild(body);

    strategyList.appendChild(card);
  });
  editor.appendChild(strategyList);

  // 전체 펼치기/접기 동기화
  collapseBtn.onclick = () => {
    const allBodies = strategyList.querySelectorAll(".strategy-body");
    const allHidden = Array.from(allBodies).every(div => div.classList.contains("hidden"));
    allBodies.forEach(div => div.classList.toggle("hidden", !allHidden));
    strategyList.querySelectorAll("button[title='Toggle Strategy Body']").forEach(btn => {
      btn.innerHTML = allHidden ? "📂" : "📁";
    });
    feature.strategies.forEach(s => s.collapsed = !allHidden);
    collapseBtn.innerHTML = allHidden ? "📂" : "📁";
  };

  // Add 버튼
  const addBtnGroup = document.createElement("div");
  addBtnGroup.className = "flex flex-wrap justify-start gap-2 mb-4";
  function makeAddButton(icon, label, color, onClick) {
    const btn = document.createElement("button");
    btn.className = `flex items-center gap-1 px-3 py-1 rounded-full ${color.bg} ${color.text} text-sm font-semibold hover:brightness-105 transition`;
    btn.innerHTML = `＋ ${icon} ${label}`;
    btn.onclick = onClick;
    return btn;
  }
  const colors = {
    rule: { bg: "bg-blue-100", text: "text-blue-800" },
    experiment: { bg: "bg-green-100", text: "text-green-800" },
    canary: { bg: "bg-yellow-100", text: "text-yellow-800" }
  };
  const addRuleBtn = makeAddButton("🎯", "Rule", colors.rule, () => {
    feature.strategies.push({
      id: `r-${Date.now()}`,
      type: "rule",
      customLabel: "Rule",
      conditions: [],
      value: { ...feature.defaultValue },
      collapsed: true
    });
    renderStrategyEditor();
    renderPreview();
  });
  
  
  const addExpBtn = makeAddButton("🧪", "Experiment", colors.experiment, () => {
  feature.strategies.push({
    id: `e-${Date.now()}`,
    type: "experiment",
    customLabel: "Experiment",
    conditions: [],
    variants: [
      { name: "A", value: { ...feature.defaultValue }, rollout : 50},
      { name: "B", value: { ...feature.defaultValue }, rollout : 50}
    ],
    collapsed: true
  });
  renderStrategyEditor();
  renderPreview();
});
  
  
  const addCanaryBtn = makeAddButton("🐤", "Canary", colors.canary, () => {
  feature.strategies.push({
    id: `c-${Date.now()}`,
    type: "canary",
    customLabel: "Canary",
    conditions: [],
    value: { ...feature.defaultValue }, // ← 요 부분!
    rollout : 10,
    collapsed: true
  });
  renderStrategyEditor();
  renderPreview();
});
// ▼ 매트릭스 버튼 추가
const matrixBtn = document.createElement("button");
matrixBtn.textContent = "🗂️ Matrix";
matrixBtn.className = "ml-3 px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 font-bold border border-blue-300 hover:bg-blue-100";
matrixBtn.onclick = openMatrixModal;


  addBtnGroup.appendChild(addRuleBtn);
  addBtnGroup.appendChild(addExpBtn);
  addBtnGroup.appendChild(addCanaryBtn);
  addBtnGroup.appendChild(matrixBtn);
  editor.appendChild(addBtnGroup);

  const saveStrategiesBtn = document.createElement("button");
  saveStrategiesBtn.className = "px-4 py-2 bg-gray-800 text-white font-semibold rounded hover:bg-gray-700";
  saveStrategiesBtn.textContent = "Save Strategies";
  saveStrategiesBtn.onclick = () => {
    showModal("Strategies Saved", "Your strategies have been saved successfully.");
  };
  editor.appendChild(saveStrategiesBtn);


}

function removeStrategy(featureId, strategyId) {
  const feature = appData.features.find(f => f.id === featureId);
  if (!feature || !feature.strategies) return;
  feature.strategies = feature.strategies.filter(s => s.id !== strategyId);
  renderStrategyEditor();
  renderPreview();
}
function moveStrategyUp(featureId, index) {
  const feature = appData.features.find(f => f.id === featureId);
  if (!feature || index <= 0) return;
  const temp = feature.strategies[index];
  feature.strategies[index] = feature.strategies[index - 1];
  feature.strategies[index - 1] = temp;
  renderStrategyEditor();
  renderPreview();
}
function moveStrategyDown(featureId, index) {
  const feature = appData.features.find(f => f.id === featureId);
  if (!feature || index >= feature.strategies.length - 1) return;
  const temp = feature.strategies[index];
  feature.strategies[index] = feature.strategies[index + 1];
  feature.strategies[index + 1] = temp;
  renderStrategyEditor();
  renderPreview();
}
function saveStrategyLabel(input, featureId, strategyId) {
  const newLabel = input.value.trim();
  const label = input.closest(".flex").querySelector(".strategy-label");
  const feature = appData.features.find(f => f.id === featureId);
  const strategy = feature?.strategies?.find(s => s.id === strategyId);
  if (label && newLabel && strategy) {
    label.textContent = newLabel;
    strategy.customLabel = newLabel;
    renderPreview();
  }
  input.classList.add("hidden");
  label.classList.remove("hidden");
}

// 내비게이션 및 화면 렌더
let currentView = 'features';
function navigate(view) {
  currentView = view;
  renderMain();
  highlightNav(view);
}
function renderMain() {
  const container = document.getElementById('main-content');
  if (!container) return;
  if (currentView === 'features') {
    container.innerHTML = document.getElementById('features-view-template').innerHTML;
    renderFeatures();
    renderFilterBar();
    renderStrategyEditor();
    renderPreview();

    // 🔍 검색 인풋 이벤트 등록!
    const search = document.getElementById("feature-search");
    if (search) search.oninput = renderFeatures;
    
  } else {
    const name = currentView.charAt(0).toUpperCase() + currentView.slice(1);
    container.innerHTML = `
      <div class='w-full h-full flex items-center justify-center'>
        <div class='text-3xl text-gray-500 italic font-semibold text-center'>
          🚧 ${name} is coming soon...
        </div>
      </div>`;
  }
}
function highlightNav(view) {
  currentView = view.toLowerCase(); // 현재 뷰 저장
  const buttons = document.querySelectorAll("nav button");
 
  buttons.forEach(btn => {
    const text = btn.innerText.toLowerCase();
    if (text.includes(currentView)) {
      btn.classList.add("bg-[#283040]", "text-blue-500", "font-bold");
    } else {
      btn.classList.remove("bg-[#283040]", "text-blue-500", "font-bold");
    }
  });
}
window.onload = function () {
  navigate("features");
}
</script>

<script>
function renderConditionRow(cond, index, strategy, rerenderCallback) {
  const row = document.createElement("div");
  row.className = "flex flex-wrap gap-2 items-center";

  const fieldSelect = document.createElement("select");
  fieldSelect.className = "border rounded px-2 py-1 text-sm min-w-[160px] flex-1";
  filterFields.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f.key;
    opt.textContent = f.title;
    if (cond.field === f.key) opt.selected = true;
    fieldSelect.appendChild(opt);
  });

  const opSelect = document.createElement("select");
  opSelect.className = "border rounded px-2 py-1 text-sm min-w-[80px]";
  ["=", "!=", "in", "not in"].forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    if (cond.op === op) opt.selected = true;
    opSelect.appendChild(opt);
  });

  const valueBox = document.createElement("div");
  valueBox.className = "flex-1";

  function updateValueInput(fieldKey) {
    valueBox.innerHTML = "";
    const field = filterFields.find(f => f.key === fieldKey);
    if (!field) return;
    try {
      const source = appData[field.path];
      const values = [...new Set(source.map(x => field.field ? x[field.field] : x).filter(Boolean))];
      if (values.length > 0) {
        const select = document.createElement("select");
        select.className = "w-full border rounded px-2 py-1 text-sm";
        values.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          if (String(cond.value) === String(v)) opt.selected = true;
          select.appendChild(opt);
        });
        select.addEventListener("change", () => {
          cond.value = select.value;      // ⭐ 반드시 조건값 저장!
          if (rerenderCallback) rerenderCallback();
          renderPreview();
        });
        valueBox.appendChild(select);

        // ⭐ 신규 조건 생성시 자동 첫 값 지정 (빈값이면)
        if (!cond.value && values.length > 0) {
          cond.value = values[0];
        }
      } else {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "value";
        input.value = cond.value || "";
        input.className = "w-full border rounded px-2 py-1 text-sm";
        input.addEventListener("input", () => {
          cond.value = input.value;      // ⭐ 반드시 조건값 저장!
          if (rerenderCallback) rerenderCallback();
          renderPreview();
        });
        valueBox.appendChild(input);
      }
    } catch {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "value";
      input.value = cond.value || "";
      input.className = "w-full border rounded px-2 py-1 text-sm";
      input.addEventListener("input", () => {
        cond.value = input.value;      // ⭐ 반드시 조건값 저장!
        if (rerenderCallback) rerenderCallback();
        renderPreview();
      });
      valueBox.appendChild(input);
    }
  }

  fieldSelect.addEventListener("change", () => {
  cond.field = fieldSelect.value;
  // 필드가 바뀌면 value도 해당 field의 첫 값으로 덮어씀!
  const config = filterFields.find(f => f.key === cond.field);
  const candidates = config ? getFilterValues(config) : [];
  cond.value = candidates.length > 0 ? candidates[0] : "";
  updateValueInput(cond.field);
  renderPreview();
});


  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "✖️";
  deleteBtn.className = "text-gray-400 hover:text-red-500 text-sm";
  deleteBtn.title = "Delete";
  deleteBtn.onclick = () => {
    strategy.conditions.splice(index, 1);
    rerenderCallback && rerenderCallback();
    renderPreview();
  };

  row.appendChild(fieldSelect);
  row.appendChild(opSelect);
  row.appendChild(valueBox);
  row.appendChild(deleteBtn);

  // 조건 값 인풋 생성 및 동기화
  updateValueInput(cond.field);

  return row;
}

function renderOverrideForm(schema, valueObj) {
  const overrideBox = document.createElement("div");
  overrideBox.className = "space-y-2";
  const overrideTitle = document.createElement("div");
  overrideTitle.textContent = "Override Value";
  overrideTitle.className = "font-semibold text-sm mb-1";
  overrideBox.appendChild(overrideTitle);

  for (const key in schema.properties) {
    const def = schema.properties[key];
    const fieldGroup = document.createElement("div");
    fieldGroup.className = "mb-2";
    const label = document.createElement("label");
    label.className = "block text-sm font-medium";
    label.textContent = key;
    fieldGroup.appendChild(label);

    let input;
    if (def.enum) {
      input = document.createElement("select");
      input.className = "w-full border px-2 py-1 rounded text-sm";
      def.enum.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if (valueObj[key] === opt) o.selected = true;
        input.appendChild(o);
      });
      input.onchange = (e) => {
        valueObj[key] = e.target.value;
        renderPreview();
      };
    } else if (def.type === "boolean") {
      input = document.createElement("select");
      input.className = "w-full border px-2 py-1 rounded text-sm";
      ["true", "false"].forEach(val => {
        const o = document.createElement("option");
        o.value = val;
        o.textContent = val;
        if (String(valueObj[key]) === val) o.selected = true;
        input.appendChild(o);
      });
      input.onchange = (e) => {
        valueObj[key] = (e.target.value === "true");
        renderPreview();
      };
    } else {
      input = document.createElement("input");
      input.type = "text";
      input.className = "w-full border px-2 py-1 rounded text-sm";
      input.value = valueObj[key] || "";
      input.oninput = (e) => {
        valueObj[key] = e.target.value;
        renderPreview();
      };
    }
    fieldGroup.appendChild(input);
    overrideBox.appendChild(fieldGroup);
  }
  return overrideBox;
}


function addConditionToStrategy(strategy) {
  // 기본 필드는 platform.version, value는 해당 필드의 첫 후보값
  const fieldKey = filterFields[0].key;
  const candidates = getFilterValues(filterFields[0]);
  strategy.conditions.push({
    field: fieldKey,
    op: "=",
    value: candidates.length > 0 ? candidates[0] : ""
  });
}



function renderStrategyFormUI(feature, strategy) {
  const wrapper = document.createElement("div");
  wrapper.className = "mt-3 p-3 bg-white rounded space-y-4";
  
  const divider1 = document.createElement("hr");
  if (strategy.type === "rule")
  divider1.className = "my-3 border-blue-500";
  else if (strategy.type === "experiment")
  divider1.className = "my-3 border-green-500";
  else
  divider1.className = "my-3 border-yellow-500";
  wrapper.appendChild(divider1);

  // --- Conditions
  const conditionBox = document.createElement("div");
  conditionBox.className = "space-y-2";
  const conditionTitle = document.createElement("div");
  conditionTitle.textContent = "Conditions";
  conditionTitle.className = "font-semibold text-sm mb-1";
  conditionBox.appendChild(conditionTitle);
  
  if (!strategy.conditions || strategy.conditions.length === 0) {
    addConditionToStrategy(strategy);
  }
  strategy.conditions.forEach((cond, index) => {
    if (!cond.field) cond.field = filterFields[0].key;
    const row = renderConditionRow(cond, index, strategy, () => {
      renderStrategyEditor();
      renderPreview();
    });
    conditionBox.appendChild(row);
  });
  const addConditionBtn = document.createElement("button");
  addConditionBtn.className = "text-sm text-blue-600 font-semibold hover:underline";
  addConditionBtn.textContent = "Add Condition";
  addConditionBtn.onclick = () => {
        addConditionToStrategy(strategy);
    renderStrategyEditor();
    renderPreview();
  };
  conditionBox.appendChild(addConditionBtn);
  wrapper.appendChild(conditionBox);

  const divider = document.createElement("hr");
  if (strategy.type === "rule")
  divider.className = "my-6 border-blue-500";
  else if (strategy.type === "experiment")
  divider.className = "my-6 border-green-500";
  else
  divider.className = "my-6 border-yellow-500";
  wrapper.appendChild(divider);

  // --- Override (Rule/Canary)
  if (strategy.type !== "experiment") {
  const overrideBox = renderOverrideForm(feature.schema, strategy.value);
  wrapper.appendChild(overrideBox);
}
  // --- Experiment: Variants
  if (strategy.type === "experiment") {
    const variantBox = document.createElement("div");
    variantBox.className = "space-y-2";
    const variantTitle = document.createElement("div");
    variantTitle.textContent = "Variants";
    variantTitle.className = "font-semibold text-sm mb-1";
    variantBox.appendChild(variantTitle);
    strategy.variants.forEach((variant, index) => {
      const row = document.createElement("div");
      row.className = "flex flex-wrap items-center gap-2 bg-white p-2 border rounded";
      const nameInput = document.createElement("input");
      nameInput.className = "border rounded px-2 py-1 text-sm w-20";
      nameInput.value = variant.name;
      nameInput.oninput = (e) => { variant.name = e.target.value; };
      const rolloutInput = document.createElement("input");
      rolloutInput.type = "number";
      rolloutInput.min = 0;
      rolloutInput.max = 100;
      rolloutInput.className = "border rounded px-2 py-1 text-sm w-20";
      rolloutInput.value = variant.rollout;
      rolloutInput.oninput = (e) => {
        variant.rollout = parseInt(e.target.value, 10);
      };
      
      rolloutInput.onblur = (e) => {
  variant.rollout = parseInt(e.target.value, 10);
  renderPreview(); // ⭐ 입력에서 나올 때만 프리뷰 갱신!
};
      
      
      const valueContainer = document.createElement("div");
      valueContainer.className = "flex flex-wrap gap-2";
      for (const key in feature.schema.properties) {
        const def = feature.schema.properties[key];
        const group = document.createElement("div");
        group.className = "flex flex-col";
        const label = document.createElement("label");
        label.className = "text-xs text-gray-500";
        label.textContent = key;
        let input;
        if (def.enum) {
          input = document.createElement("select");
          input.className = "border rounded px-2 py-1 text-sm";
          def.enum.forEach(opt => {
            const o = document.createElement("option");
            o.value = opt;
            o.textContent = opt;
            if (variant.value[key] === opt) o.selected = true;
            input.appendChild(o);
          });
          input.onchange = (e) => {
           variant.value[key] = e.target.value;
           renderPreview();
          };
        } else if (def.type === "boolean") {
          input = document.createElement("select");
          input.className = "border rounded px-2 py-1 text-sm";
          ["true", "false"].forEach(val => {
            const o = document.createElement("option");
            o.value = val;
            o.textContent = val;
            if (String(variant.value[key]) === val) o.selected = true;
            input.appendChild(o);
          });
          input.onchange = (e) => {
            variant.value[key] = (e.target.value === "true");
            renderPreview();
          };
        } else {
          input = document.createElement("input");
          input.type = "text";
          input.className = "border rounded px-2 py-1 text-sm";
          input.value = variant.value[key] || "";
          input.oninput = (e) => {
            variant.value[key] = e.target.value;
          };
        }
        group.appendChild(label);
        group.appendChild(input);
        valueContainer.appendChild(group);
      }
      const nameGroup = document.createElement("div");
      nameGroup.className = "flex flex-col";
      const nameLabel = document.createElement("label");
      nameLabel.className = "text-xs text-gray-500";
      nameLabel.textContent = "Variant Name";
      nameGroup.appendChild(nameLabel);
      nameGroup.appendChild(nameInput);
      const rolloutGroup = document.createElement("div");
      rolloutGroup.className = "flex flex-col";
      const rolloutLabel = document.createElement("label");
      rolloutLabel.className = "text-xs text-gray-500";
      rolloutLabel.textContent = "Rollout (%)";
      rolloutGroup.appendChild(rolloutLabel);
      rolloutGroup.appendChild(rolloutInput);

      row.appendChild(nameGroup);
      row.appendChild(rolloutGroup);
      row.appendChild(valueContainer);
      variantBox.appendChild(row);
    });
    wrapper.appendChild(variantBox);
  }
  // --- Canary: Rollout
  if (strategy.type === "canary") {
    const rolloutBox = document.createElement("div");
    rolloutBox.className = "space-y-1";
    const rolloutLabel = document.createElement("label");
    rolloutLabel.textContent = "Rollout (%)";
    rolloutLabel.className = "block text-sm font-medium";
    const rolloutInput = document.createElement("input");
    rolloutInput.type = "number";
    rolloutInput.min = 0;
    rolloutInput.max = 100;
    rolloutInput.value = strategy.rollout || 0;
    rolloutInput.className = "w-full border rounded px-2 py-1 text-sm";
    rolloutInput.oninput = (e) => {
      strategy.rollout = parseInt(e.target.value, 10);
    };
    
    
    rolloutInput.onblur = (e) => {
  strategy.rollout = parseInt(e.target.value, 10);
  renderPreview(); // ⭐ 입력에서 나올 때만 프리뷰 갱신!
};
    

    rolloutBox.appendChild(rolloutLabel);
    rolloutBox.appendChild(rolloutInput);
    wrapper.appendChild(rolloutBox);
  }
  return wrapper;
}

function showModal(title = "Notice", message = "No content provided.") {
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalMessage").textContent = message;
  document.getElementById("globalModal").classList.remove("hidden");
}
 
function closeModal() {
  document.getElementById("globalModal").classList.add("hidden");
}

// ---------------------- Feature Matrix Core ----------------------

const MATRIX_FIELDS = filterFields.map(f => ({
  key: f.key,
  label: f.title,
  values: () => getFilterValues(f)
}));

function openMatrixModal() {
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return showModal("Error", "Select a feature first.");
  document.getElementById("matrixFeatureName").textContent = feature.name;

  // 드롭다운 채우기
  const rowSel = document.getElementById("matrixRowField");
  const colSel = document.getElementById("matrixColField");
  rowSel.innerHTML = "";
  colSel.innerHTML = "";
  MATRIX_FIELDS.forEach(f => {
    rowSel.innerHTML += `<option value="${f.key}">${f.label}</option>`;
    colSel.innerHTML += `<option value="${f.key}">${f.label}</option>`;
  });
  rowSel.value = "deviceGroup.name";
  colSel.value = "country";
  rowSel.onchange = renderMatrixTable;
  colSel.onchange = renderMatrixTable;

  renderMatrixTable();
  document.getElementById("matrixModal").classList.remove("hidden");
}
function closeMatrixModal() {
  document.getElementById("matrixModal").classList.add("hidden");
  hideMatrixCellPopover();
}

function renderMatrixTable() {
  const rowKey = document.getElementById("matrixRowField").value;
  const colKey = document.getElementById("matrixColField").value;
  if (rowKey === colKey) {
    document.getElementById("matrixTable").innerHTML =
      "<div class='text-red-600 font-bold py-8'>행과 열 축은 서로 달라야 합니다.</div>";
    return;
  }
  const rowField = MATRIX_FIELDS.find(f=>f.key===rowKey);
  const colField = MATRIX_FIELDS.find(f=>f.key===colKey);
  const rows = rowField.values();
  const cols = colField.values();
  const feature = appData.features.find(f => f.id === selectedFeatureId);

  let html = `<table class="min-w-full border text-xs relative">
    <thead class="bg-gray-100"><tr>
      <th class="px-3 py-2"></th>
      ${cols.map(c=>`<th class="px-3 py-2 font-bold">${c}</th>`).join("")}
    </tr></thead>
    <tbody>
      ${rows.map((r, ri) => `
        <tr>
          <td class="px-3 py-2 font-bold bg-gray-50">${r}</td>
          ${cols.map((c, ci) => {
            let cellStrat = (feature.strategies||[]).find(strat =>
              (strat.conditions||[]).some(cond => cond.field===rowKey && cond.value==r) &&
              (strat.conditions||[]).some(cond => cond.field===colKey && cond.value==c)
            );
            let status = "Default";
            let emoji = "⚪";
            let color = "";
            if (cellStrat) {
              status = cellStrat.type.charAt(0).toUpperCase()+cellStrat.type.slice(1);
              emoji = cellStrat.type==="rule"?"🎯":cellStrat.type==="experiment"?"🧪":cellStrat.type==="canary"?"🐤":"⚪";
              color = cellStrat.type==="rule"?"bg-blue-50":
                      cellStrat.type==="experiment"?"bg-green-50":
                      cellStrat.type==="canary"?"bg-yellow-50":"";
            }
            return `<td class="px-3 py-2 text-center font-semibold cursor-pointer ${color}" 
              onclick="showMatrixCellMenu('${rowKey}','${r}','${colKey}','${c}', ${ri}, ${ci}, this)">
              <span>${emoji}</span><br><span>${status}</span>
            </td>`;
          }).join("")}
        </tr>
      `).join("")}
    </tbody>
  </table>
  <div id="matrixCellMenu" class="absolute z-50"></div>
  `;
  document.getElementById("matrixTable").innerHTML = html;
  hideMatrixCellPopover();
}

// 팝오버(전략유형 → 값입력) ------------------------------
window.showMatrixCellMenu = function(rowKey, rowVal, colKey, colVal, rowIdx, colIdx, cellElem) {
  hideMatrixCellPopover();
  const table = document.querySelector("#matrixTable table");
  const left = cellElem.offsetLeft + cellElem.offsetWidth/2 - 80;
  const top = cellElem.offsetTop + cellElem.offsetHeight;
  const popover = document.getElementById("matrixCellPopover");
  popover.style.left = left+"px";
  popover.style.top = top+"px";
  popover.innerHTML = `
    <div class="bg-white border rounded shadow-lg p-2 flex flex-col gap-1 w-48"
         onclick="event.stopPropagation()">
      <button class="text-blue-700 hover:bg-blue-50 px-2 py-1 rounded text-left" onclick="showMatrixCellValueForm('${rowKey}','${rowVal}','${colKey}','${colVal}','rule');event.stopPropagation()">🎯 Rule</button>
      <button class="text-green-700 hover:bg-green-50 px-2 py-1 rounded text-left" onclick="showMatrixCellValueForm('${rowKey}','${rowVal}','${colKey}','${colVal}','experiment');event.stopPropagation()">🧪 Experiment</button>
      <button class="text-yellow-700 hover:bg-yellow-50 px-2 py-1 rounded text-left" onclick="showMatrixCellValueForm('${rowKey}','${rowVal}','${colKey}','${colVal}','canary');event.stopPropagation()">🐤 Canary</button>
      <button class="text-gray-500 hover:bg-gray-100 px-2 py-1 rounded text-left" onclick="editMatrixCellType('${rowKey}','${rowVal}','${colKey}','${colVal}','default');event.stopPropagation()">❌ Default</button>
    </div>
  `;
  popover.classList.remove("hidden");
  // ✨ 팝오버 내부 클릭은 닫히지 않게 하고, 외부만 닫히게!
  setTimeout(() => {
    window.addEventListener("mousedown", (e) => {
      // 팝오버 영역 외부 클릭시만 닫기
      if (!popover.contains(e.target)) hideMatrixCellPopover();
    }, { once:true });
  }, 100);
};
function hideMatrixCellPopover() {
  const popover = document.getElementById("matrixCellPopover");
  if (popover) {
    popover.innerHTML = "";
    popover.classList.add("hidden");
  }
}

// 값입력폼
window.showMatrixCellValueForm = function(rowKey, rowVal, colKey, colVal, type) {
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return;
  const schema = feature.schema;
  let html = `<div class="bg-white border rounded shadow-lg p-4 w-72 space-y-2">`;
  html += `<div class="font-bold mb-2 text-base">${type.charAt(0).toUpperCase() + type.slice(1)} Settings</div>`;
  if (type === "rule" || type === "canary") {
    for (const key in schema.properties) {
      const def = schema.properties[key];
      html += `<label class="block mt-2">${key}`;
      if (def.enum) {
        html += `<select id="matxval_${key}" class="w-full border rounded px-2 py-1">` +
          def.enum.map(val=>`<option value="${val}">${val}</option>`).join("") +
          `</select>`;
      } else if (def.type === "boolean") {
        html += `<select id="matxval_${key}" class="w-full border rounded px-2 py-1">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>`;
      } else {
        html += `<input id="matxval_${key}" class="w-full border rounded px-2 py-1" value=""/>`;
      }
      html += `</label>`;
    }
    if (type === "canary") {
      html += `<label class="block mt-2">Rollout (%)<input id="matxval_rollout" type="number" min="0" max="100" value="10" class="w-full border rounded px-2 py-1"/></label>`;
    }
  }
  
  
else if (type === "experiment") {
  html += `<div class="font-bold text-sm mb-1">A Variant</div>`;
  for (const key in schema.properties) {
    const def = schema.properties[key];
    html += `<label class="block">${key}`;
    if (def.enum) {
      html += `<select id="matxval_A_${key}" class="w-full border rounded px-2 py-1">` +
        def.enum.map(val=>`<option value="${val}">${val}</option>`).join("") +
        `</select>`;
    } else if (def.type === "boolean") {
      html += `<select id="matxval_A_${key}" class="w-full border rounded px-2 py-1">
        <option value="true">true</option>
        <option value="false">false</option>
      </select>`;
    } else {
      html += `<input id="matxval_A_${key}" class="w-full border rounded px-2 py-1" value=""/>`;
    }
    html += `</label>`;
  }
  html += `<label class="block">A (%)<input id="matxval_rolloutA" type="number" min="0" max="100" value="50" class="w-full border rounded px-2 py-1"/></label>`;

  html += `<div class="font-bold text-sm mt-2 mb-1">B Variant</div>`;
  for (const key in schema.properties) {
    const def = schema.properties[key];
    html += `<label class="block">${key}`;
    if (def.enum) {
      html += `<select id="matxval_B_${key}" class="w-full border rounded px-2 py-1">` +
        def.enum.map(val=>`<option value="${val}">${val}</option>`).join("") +
        `</select>`;
    } else if (def.type === "boolean") {
      html += `<select id="matxval_B_${key}" class="w-full border rounded px-2 py-1">
        <option value="true">true</option>
        <option value="false">false</option>
      </select>`;
    } else {
      html += `<input id="matxval_B_${key}" class="w-full border rounded px-2 py-1" value=""/>`;
    }
    html += `</label>`;
  }
  html += `<label class="block">B (%)<input id="matxval_rolloutB" type="number" min="0" max="100" value="50" class="w-full border rounded px-2 py-1"/></label>`;
}
  
  
  html += `
    <div class="flex gap-2 mt-4">
      <button class="flex-1 bg-blue-700 text-white px-3 py-1 rounded" onclick="saveMatrixCellValue('${rowKey}','${rowVal}','${colKey}','${colVal}','${type}')">Save</button>
      <button class="flex-1 bg-gray-200 text-gray-700 px-3 py-1 rounded" onclick="hideMatrixCellPopover()">Cancel</button>
    </div>
  </div>`;
  const popover = document.getElementById("matrixCellPopover");
  popover.innerHTML = html;
  popover.classList.remove("hidden");
};




window.saveMatrixCellValue = function(rowKey, rowVal, colKey, colVal, type) {
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return;
  // 기존 해당 조합 전략 제거
  feature.strategies = (feature.strategies||[]).filter(strat =>
    !((strat.conditions||[]).some(cond => cond.field===rowKey && cond.value==rowVal) &&
      (strat.conditions||[]).some(cond => cond.field===colKey && cond.value==colVal)
    )
  );
  if (type === "rule" || type === "canary") {
    const value = {};
    for (const key in feature.schema.properties) {
      const el = document.getElementById(`matxval_${key}`);
      if (!el) continue;
      const def = feature.schema.properties[key];
      if (def.enum) value[key] = el.value;
      else if (def.type === "boolean") value[key] = (el.value === "true");
      else value[key] = el.value;
    }
    let rollout = 10;
    if (type === "canary") {
      const rolloutEl = document.getElementById("matxval_rollout");
      rollout = rolloutEl ? parseInt(rolloutEl.value, 10) || 10 : 10;
    }
    hideMatrixCellPopover(); // ← 이제 닫기!
    feature.strategies.push({
      id: (type[0]) + '-' + Date.now(),
      type,
      customLabel: type.charAt(0).toUpperCase() + type.slice(1),
      conditions: [
        { field: rowKey, op: "=", value: rowVal },
        { field: colKey, op: "=", value: colVal }
      ],
      value,
      ...(type === "canary" ? { rollout } : {}),
      collapsed: true
    });
  } else if (type === "experiment") {
    // ... (experiment도 값 추출 → 팝오버 닫기 → 저장 순서)
    // 동일 패턴 적용!
    const valueA = {};
    const valueB = {};
    for (const key in feature.schema.properties) {
      const def = feature.schema.properties[key];
      const elA = document.getElementById(`matxval_A_${key}`);
      const elB = document.getElementById(`matxval_B_${key}`);
      if (!elA || !elB) continue;
      if (def.enum) {
        valueA[key] = elA.value;
        valueB[key] = elB.value;
      } else if (def.type === "boolean") {
        valueA[key] = (elA.value === "true");
        valueB[key] = (elB.value === "true");
      } else {
        valueA[key] = elA.value;
        valueB[key] = elB.value;
      }
    }
    const rolloutA = parseInt(document.getElementById("matxval_rolloutA").value, 10) || 50;
    const rolloutB = parseInt(document.getElementById("matxval_rolloutB").value, 10) || 50;
    hideMatrixCellPopover(); // ← 이제 닫기!
    feature.strategies.push({
      id: 'e-' + Date.now(),
      type: "experiment",
      customLabel: "Experiment",
      conditions: [
        { field: rowKey, op: "=", value: rowVal },
        { field: colKey, op: "=", value: colVal }
      ],
      variants: [
        { name: "A", value: valueA, rollout: rolloutA },
        { name: "B", value: valueB, rollout: rolloutB }
      ],
      collapsed: true
    });
  }
  renderMatrixTable();
  renderStrategyEditor();
  renderPreview();
};




// 전략 유형 "Default" (삭제)
window.editMatrixCellType = function(rowKey, rowVal, colKey, colVal, type) {
  hideMatrixCellPopover();
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return;
  feature.strategies = (feature.strategies||[]).filter(strat =>
    !((strat.conditions||[]).some(cond => cond.field===rowKey && cond.value==rowVal) &&
      (strat.conditions||[]).some(cond => cond.field===colKey && cond.value==colVal)
    )
  );
  renderMatrixTable();
  renderStrategyEditor();
  renderPreview();
};
function onBuildCommit() {
  showModal(
    "Build & Commit",
    "The Build/Commit feature will be available soon.(This is a demo button.)"
  );
}
function onRemoteSend() {
  showModal(
    "Send to Remote",
    "The Send to Remote feature will be available soon.(This is a demo button.)"
  );
}

</script>
</body>
<!-- Footer Bar (Build/Commit + Remote Send) -->
<div id="footer-bar" class="fixed left-0 bottom-0 w-full bg-blue-950 text-white flex items-center justify-end gap-4 px-8 py-3 shadow-lg z-50"
     style="height:62px;">
  <button id="btn-build-commit"
    class="bg-blue-700 hover:bg-blue-600 text-white font-bold px-5 py-2 rounded-xl shadow mr-1 transition"
    onclick="onBuildCommit()">
    <span class="mr-2">🔨</span> Commit (Build)
  </button>
  <button id="btn-remote-send"
    class="bg-green-600 hover:bg-green-500 text-white font-bold px-5 py-2 rounded-xl shadow transition"
    onclick="onRemoteSend()">
    <span class="mr-2">🚀</span> Send to Remote
  </button>
</div>
</html>