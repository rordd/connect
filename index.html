<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>webOS Connect - Preview Íµ¨ÌòÑ Î≤ÑÏ†Ñ</title>
  <script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,700&display=swap">
<style>
input, select, textarea {
  border: 1.5px solid #999 !important;
  color: #111111 !important;
  font-weight: 500 !important;
  font-size: 15px !important;
}
select option {
  font-weight: 500 !important;
  color: #1a2238 !important;
  font-size: 15px !important;
}

input:focus, select:focus, textarea:focus {
  outline: 2px solid #2563eb;
  border-color: #2563eb;
}
label {
  font-weight: 600 !important;
  color: #333 !important;
}
body {
  font-weight: 500;
  color: #222;
}
</style>
<style>
  body, #main-content {
    font-family: 'Inter', 'Apple SD Gothic Neo', 'Noto Sans KR', 'Segoe UI', 'Roboto', Arial, sans-serif !important;
    font-size: 15px;
    letter-spacing: -0.02em;
    color: #222;
  }
  .font-bold { font-weight: 700 !important; }
  .text-xl   { font-size: 1.35rem !important; }
  .text-2xl  { font-size: 1.7rem !important; }
  .text-base { font-size: 1.05rem !important; }
  input, select, textarea, button {
    font-family: inherit !important;
    font-size: inherit !important;
  }
</style>



</head>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>




<body class="bg-gray-100 text-gray-900 font-sans h-screen flex flex-col">
<div class="flex flex-1 overflow-hidden">
    
<aside id="sidebar" class="w-55 bg-[#1a2238] text-gray-200 border-r border-gray-800 p-5 space-y-6 flex flex-col transition-all duration-300">
    
<h1 class="text-2xl font-black tracking-tight mb-13 text-red-600 drop-shadow-lg select-none">
    webOS <span>Connect</span> </h1>    

    
<nav class="flex flex-col gap-3 text-lg font-semibold">
  <button onclick="navigate('dashboard')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">üìä</span> Dashboard
  </button>
  <button onclick="navigate('features')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">üß©</span> Features
  </button>
  <button onclick="navigate('devices')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">üéõÔ∏è</span> Devices
  </button>
  <button onclick="navigate('experiments')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">üß™</span> Experiments
  </button>
  <button onclick="navigate('segments')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">üóÇÔ∏è</span> Segments
  </button>
  <button onclick="navigate('environments')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">üåê</span> Environments
  </button>
  <button onclick="navigate('admin')" class="flex items-center gap-3 px-1 py-2 rounded-lg hover:bg-[#26314f] transition">
    <span class="text-xl">‚öôÔ∏è</span> Admin
  </button>
</nav>

    <button id="sidebarToggle"
      onclick="toggleSidebar()"
      class="flex items-center gap-3 px-2 py-2 rounded-lg hover:bg-gray-800 transition text-3sm flex items-center justify-start gap-2">
      <span id="toggleIcon">‚óÄ</span><span id="toggleLabel">Collapse</span>
    </button>
  </aside>
  <main class="flex flex-1 flex-col overflow-visible">
    <div id="main-content" class="flex-1"></div>
    
<template id="devices-view-template">
  <!-- ÏÉÅÎã® ÌïÑÌÑ∞ Î∞î -->
  <div id="device-filter-bar" class="bg-gradient-to-r from-indigo-400 to-blue-200 border-b border-gray-200 shadow-sm p-1 my-2 flex flex-wrap gap-3 items-center sticky top-0 z-20">

    <div class="flex flex-wrap gap-2 items-center" id="device-filters"></div>   <!-- ‚≠êÔ∏è Ïù¥ Î∂ÄÎ∂Ñ Ï∂îÍ∞Ä! -->
  </div>
  <div class="flex flex-1 overflow-hidden divide-x divide-gray-300">
    <!-- Ï¢å: ÎîîÎ∞îÏù¥Ïä§ Î¶¨Ïä§Ìä∏ -->
    <section class="w-1/3 p-4 bg-white overflow-y-auto h-[calc(100vh-8rem)] border-r border-gray-200" id="device-list-panel"></section>
    <!-- Ï§ë: ÌîºÏ≤ò Î¶¨Ïä§Ìä∏ -->
    <section class="w-1/3 p-4 bg-white overflow-y-auto h-[calc(100vh-8rem)] border-r border-gray-200" id="device-feature-list-panel"></section>
    <!-- Ïö∞: ÌîÑÎ¶¨Î∑∞/ÌîºÏ≤ò ÏÉÅÏÑ∏ -->
    <section class="w-1/3 p-4 bg-white overflow-y-auto h-[calc(100vh-8rem)]" id="device-feature-detail-panel"></section>
  </div>
</template>
    
    
    <template id="features-view-template">
          
        <div class="bg-gradient-to-r from-red-400 from-red-300 border-b border-gray-200 shadow-sm p-1 my-2 flex flex-wrap gap-3 items-center sticky top-0 z-20" id="filter-bar">
        <div class="flex flex-wrap gap-2 items-center" id="filters">
          <div class="relative overflow-visible z-50" id="add-filter-dropdown">
            <button class="px-4 py-1.5 bg-blue-600 text-white text-base font-semibold rounded-lg shadow hover:bg-blue-700 transition" onclick="toggleFilterMenu()">More</button>
            <div class="absolute right-0 mt-1 w-48 bg-white border border-gray-400 rounded shadow-lg hidden z-50" id="filter-menu"></div>
          </div>
        </div>
      </div>
      
      
      
      <div class="flex flex-1 overflow-hidden divide-x divide-gray-300">
        <section class="w-1/3 p-6 overflow-y-auto bg-white h-[calc(108vh-12rem)]">

<div class="flex items-center justify-between mb-4">
  <h2 class="text-xl font-semibold leading-none mb-0">Feature List</h2>
  <input id="feature-search" type="text"
         placeholder="Search features..."
         class="ml-3 px-3 py-2 border border-gray-300 rounded-lg text-base bg-gray-100 focus:outline-none focus:border-blue-400"
         style="width: 170px; height: 42px;" />
</div>

          <div class="space-y-6" id="feature-list"></div>
          
        </section>
        <section class="w-1/3 p-6 overflow-y-auto bg-white h-[calc(108vh-12rem)]" id="strategy-section" >
          
          
<div class="flex items-center mb-4" style="min-height:42px;">
  <h2 class="text-xl font-semibold leading-none mb-0">Feature Strategy</h2>
</div>
          
          
          <div class="text-base text-gray-600" id="strategy-editor"></div>
        </section>
        <section class="w-1/3 p-6 overflow-y-auto bg-white h-[calc(108vh-12rem)]">
          <h2 class="text-xl font-semibold mb-4">Preview</h2>
          <div id="preview-panel"></div>
        </section>
      </div>
      <div class="bg-white border-t border-gray-400 p-4 flex justify-end gap-3">
        <button class="px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-700">Save</button>
        <button class="px-4 py-2 bg-white border border-gray-400 text-gray-800 rounded hover:bg-[#26314f]">Export</button>
      </div>
    </template>
  </main>
</div>
<!-- üåê Global Modal -->
<div id="globalModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white text-black p-6 rounded-lg shadow-lg w-80 text-center">
    <h2 id="modalTitle" class="text-xl font-bold mb-2">Notice</h2>
    <p id="modalMessage" class="mb-4">Your message goes here.</p>
    <button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded">OK</button>
  </div>
</div>

<!-- Feature Matrix Modal & ÌåùÏò§Î≤Ñ -->
<div id="matrixModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-40 z-50 hidden">
  <div class="bg-white rounded-2xl shadow-2xl w-[950px] max-w-full p-7 relative">
    <h3 class="text-xl font-bold mb-4">
      Feature Matrix ‚Äì <span id="matrixFeatureName"></span>
    </h3>
    <div class="flex gap-5 mb-4 items-center">
      <label class="font-semibold">Row:</label>
      <select id="matrixRowField" class="border px-2 py-1 rounded"></select>
      <label class="font-semibold">Column:</label>
      <select id="matrixColField" class="border px-2 py-1 rounded"></select>
    </div>
    <div id="matrixTable" class="relative"></div>
    <button onclick="closeMatrixModal()" class="absolute top-3 right-5 text-lg font-bold text-gray-400 hover:text-red-600">‚úï</button>
  </div>
</div>
<div id="matrixCellPopover" class="absolute z-50 hidden"></div>

<script>

let currentEnv = "production"; // Í∏∞Î≥∏ ÌôòÍ≤Ω

const environmentNames = ["development", "staging", "production"];

const appData = {
    
    users: [
  { id: "user01", name: "Alice",   country: "KR", age: 36, gender: "F", deviceIds: ["oled24","nano24"], lastLoginDate: "2025-06-20", watchTime: 237, mainService: "netflix" },
  { id: "user02", name: "Bob",     country: "US", age: 24, gender: "M", deviceIds: ["oled24-gaming"], lastLoginDate: "2025-06-12", watchTime: 300, mainService: "youtube" },
  { id: "user03", name: "Carol",   country: "JP", age: 29, gender: "F", deviceIds: ["nano24","oled25"], lastLoginDate: "2025-05-27", watchTime: 190, mainService: "tv" },
  { id: "user04", name: "Dan",     country: "KR", age: 42, gender: "M", deviceIds: ["oled24-starwars","oled24"], lastLoginDate: "2025-06-15", watchTime: 330, mainService: "netflix" },
  { id: "user05", name: "Erin",    country: "US", age: 33, gender: "F", deviceIds: ["qn25"], lastLoginDate: "2025-06-10", watchTime: 108, mainService: "input" },
  { id: "user06", name: "Frank",   country: "DE", age: 19, gender: "M", deviceIds: ["oled25","oled24-gaming"], lastLoginDate: "2025-06-13", watchTime: 55, mainService: "tv" },
  { id: "user07", name: "Gina",    country: "KR", age: 27, gender: "F", deviceIds: ["nano24"], lastLoginDate: "2025-06-19", watchTime: 250, mainService: "youtube" },
  { id: "user08", name: "Hank",    country: "JP", age: 31, gender: "M", deviceIds: ["oled26","oled24"], lastLoginDate: "2025-06-17", watchTime: 212, mainService: "tv" },
  { id: "user09", name: "Ivy",     country: "US", age: 40, gender: "F", deviceIds: ["oled25-senior","oled24"], lastLoginDate: "2025-06-01", watchTime: 411, mainService: "input" },
  { id: "user10", name: "John",    country: "KR", age: 38, gender: "M", deviceIds: ["oled24-starwars"], lastLoginDate: "2025-05-30", watchTime: 197, mainService: "tv" },
  { id: "user11", name: "Karen",   country: "KR", age: 26, gender: "F", deviceIds: ["qn26","nano24"], lastLoginDate: "2025-06-08", watchTime: 129, mainService: "youtube" },
  { id: "user12", name: "Leo",     country: "DE", age: 23, gender: "M", deviceIds: ["oled25","oled24","oled26"], lastLoginDate: "2025-06-11", watchTime: 301, mainService: "netflix" },
  { id: "user13", name: "Maya",    country: "VN", age: 34, gender: "F", deviceIds: ["oled25-senior"], lastLoginDate: "2025-06-19", watchTime: 74, mainService: "input" },
  { id: "user14", name: "Nick",    country: "KR", age: 21, gender: "M", deviceIds: ["oled25","oled25-senior"], lastLoginDate: "2025-06-16", watchTime: 63, mainService: "tv" },
  { id: "user15", name: "Olga",    country: "TH", age: 37, gender: "F", deviceIds: ["oled24-gaming"], lastLoginDate: "2025-06-10", watchTime: 200, mainService: "youtube" },
  { id: "user16", name: "Paul",    country: "KR", age: 45, gender: "M", deviceIds: ["oled24","oled24-starwars","nano24"], lastLoginDate: "2025-06-20", watchTime: 375, mainService: "netflix" },
  { id: "user17", name: "Quinn",   country: "KR", age: 34, gender: "M", deviceIds: ["oled26"], lastLoginDate: "2025-06-06", watchTime: 207, mainService: "tv" },
  { id: "user18", name: "Rita",    country: "US", age: 32, gender: "F", deviceIds: ["qn26","qn25"], lastLoginDate: "2025-06-13", watchTime: 91, mainService: "input" },
  { id: "user19", name: "Sam",     country: "DE", age: 30, gender: "M", deviceIds: ["oled24-gaming","oled25"], lastLoginDate: "2025-06-18", watchTime: 158, mainService: "tv" },
  { id: "user20", name: "Tina",    country: "JP", age: 27, gender: "F", deviceIds: ["nano24","oled24"], lastLoginDate: "2025-06-15", watchTime: 244, mainService: "netflix" },
  { id: "user21", name: "Uma",     country: "KR", age: 32, gender: "F", deviceIds: ["oled24-starwars"], lastLoginDate: "2025-06-11", watchTime: 182, mainService: "tv" },
  { id: "user22", name: "Vince",   country: "US", age: 28, gender: "M", deviceIds: ["oled26","qn25","oled25-senior"], lastLoginDate: "2025-06-07", watchTime: 112, mainService: "youtube" },
  { id: "user23", name: "Will",    country: "KR", age: 29, gender: "M", deviceIds: ["oled25","nano24"], lastLoginDate: "2025-06-09", watchTime: 191, mainService: "netflix" },
  { id: "user24", name: "Xena",    country: "KR", age: 41, gender: "F", deviceIds: ["oled24-gaming"], lastLoginDate: "2025-06-14", watchTime: 119, mainService: "tv" },
  { id: "user25", name: "Yuri",    country: "VN", age: 25, gender: "F", deviceIds: ["oled24","oled25","qn26"], lastLoginDate: "2025-06-19", watchTime: 86, mainService: "netflix" },
  { id: "user26", name: "Zane",    country: "TH", age: 31, gender: "M", deviceIds: ["oled24-starwars","oled25-senior"], lastLoginDate: "2025-06-12", watchTime: 277, mainService: "input" },
  { id: "user27", name: "Amy",     country: "US", age: 24, gender: "F", deviceIds: ["nano24","oled24"], lastLoginDate: "2025-06-13", watchTime: 73, mainService: "tv" },
  { id: "user28", name: "Bill",    country: "KR", age: 39, gender: "M", deviceIds: ["qn25"], lastLoginDate: "2025-06-14", watchTime: 201, mainService: "youtube" },
  { id: "user29", name: "Clara",   country: "KR", age: 27, gender: "F", deviceIds: ["oled25","oled24"], lastLoginDate: "2025-06-19", watchTime: 177, mainService: "netflix" },
  { id: "user30", name: "Dylan",   country: "US", age: 36, gender: "M", deviceIds: ["oled26","nano24"], lastLoginDate: "2025-06-12", watchTime: 322, mainService: "tv" },
  { id: "user31", name: "Ella",    country: "KR", age: 29, gender: "F", deviceIds: ["oled25","oled25-senior"], lastLoginDate: "2025-06-17", watchTime: 90, mainService: "tv" },
  { id: "user32", name: "Felix",   country: "JP", age: 31, gender: "M", deviceIds: ["oled24","qn26"], lastLoginDate: "2025-06-09", watchTime: 135, mainService: "input" },
  { id: "user33", name: "Grace",   country: "KR", age: 33, gender: "F", deviceIds: ["oled24-gaming","nano24"], lastLoginDate: "2025-06-15", watchTime: 207, mainService: "youtube" },
  { id: "user34", name: "Harry",   country: "DE", age: 41, gender: "M", deviceIds: ["oled24-starwars"], lastLoginDate: "2025-06-16", watchTime: 151, mainService: "tv" },
  { id: "user35", name: "Irene",   country: "KR", age: 28, gender: "F", deviceIds: ["oled24","oled26","oled25"], lastLoginDate: "2025-06-12", watchTime: 364, mainService: "netflix" },
  { id: "user36", name: "Jack",    country: "KR", age: 36, gender: "M", deviceIds: ["qn26"], lastLoginDate: "2025-06-15", watchTime: 239, mainService: "tv" },
  { id: "user37", name: "Kate",    country: "VN", age: 23, gender: "F", deviceIds: ["oled25","oled24-gaming"], lastLoginDate: "2025-06-18", watchTime: 102, mainService: "netflix" },
  { id: "user38", name: "Liam",    country: "KR", age: 35, gender: "M", deviceIds: ["oled24","nano24"], lastLoginDate: "2025-06-20", watchTime: 221, mainService: "youtube" },
  { id: "user39", name: "Mia",     country: "TH", age: 30, gender: "F", deviceIds: ["oled26"], lastLoginDate: "2025-06-08", watchTime: 116, mainService: "tv" },
  { id: "user40", name: "Noah",    country: "KR", age: 41, gender: "M", deviceIds: ["oled25-senior","nano24"], lastLoginDate: "2025-06-14", watchTime: 259, mainService: "input" },
  { id: "user41", name: "Oliver",  country: "US", age: 27, gender: "M", deviceIds: ["oled25"], lastLoginDate: "2025-03-17", watchTime: 189, mainService: "netflix" },
  { id: "user42", name: "Penny",   country: "KR", age: 34, gender: "F", deviceIds: ["oled24","oled26"], lastLoginDate: "2025-02-12", watchTime: 225, mainService: "tv" },
  { id: "user43", name: "Quincy",  country: "KR", age: 24, gender: "M", deviceIds: ["nano24"], lastLoginDate: "2025-06-09", watchTime: 132, mainService: "youtube" },
  { id: "user44", name: "Rose",    country: "VN", age: 39, gender: "F", deviceIds: ["oled24-starwars","oled25"], lastLoginDate: "2025-06-16", watchTime: 161, mainService: "tv" },
  { id: "user45", name: "Steve",   country: "KR", age: 25, gender: "M", deviceIds: ["qn25","oled24"], lastLoginDate: "2025-01-11", watchTime: 185, mainService: "netflix" },
  { id: "user46", name: "Toby",    country: "KR", age: 38, gender: "M", deviceIds: ["oled25"], lastLoginDate: "2025-06-18", watchTime: 118, mainService: "input" },
  { id: "user47", name: "Uma2",    country: "DE", age: 37, gender: "F", deviceIds: ["oled26","nano24"], lastLoginDate: "2025-06-10", watchTime: 271, mainService: "youtube" },
  { id: "user48", name: "Victor",  country: "KR", age: 29, gender: "M", deviceIds: ["oled24","oled25"], lastLoginDate: "2025-02-15", watchTime: 146, mainService: "tv" },
  { id: "user49", name: "Wendy",   country: "JP", age: 28, gender: "F", deviceIds: ["oled24-gaming"], lastLoginDate: "2025-05-20", watchTime: 182, mainService: "netflix" },
  { id: "user50", name: "Yuna",    country: "KR", age: 35, gender: "F", deviceIds: ["oled25","nano24"], lastLoginDate: "2025-05-19", watchTime: 153, mainService: "tv" }
],
segments: [
    
{
    id: "netflix_poweruser",
    name: "Netflix Power Users",
    description: "ÎÑ∑ÌîåÎ¶≠Ïä§Î•º Ï£ºÎ°ú ÏÇ¨Ïö©ÌïòÎäî ÌïúÎã¨ ÎàÑÏ†Å ÏãúÏ≤≠ 200ÏãúÍ∞Ñ Ïù¥ÏÉÅ Ïú†Ï†Ä",
    conditions: [
      { field: "user.mainService", op: "=", value: "netflix" },
      { field: "user.watchTime", op: ">", value: 200 }
    ]
  },
  
  {
    id: "power_input_user",
    name: "Input Power Users",
    description: "ÏûÖÎ†•Î™®Îìú Ï£ºÎ°ú ÏÇ¨Ïö©ÌïòÎäî ÌïúÎã¨ ÎàÑÏ†Å ÏãúÏ≤≠ 200ÏãúÍ∞Ñ Ïù¥ÏÉÅ Ïú†Ï†Ä",
    conditions: [
      { field: "user.mainService", op: "=", value: "input" },
      { field: "user.watchTime", op: ">", value: 200 }
    ]
  },
  {
    id: "power_tv_user",
    name: "Live TV Power Users",
    description: "Ï£º ÏÇ¨Ïö© Í∏∞Îä•Ïù¥ TVÏù¥Î©∞ ÌïúÎã¨ ÎàÑÏ†Å ÏãúÏ≤≠ 200ÏãúÍ∞Ñ Ïù¥ÏÉÅ Ïú†Ï†Ä",
    conditions: [
      { field: "user.mainService", op: "=", value: "tv" },
      { field: "user.watchTime", op: ">", value: 200 }
    ]
  },
    


  {
    id: "inactive_recent",
    name: "Inactive Recent",
    description: "ÏµúÍ∑º 30ÏùºÍ∞Ñ Î°úÍ∑∏Ïù∏ÌïòÏßÄ ÏïäÏùÄ Ïú†Ï†Ä",
    conditions: [
      { field: "user.lastLoginDate", op: "<", value: "2025-05-20" }
    ]
  },

  {
    id: "oled26_users",
    name: "OLED26 Model Users",
    description: "2026ÎÖÑÌòï OLED Î™®Îç∏ÏùÑ ÏÇ¨Ïö©ÌïòÎäî Ïú†Ï†Ä",
    conditions: [
      { field: "user.deviceIds", op: "in", value: ["oled26"] }
    ]
  },
],
    
    metrics: [
  // User/Behavior
  {
    key: "app_launch_count",
    displayName: "App Launch Count",
    description: "Ïï±Ïù¥ Ïã§ÌñâÎêú Ï¥ù ÌöüÏàò",
    unit: "times",
    type: "counter",
    category: "usage"
  },
  {
    key: "unique_users",
    displayName: "Unique Users",
    description: "Ï§ëÎ≥µ ÏóÜÎäî Ïùº/Ï£º/Ïõî ÏÇ¨Ïö©Ïûê Ïàò",
    unit: "users",
    type: "user",
    category: "usage"
  },
  {
    key: "retention_d1",
    displayName: "1-day Retention Rate",
    description: "ÏÑ§Ïπò ÌõÑ 1Ïùº ÎÇ¥ Ïû¨Ïã§Ìñâ ÎπÑÏú®",
    unit: "%",
    type: "retention",
    category: "usage"
  },
  {
    key: "retention_d7",
    displayName: "7-day Retention Rate",
    description: "ÏÑ§Ïπò ÌõÑ 7Ïùº ÎÇ¥ Ïû¨Ïã§Ìñâ ÎπÑÏú®",
    unit: "%",
    type: "retention",
    category: "usage"
  },

  // Ad/Revenue
  {
    key: "ad_impressions",
    displayName: "Ad Impressions",
    description: "Í¥ëÍ≥†Í∞Ä ÎÖ∏Ï∂úÎêú Ï¥ù ÌöüÏàò",
    unit: "times",
    type: "counter",
    category: "ad"
  },
  {
    key: "ad_clicks",
    displayName: "Ad Clicks",
    description: "Í¥ëÍ≥† ÏòÅÏó≠ ÌÅ¥Î¶≠ Ï¥ù ÌöüÏàò",
    unit: "times",
    type: "counter",
    category: "ad"
  },
  {
    key: "ad_ctr",
    displayName: "Ad Click-Through Rate",
    description: "Í¥ëÍ≥† ÌÅ¥Î¶≠Ïàò / ÎÖ∏Ï∂úÏàò ÎπÑÏú®",
    unit: "%",
    type: "ratio",
    category: "ad"
  },
  {
    key: "ad_skip_rate",
    displayName: "Ad Skip Rate",
    description: "Í¥ëÍ≥† Ïä§ÌÇµ Ïù¥Î≤§Ìä∏ ÎπÑÏú®",
    unit: "%",
    type: "ratio",
    category: "ad"
  },

  // Content/Feature
  {
    key: "watch_time",
    displayName: "Watch Time",
    description: "Ï¥ù ÏòÅÏÉÅ ÏãúÏ≤≠ ÏãúÍ∞Ñ(Î∂Ñ)",
    unit: "minutes",
    type: "duration",
    category: "content"
  },
  {
    key: "play_count",
    displayName: "Play Count",
    description: "Ï†ÑÏ≤¥ ÏòÅÏÉÅ Ïû¨ÏÉùÎêú ÌöüÏàò",
    unit: "times",
    type: "counter",
    category: "content"
  },
  {
    key: "completion_rate",
    displayName: "Completion Rate",
    description: "ÏΩòÌÖêÏ∏†Ïùò ÎÅùÍπåÏßÄ ÏãúÏ≤≠Ìïú ÎπÑÏú®",
    unit: "%",
    type: "ratio",
    category: "content"
  },
  {
    key: "feature_on_rate",
    displayName: "Feature Usage Rate",
    description: "Ï†ÑÏ≤¥ Ï§ë Ìï¥Îãπ Í∏∞Îä• ÏÇ¨Ïö© ÎπÑÏú®",
    unit: "%",
    type: "ratio",
    category: "feature"
  },
  {
    key: "settings_change_count",
    displayName: "Settings Change Count",
    description: "ÏÇ¨Ïö©ÏûêÍ∞Ä ÌôòÍ≤ΩÏÑ§Ï†ï(ÏÑ§Ï†ïÍ∞í) Î≥ÄÍ≤ΩÌïú ÌöüÏàò",
    unit: "times",
    type: "counter",
    category: "feature"
  },

  // Funnel/Purchase/User
  {
    key: "conversion_rate",
    displayName: "Conversion Rate",
    description: "Íµ¨Îß§¬∑ÏÑ§Ïπò¬∑ÌÅ¥Î¶≠ Îì± Ï†ÑÌôò ÎπÑÏú®",
    unit: "%",
    type: "ratio",
    category: "funnel"
  },
  {
    key: "purchase_count",
    displayName: "Purchase Count",
    description: "ÏÉÅÌíà/ÏÑúÎπÑÏä§ Í≤∞Ï†ú(Íµ¨Îß§) Ï¥ù ÌöüÏàò",
    unit: "times",
    type: "counter",
    category: "funnel"
  },
  {
    key: "signups",
    displayName: "Sign-ups",
    description: "ÏÉàÎ°ú Í∞ÄÏûÖÌïú ÌöåÏõê Ïàò",
    unit: "users",
    type: "counter",
    category: "funnel"
  },

  // System/Quality/Defect
  {
    key: "crash_count",
    displayName: "Crash Count",
    description: "Ïï±Ïù¥ ÎπÑÏ†ïÏÉÅ Ï¢ÖÎ£å(ÌÅ¨ÎûòÏãú)Îêú ÌöüÏàò",
    unit: "cases",
    type: "counter",
    category: "defect"
  },
  {
    key: "error_rate",
    displayName: "Error Rate",
    description: "Ï†ÑÏ≤¥ ÏöîÏ≤≠ Ï§ë ÏóêÎü¨ ÏùëÎãµ ÎπÑÏú®",
    unit: "%",
    type: "ratio",
    category: "defect"
  },
  {
    key: "latency_avg",
    displayName: "Average Latency",
    description: "ÌèâÍ∑† ÎÑ§Ìä∏ÏõåÌÅ¨/ÏÑúÎπÑÏä§ ÏùëÎãµ ÏãúÍ∞Ñ(ms)",
    unit: "ms",
    type: "duration",
    category: "system"
  },

  // Device/IoT/Environment
  {
    key: "voice_command_count",
    displayName: "Voice Command Count",
    description: "ÏùåÏÑ±Î™ÖÎ†π Ïù∏Ïãù¬∑Ïã§Ìñâ Í±¥Ïàò",
    unit: "times",
    type: "counter",
    category: "device"
  },
  {
    key: "device_pairing_count",
    displayName: "Device Pairing Count",
    description: "Ïó∞ÎèôÎêú Ïä§ÎßàÌä∏ Í∏∞Í∏∞/ÏïÖÏÑ∏ÏÑúÎ¶¨ ÌéòÏñ¥ÎßÅ ÌöüÏàò",
    unit: "times",
    type: "counter",
    category: "device"
  }
  // ÌïÑÏöîÏãú Í≥ÑÏÜç ÌôïÏû• Í∞ÄÎä•!
],
  features: [
    // 1. ÌôàÎü∞Ï≤ò
    {
      id: "homeLauncher",
      name: "Home Launcher",
      defaultValue: { enabled: true, homeType: "full-home" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          homeType: {
            type: "string",
            enum: ["full-home", "smart-screen", "ad-optimized"]
          }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 2. ÏùåÏÑ±Ïù∏Ïãù
    {
      id: "voice",
      name: "Voice",
      defaultValue: { enabled: false, mode: "basic" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          mode: { type: "string", enum: ["basic", "advanced"] }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 3. Î∞©ÏÜ°
    {
      id: "broadcast",
      name: "Broadcast",
      defaultValue: { enabled: true,channel: "DVB", regionLock: true },
      schema: {
        type: "object",
        properties: {
            enabled: { type: "boolean" },
          channel: { type: "string", enum: ["DVB", "ATSC", "ISDB"] },
          regionLock: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 4. ÎÑ§Ìä∏ÏõåÌÅ¨
    {
      id: "network",
      name: "Network",
      defaultValue: { enabled: true, ethernet: true, wifi: true, wifiBand: "5GHz" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          ethernet: { type: "boolean" },
          wifi: { type: "boolean" },
          wifiBand: { type: "string", enum: ["2.4GHz", "5GHz"] }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 5. Ïï±Ïä§ÌÜ†Ïñ¥ (Tizen, Android TV)
    {
      id: "appStore",
      name: "App Store",
      defaultValue: { enabled: true, autoUpdate: false },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          autoUpdate: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 6. ÎØ∏ÎîîÏñ¥ ÌîåÎ†àÏù¥Ïñ¥ (Media Playback)
    {
      id: "mediaPlayer",
      name: "Media Player",
      defaultValue: { enabled: true, codec: "universal" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          codec: { type: "string", enum: ["universal", "h264", "vp9", "av1"] }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 7. ÌôîÎ©¥ ÎØ∏Îü¨ÎßÅ (Cast/Miracast/AirPlay)
    {
      id: "screenMirroring",
      name: "Screen Mirroring",
      defaultValue: { enabled: true, type: "miracast" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          type: { type: "string", enum: ["miracast", "airplay", "chromecast"] }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 8. HDMI CEC
    {
      id: "hdmiCec",
      name: "HDMI CEC",
      defaultValue: { enabled: true, autoSwitch: true },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          autoSwitch: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 9. ÏùåÏû•/ÏÇ¨Ïö¥Îìú ÏÑ§Ï†ï (Sound Mode)
    {
      id: "soundMode",
      name: "Sound Mode",
      defaultValue: { enabled: true, mode: "standard" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          mode: { type: "string", enum: ["standard", "cinema", "sports", "game", "music"] }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 10. Î∏îÎ£®Ìà¨Ïä§
    {
      id: "bluetooth",
      name: "Bluetooth",
      defaultValue: { enabled: true, multiPair: false },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          multiPair: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "build"
    },
    // 11. ÏùåÎüâ Î†àÎ≤®Îü¨ (Volume Leveler)
    {
      id: "volumeLeveler",
      name: "Volume Leveler",
      defaultValue: { enabled: false },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 12. Í¥ëÍ≥† (Ad)
    {
      id: "ads",
      name: "Ads",
      defaultValue: { enabled: true, adType: "standard" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          adType: { type: "string", enum: ["standard", "interactive", "none"] }
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 13. ÌÇ§Ï¶àÎ™®Îìú (Kids Mode)
    {
      id: "kidsMode",
      name: "Kids Mode",
      defaultValue: { enabled: false, timeLimit: 60 },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          timeLimit: { type: "number" } // Î∂Ñ Îã®ÏúÑ
        }
      },
      strategies: [],
      applyMode: "remote"
    },
    // 14. Ï†àÏ†ÑÎ™®Îìú (Energy Saving)
    {
      id: "energySaving",
      name: "Energy Saving",
      defaultValue: { enabled: false, level: "normal" },
      schema: {
        type: "object",
        properties: {
          enabled: { type: "boolean" },
          level: { type: "string", enum: ["off", "normal", "max"] }
        }
      },
      strategies: [],
      applyMode: "both"
    },
    // 15. Îã§Íµ≠Ïñ¥ (Locale)
    {
      id: "locale",
      name: "Locale",
      defaultValue: { language: "en", country: "US" },
      schema: {
        type: "object",
        properties: {
          language: { type: "string", enum: ["en", "ko", "zh", "vi", "th"] },
          country: { type: "string", enum: ["US", "KR", "CN", "VN", "TH"] }
        }
      },
      strategies: [],
      applyMode: "build"
    }
    // ... ÌïÑÏöî Ïãú Ï∂îÍ∞Ä Í∞ÄÎä•
  ],

platformSchema : {
  type: "object",
  properties: {
    id: { type: "string", title: "ID" },
    name: { type: "string", title: "Platform Name" },
    version: { type: "string", title: "Version" },
    // ...ÌïÑÏöîÌïú ÌïÑÎìú Í≥ÑÏÜç Ï∂îÍ∞Ä
  }
},



deviceGroupSchema : {
  type: "object",
  properties: {
    id: { type: "string", title: "Group ID" },
    name: { type: "string", title: "Group Name" },
    machine: { type: "string", title: "Machine Type", enum: ["O22", "k8lp", "k8hp"], enumNames: ["OLED", "NanoCell", "QNED"] },
    manufactureYear: { type: "string", title: "Year" },
    // ...
  }
},


deviceSchema : {
  type: "object",
  properties: {
    id: { type: "string", title: "Device ID" },
    name: { type: "string", title: "Device Name" },
    memory: { type: "number", title: "Memory (GB)" },
    tier: { type: "string", title: "Tier", enum: ["standard", "premium", "deluxe"], enumNames: ["Standard", "Premium", "Deluxe"] },
    edition: { type: "string", title: "Edition", enum: ["basic", "gaming", "limited"], enumNames: ["Basic", "Gaming", "Limited"] },
    // ...Í≥ÑÏÜç ÌôïÏû•
  }
},


  platforms: [

    { id: "26", version: "webOS 26", deviceGroups: ["O22-2024", "k8lp-2024", "O24-2025", "K24-2025", "O26-2026", "K26-2026"] },
    
    { id: "25", version: "webOS 25", deviceGroups: ["O22-2024", "k8lp-2024", "O24-2025", "K24-2025"] }
  ],
  deviceGroups: [
    { id: "O22-2024", name: "2024 OLED", machine: "O22", manufactureYear: "2024", devices: ["oled24", "oled24-gaming", "oled24-starwars"] },
    { id: "k8lp-2024", name: "2024 Nano", machine: "k8lp", manufactureYear: "2024", devices: ["nano24"] },
    { id: "O24-2025", name: "2025 OLED", machine: "O24", manufactureYear: "2025", devices: ["oled25", "oled25-senior"] },
    { id: "K24-2025", name: "2025 QNED", machine: "K24", manufactureYear: "2025", devices: ["qn25"] },
    { id: "O26-2026", name: "2026 OLED", machine: "O26", manufactureYear: "2026", devices: ["oled26"] },
    { id: "K26-2026", name: "2026 QNED", machine: "K26", manufactureYear: "2026", devices: ["qn26"] }
  ],
  devices: [
    { id: "oled24", name: "24 OLED", memory: "2.5", tier: "premium", edition: "standard" },
    { id: "nano24", name: "24 Nano", memory: "1.5", tier: "basic", edition: "standard" },
    { id: "oled24-gaming", name: "24 OLED Gaming", memory: "2.5", tier: "premium", edition: "gaming" },
    { id: "oled24-starwars", name: "24 OLED StarWars", memory: "2.5", tier: "premium", edition: "starwars" },
    { id: "oled25-senior", name: "25 OLED Senior", memory: "2.5", tier: "standard", edition: "senior" },
    { id: "oled25", name: "25 OLED", memory: "2.5", tier: "premium", edition: "standard" },
    { id: "qn25", name: "25 QNED", memory: "2.0", tier: "standard", edition: "standard" },
    { id: "oled26", name: "26 OLED", memory: "2.5", tier: "premium", edition: "standard" },
    { id: "qn26", name: "26 QNED", memory: "2.0", tier: "standard", edition: "standard" }
  ],
  countryData: ["KR", "US", "VN", "TH"]
};

const filterFields = [
  { key: "platform.version", title: "Platform", path: "platforms", field: "version" },
  { key: "deviceGroup.name", title: "Device Group", path: "deviceGroups", field: "name" },
  { key: "device.name", title: "Device", path: "devices", field: "name" },
  { key: "country", title: "Country", path: "countryData" },
  { key: "segment", title: "Segment", path: "segments", field: "name" },
  { key: "deviceGroup.manufactureYear", title: "Manufacture Year", path: "deviceGroups", field: "manufactureYear" },
  { key: "deviceGroup.machine", title: "Machine", path: "deviceGroups", field: "machine" },
  { key: "device.memory", title: "Memory", path: "devices", field: "memory" },
  { key: "device.tier", title: "Tier", path: "devices", field: "tier" },
  { key: "device.edition", title: "Edition", path: "devices", field: "edition" }
];

let currentFilters = {
  "platform.version": undefined,
  "deviceGroup.name": undefined,
  "device.name": undefined,
  "country": undefined,
  "segment" : undefined
};
let selectedFeatureId = null;
let defaultSettingsOpen = true;

let selectedDeviceId = null;
let selectedDeviceFeatureId = null; // Ï§ëÏïôÏóêÏÑú ÏÑ†ÌÉùÌïú ÌîºÏ≤ò id
let deviceFilters = {}; // ÏÉÅÎã® Í∏ÄÎ°úÎ≤å ÌïÑÌÑ∞ ÏÉÅÌÉú


function getFilterValues(config) {
  const dataSource = appData[config.path];
  const field = config.field;
  if (!field) return dataSource;
  const set = new Set(dataSource.map(d => d[field]).filter(Boolean));
  return [...set];
}

function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const icon = document.getElementById("toggleIcon");
  const label = document.getElementById("toggleLabel");
  const isCollapsed = sidebar.classList.toggle("w-16");
  sidebar.classList.toggle("w-55");
  sidebar.classList.toggle("overflow-hidden");
  if (isCollapsed) {
    icon.textContent = "‚ñ∂";
    label.textContent = "";
  } else {
    icon.textContent = "‚óÄ";
    label.textContent = "Collapse";
  }
}
</script>


<script>
function toggleFeature(id, newValue) {
  const feature = appData.features.find(f => f.id === id);
  if (feature && 'enabled' in feature.defaultValue) {
    feature.defaultValue.enabled = newValue;
    renderFeatures();
    renderPreview();
  }
}

function renderFeatures() {
  const container = document.getElementById("feature-list");
  if (!container) return;
  container.innerHTML = "";

  // ÌïÑÌÑ∞/Í≤ÄÏÉâ Ï†ÅÏö©Îêú Î¶¨Ïä§Ìä∏
  const q = (document.getElementById("feature-search")?.value || "").trim().toLowerCase();
  const features = !q
    ? appData.features
    : appData.features.filter(f =>
        f.name.toLowerCase().includes(q) ||
        f.id.toLowerCase().includes(q)
      );

  features.forEach((f, idx) => {
    const card = document.createElement("div");
    let baseClass = `
      bg-white rounded-2xl
      p-6 mb-6
      border-2 border-gray-400
      shadow-lg
      hover:shadow-2xl
      transition
      cursor-pointer
    `.replace(/\s+/g, ' ');

    if (f.id === selectedFeatureId) {
      baseClass += " border-blue-500 ring-2 ring-blue-300";
    } else {
      baseClass += " border-gray-400 shadow-[0_2px_6px_rgba(0,0,0,0.12)]";
    }
    card.className = baseClass;

    // ---- ÎìúÎûòÍ∑∏Ïï§ÎìúÎûç ÌïµÏã¨ (id Í∏∞Î∞ò) ----
    card.setAttribute('draggable', true);

    card.ondragstart = (e) => {
      e.dataTransfer.setData("featureId", f.id); // idxÍ∞Ä ÏïÑÎãàÎùº idÎßå ÏÇ¨Ïö©!
      card.style.opacity = 0.6;
    };
    card.ondragend = (e) => {
      card.style.opacity = "";
      document.querySelectorAll(".feature-dropzone").forEach(el => el.classList.remove("ring-4", "ring-blue-400"));
    };
    card.ondragover = (e) => {
      e.preventDefault();
      card.classList.add("feature-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondragleave = (e) => {
      card.classList.remove("feature-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondrop = (e) => {
      e.preventDefault();
      card.classList.remove("feature-dropzone", "ring-4", "ring-blue-400");
      const fromId = e.dataTransfer.getData("featureId");
      const toId = f.id;
      if (fromId === toId) return;

      // Ìï≠ÏÉÅ ÏõêÎ≥∏ Î∞∞Ïó¥ÏóêÏÑú Ïù¥Îèô!
      const fromIdx = appData.features.findIndex(ff => ff.id === fromId);
      const toIdx = appData.features.findIndex(ff => ff.id === toId);
      if (fromIdx === -1 || toIdx === -1) return;
      // Ïã§Ï†ú Ïù¥Îèô
      const [moved] = appData.features.splice(fromIdx, 1);
      appData.features.splice(toIdx, 0, moved);
      renderFeatures();
    };

    // ÏÑ†ÌÉù Ïù¥Î≤§Ìä∏ (ÌÅ¥Î¶≠)
    card.addEventListener("click", () => {
      selectedFeatureId = f.id;
      renderFeatures();
      renderStrategyEditor();
      renderPreview();
    });

    // Í∏∞Ï°¥ Ïπ¥Îìú ÎÇ¥Ïö©(ÏÉùÎûµ ÏóÜÏù¥)
    const tagKeys = Object.keys(f.defaultValue);
    let tagHTML = tagKeys.slice(0, 2).map(k => {
      const value = f.defaultValue[k];
      let color = "bg-blue-100 text-blue-800";
      if (typeof value === "boolean") {
        color = value
          ? "bg-green-100 text-green-800"
          : "bg-red-100 text-red-800";
      }
      return `<span class='inline-block ${color} px-2 py-0.5 rounded-full text-xs'>${k}: ${value}</span>`;
    }).join(" ");

    if (tagKeys.length > 2) {
      tagHTML += ` <span class='text-xs text-gray-500'>+${tagKeys.length - 2} more...</span>`;
    }

    let toggle = "";
    if ("enabled" in f.defaultValue) {
      toggle = `
        <label class='relative inline-flex items-center cursor-pointer'>
          <input type='checkbox' class='sr-only peer'
                 ${f.defaultValue.enabled ? "checked" : ""}
                 onchange="event.stopPropagation(); toggleFeature('${f.id}', this.checked)" />
          <div class='w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 transition-colors'></div>
          <div class='absolute left-[2px] top-[2px] bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-full'></div>
        </label>`;
    }

    card.innerHTML = `
      <div class='flex justify-between items-center'>
        <h3 class='text-lg font-semibold'>${f.name}</h3>
        ${toggle}
      </div>
      <p class='text-base text-gray-500 mt-1'>Default Values</p>
      <div class='mt-3 text-base text-gray-600 space-x-1'>${tagHTML}</div>
    `;

    container.appendChild(card);
  });
}

function renderFilterBar() {
  const filtersDiv = document.getElementById("filters");
  const dropdown = document.getElementById("add-filter-dropdown");
  filtersDiv.innerHTML = "";

  for (const key in currentFilters) {
    const config = filterFields.find(f => f.key === key);
    if (!config) continue;

    const wrapper = document.createElement("div");
    wrapper.className = "flex items-center gap-2 bg-transparent px-2 py-1 rounded";

    const label = document.createElement("label");
    label.textContent = config.title;
    label.className = "font-semibold text-base text-gray-700";
    wrapper.appendChild(label);

    const select = document.createElement("select");
    select.className = "border rounded-lg px-2 py-1 font-bold text-base bg-blue-50 shadow focus:ring-2 focus:ring-blue-400";;
    select.onchange = (e) => {
      currentFilters[key] = e.target.value === "All" ? undefined : e.target.value;
      renderPreview();
    };

    const values = getFilterValues(config);
    [undefined, ...values].forEach(v => {
      const opt = document.createElement("option");
      opt.value = v || "All";
      opt.text = v || "All";
      if (currentFilters[key] === v || (v === undefined && currentFilters[key] === undefined)) {
        opt.selected = true;
      }
      select.appendChild(opt);
    });

    wrapper.appendChild(select);

    if (!["platform.version", "deviceGroup.name", "device.name", "country"].includes(key)) {
      const del = document.createElement("button");
      del.textContent = "‚úï";
      del.className = "ml-1 text-2xs font-semibold text-black hover:text-red-700";
      del.onclick = () => {
        delete currentFilters[key];
        renderFilterBar();
        renderPreview();
      };
      wrapper.appendChild(del);
    }

    filtersDiv.appendChild(wrapper);
  }

  if (dropdown) filtersDiv.appendChild(dropdown);
}

function toggleFilterMenu() {
  const menu = document.getElementById("filter-menu");
  menu.classList.toggle("hidden");
  renderFilterMenu();
}

function renderFilterMenu() {
  const menu = document.getElementById("filter-menu");
  menu.innerHTML = "";
  const unused = filterFields.filter(f => !(f.key in currentFilters));
  unused.forEach(f => {
    const btn = document.createElement("button");
    btn.textContent = f.title;
    btn.className = "w-full text-left px-4 py-2 text-base text-gray-800 hover:bg-[#26314f]";
    btn.onclick = () => {
      currentFilters[f.key] = undefined;
      menu.classList.add("hidden");
      renderFilterBar();
      renderPreview();
    };
    menu.appendChild(btn);
  });
}

// ------ Ï†ÑÎûµ ÌèâÍ∞Ä/ÌîÑÎ¶¨Î∑∞ Î†åÎçî ------
function evaluateStrategyForPreview(feature, filters) {
  if (!feature || !feature.strategies) return { type: "default", value: feature.defaultValue };

  for (let strat of feature.strategies) {
    if (!strat.conditions || strat.conditions.length === 0) continue;
    let match = strat.conditions.every(cond => {
      let filterValue = filters[cond.field];
      // path ÎØ∏ÏßÄÏõêÏãú Í≥ÑÏ∏µÏ†ÅÏúºÎ°úÎèÑ ÌÉêÏÉâ (Ïòà: "device.name" ‚Üí filters.device?.name)
      if (filterValue === undefined && cond.field.includes(".")) {
        const parts = cond.field.split(".");
        let val = filters;
        for (const p of parts) {
          if (val && typeof val === "object") val = val[p];
          else { val = undefined; break; }
        }
        filterValue = val;
      }
      if (filterValue === undefined) return false;
      if (cond.op === "=") return String(filterValue) === String(cond.value);
      if (cond.op === "!=") return String(filterValue) !== String(cond.value);
      if (cond.op === "in") return Array.isArray(cond.value) ? cond.value.includes(filterValue) : false;
      if (cond.op === "not in") return Array.isArray(cond.value) ? !cond.value.includes(filterValue) : false;
      return false;
    });
    if (match) {
      if (strat.type === "experiment") return { type: "experiment", strat };
      if (strat.type === "canary") return { type: "canary", strat };
      return { type: "rule", strat };
    }
  }
  return { type: "default", value: feature.defaultValue };
}



function renderPrettyObject(obj) {
  if (!obj || typeof obj !== 'object') return '';
  return `
    <table class="min-w-[180px] bg-white border border-gray-300 rounded shadow-sm text-base mb-2">
      <tbody>
      ${Object.entries(obj).map(([k, v]) => `
        <tr>
          <td class="py-1 px-2 font-base font-semibold text-right align-top text-blue-700 bg-gray-50 border-b border-gray-200">${k}</td>
          <td class="py-1 px-2">
            ${typeof v === 'boolean'
              ? `<span class="inline-block px-2 py-0.5 rounded-full font-bold ${v ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${v ? 'true' : 'false'}</span>`
              : `<span class="inline-block px-2 py-0.5 rounded font-bold bg-gray-100 text-gray-900">${v}</span>`
            }
          </td>
        </tr>
      `).join('')}
      </tbody>
    </table>
  `;
}

function renderPreview() {
  const previewDiv = document.getElementById("preview-panel");
  previewDiv.innerHTML = "";

  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) {
    previewDiv.innerHTML = `<div class="text-gray-400 italic">No feature selected.</div>`;
    return;
  }

  const result = evaluateStrategyForPreview(feature, currentFilters);

  if (result.type === "default") {
    previewDiv.innerHTML = `
      <div class="mb-2 text-gray-800"> 
        <span class="font-semibold">Default Settings Applied</span>
        <div class="text-gray-500 text-xs">No strategy matches the current filters; default values are used.</div>
      </div>
      ${renderPrettyObject(result.value)}
    `;
  } else if (result.type === "rule") {
    previewDiv.innerHTML = `
      <div class="mb-2">
        <span class="font-semibold text-blue-600">üéØ Rule Strategy Applied : ${result.strat.customLabel || "Rule"}</span>
        <div class="text-gray-500 text-xs mb-1">Conditions: ${result.strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
      </div>

      ${renderPrettyObject(result.strat.value)}
    `;
  } else if (result.type === "experiment") {
    const { strat } = result;
    
    
      // ‚≠ê [Ïó¨Í∏∞ Ìïú Îç©Ïñ¥Î¶¨ Ï∂îÍ∞Ä] ‚≠ê
  let metricsLine = "";
  if (Array.isArray(strat.metrics) && strat.metrics.length > 0) {
    const metricsText = strat.metrics
      .map(key => {
        const m = (appData.metrics || []).find(m => m.key === key);
        return m ? `${m.displayName} (${m.unit})` : key;
      }).join(", ");
    metricsLine = `<div class="mb-1 text-xs text-blue-800 font-bold">
      <span class="mr-1">üìä Metrics:</span> ${metricsText}
    </div>`;
  }

    
    previewDiv.innerHTML = `
      <div class="mb-2">
        <span class="font-semibold text-green-600">üß™ Experiment Strategy Applied: ${strat.customLabel || "Experiment"}</span>
        <div class="text-gray-500 text-xs mb-1">Conditions: ${strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
      </div>
      
        ${metricsLine}
      
      <div class="space-y-2">
        ${strat.variants.map(variant => `
          <div class="flex items-center gap-2">
            <span class="px-2 py-0.5 bg-gray-200 rounded">${variant.name}</span>
            <span class="text-xs text-gray-500">Rollout: ${variant.rollout}%</span>
            ${renderPrettyObject(variant.value)}
          </div>
        `).join("")}
      </div>
    `;
  } else if (result.type === "canary") {
    const { strat } = result;
      let metricsLine = "";
  if (Array.isArray(strat.metrics) && strat.metrics.length > 0) {
    const metricsText = strat.metrics
      .map(key => {
        const m = (appData.metrics || []).find(m => m.key === key);
        return m ? `${m.displayName} (${m.unit})` : key;
      }).join(", ");
    metricsLine = `<div class="mb-1 text-xs text-yellow-800 font-bold">
      <span class="mr-1">üìä Metrics:</span> ${metricsText}
    </div>`;
  }
    previewDiv.innerHTML = `
      <div class="mb-2">
        <span class="font-semibold text-yellow-600">üê§ Canary Strategy Applied: ${strat.customLabel || "Canary"}</span>
        <div class="text-gray-500 text-xs mb-1">Conditions: ${strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
        <div class="text-base text-yellow-800 font-bold mb-2">Rollout: ${strat.rollout}%</div>

      </div>
                    ${metricsLine}
    
${renderPrettyObject(strat.value)}
    `;
  }
  
  
  if (result.type === "experiment" || result.type === "canary") 
  // ----- [Show Result Î≤ÑÌäº: experiment Ï†ÑÎûµÏùº Îïå] -----
   {
    const btnDiv = document.createElement("div");
    btnDiv.className = "mt-5 flex justify-start"; // Ï¢åÏ∏° Ï†ïÎ†¨
    const btn = document.createElement("button");
    btn.className = "bg-blue-600 text-base hover:bg-blue-700 text-white px-5 py-2 rounded-xl font-semibold shadow";
    btn.textContent = "Show Result";
    btn.onclick = function() {
      showStrategyResultModal(result.strat);
    };
    btnDiv.appendChild(btn);
    // previewDivÎäî Ïù¥ÎØ∏ ÏûàÏùå
    previewDiv.appendChild(btnDiv);
  }
}

</script>

<script>



function renderStrategyEditor() {
  const editor = document.getElementById("strategy-editor");
  editor.innerHTML = "";

const envBar = document.createElement("div");
envBar.className = "flex justify-end items-center mb-4";

const feature = appData.features.find(f => f.id === selectedFeatureId);

if (!feature) {
  editor.innerHTML = `<div class="text-gray-400 text-base italic">No feature selected.</div>`;
  return;
}

if (!feature.strategies) feature.strategies = [];

// ÎùºÎ≤®(ÏÑ†ÌÉùÏ†Å)
const envLabel = document.createElement("span");
envLabel.textContent = "Environment";
envLabel.className = "mr-2 text-base font-semibold text-blue-700";
envBar.appendChild(envLabel);

// ÏÖÄÎ†âÌä∏Î∞ïÏä§
const envSelector = document.createElement("select");
envSelector.className = "px-2 py-1 border rounded bg-blue-50 text-blue-900 font-semibold text-base";
environmentNames.forEach(env => {
  const opt = document.createElement("option");
  opt.value = env;
  opt.textContent = env.charAt(0).toUpperCase() + env.slice(1);
  if (currentEnv === env) opt.selected = true;
  envSelector.appendChild(opt);
});
envSelector.onchange = (e) => {
  currentEnv = e.target.value;
  renderStrategyEditor();
  renderPreview();
};
envBar.appendChild(envSelector);

const applyModeLabel = document.createElement("span");
applyModeLabel.textContent = "Deploy";
applyModeLabel.className = "ml-6 mr-2 text-base font-semibold text-blue-700";
envBar.appendChild(applyModeLabel);

const applyModeSelect = document.createElement("select");
applyModeSelect.className = "px-2 py-1 border rounded bg-blue-50 text-blue-900 font-semibold text-base";

["build", "remote", "both"].forEach(mode => {
  const opt = document.createElement("option");
  opt.value = mode;
  opt.textContent = mode === "build" ? "Build" : mode === "remote" ? "Remote" : "Both";
  if (feature.applyMode === mode) opt.selected = true;
  applyModeSelect.appendChild(opt);
});
applyModeSelect.onchange = (e) => {
  feature.applyMode = e.target.value;
  renderStrategyEditor();
};
envBar.appendChild(applyModeSelect);
// Ïã§Ï†ú ÏóêÎîîÌÑ∞ Îß® ÏúÑÏóê Î∂ôÏù¥Í∏∞
editor.appendChild(envBar);


 
  // --- Default Settings Box ---
  const defaultBox = document.createElement("div");
  defaultBox.className = "border-2 border-gray-300 bg-gray-50 shadow-lg p-4 mb-5 hover:shadow-2xl"; 
  const headerDiv = document.createElement("div");
  headerDiv.className = "flex items-center justify-between mb-3 ";
  const title = document.createElement("h3");
  title.className = "text-base font-semibold text-black";
  title.innerText = "Default Settings";
  const toggleBtn = document.createElement("button");
  toggleBtn.className = "text-base border px-2 py-1 rounded";
  toggleBtn.innerHTML = "üìÇ";
  let form = document.createElement("form");
  form.className = "space-y-4" + (defaultSettingsOpen ? "" : " hidden");;
  form.onsubmit = e => {
    e.preventDefault();
    const data = new FormData(form);
    for (let [k, v] of data.entries()) {
      if (feature.schema.properties[k].type === "boolean") {
        feature.defaultValue[k] = v === "true";
      } else {
        feature.defaultValue[k] = v;
      }
    }
    renderFeatures();
    renderPreview();
    showModal("Default Settings Saved", "Your default settings have been saved successfully.");
  };

  Object.entries(feature.schema.properties).forEach(([key, def]) => {
    const fieldWrapper = document.createElement("div");
    const label = `<label class='block font-medium mb-1'>${key}</label>`;
    let input = "";
    const currentValue = feature.defaultValue[key];

    if (def.enum) {
      input += `<select name='${key}' class='w-full border px-2 py-1 rounded'>
        ${def.enum.map(val => `<option value='${val}' ${val === currentValue ? "selected" : ""}>${val}</option>`).join("")}
      </select>`;
    } else if (def.type === "boolean") {
      input += `<select name='${key}' class='w-full border px-2 py-1 rounded'>
        <option value='true' ${currentValue === true ? "selected" : ""}>true</option>
        <option value='false' ${currentValue === false ? "selected" : ""}>false</option>
      </select>`;
    } else {
      input += `<input name='${key}' value='${currentValue}' class='w-full border px-2 py-1 rounded' />`;
    }

    fieldWrapper.innerHTML = label + input;
    form.appendChild(fieldWrapper);
  });

  const saveBtn = document.createElement("button");
  saveBtn.type = "submit";
  saveBtn.className = "px-4 py-2 bg-blue-600 text-white font-semibold rounded hover:bg-blue-700";
  saveBtn.textContent = "Save Default";
  form.appendChild(saveBtn);

  toggleBtn.onclick = () => {
    defaultSettingsOpen = !defaultSettingsOpen;
    form.classList.toggle("hidden", !defaultSettingsOpen);
    toggleBtn.innerHTML = defaultSettingsOpen ? "üìÇ" : "üìÅ";
  };

  headerDiv.appendChild(title);
  headerDiv.appendChild(toggleBtn);
  defaultBox.appendChild(headerDiv);
  defaultBox.appendChild(form);
  editor.appendChild(defaultBox);

  // --- Divider
  const divider = document.createElement("hr");
  divider.className = "my-6 border-gray-400";
  editor.appendChild(divider);

  // --- Strategies Toolbar ---
  const strategyTitle = document.createElement("div");
  strategyTitle.className = "flex justify-between items-center mb-3 w-full";
  const titleText = document.createElement("h3");
  titleText.className = "text-base font-semibold";
  titleText.textContent = "Feature Strategies";
  const collapseBtn = document.createElement("button");
  collapseBtn.innerHTML = "üìÇ";
  collapseBtn.className = "text-base px-2 py-1 border rounded whitespace-nowrap";
  strategyTitle.appendChild(titleText);
  strategyTitle.appendChild(collapseBtn);
  editor.appendChild(strategyTitle);

  // --- Strategy List ---
  const strategyList = document.createElement("div");
  strategyList.className = "space-y-3 mb-4";
  feature.strategies.forEach((s, i) => {
    const card = document.createElement("div");
    card.setAttribute('draggable', true);
    card.dataset.index = i;
    card.ondragstart = (e) => {
      e.dataTransfer.setData("strategyIndex", i);
      card.style.opacity = 0.6;
    };
    card.ondragend = (e) => {
      card.style.opacity = "";
      document.querySelectorAll(".strategy-dropzone").forEach(el => el.classList.remove("ring-4", "ring-blue-400"));
    };
    card.ondragover = (e) => {
      e.preventDefault();
      card.classList.add("strategy-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondragleave = (e) => {
      card.classList.remove("strategy-dropzone", "ring-4", "ring-blue-400");
    };
    card.ondrop = (e) => {
      e.preventDefault();
      card.classList.remove("strategy-dropzone", "ring-4", "ring-blue-400");
      const fromIndex = Number(e.dataTransfer.getData("strategyIndex"));
      const toIndex = Number(card.dataset.index);
      if (fromIndex === toIndex) return;
      const moved = feature.strategies.splice(fromIndex, 1)[0];
      feature.strategies.splice(toIndex, 0, moved);
      renderStrategyEditor();
      renderPreview();
    };

    // Ïπ¥Îìú Ïú†Ìòï ÌëúÏãú
    const typeMap = {
      rule: { label: "Rule", emoji: "üéØ", border: "border-blue-500", text: "text-blue-800" },
      experiment: { label: "Experiment", emoji: "üß™", border: "border-green-500", text: "text-green-800" },
      canary: { label: "Canary", emoji: "üê§", border: "border-yellow-500", text: "text-yellow-800" }
    };
    const type = typeMap[s.type] || { label: s.type, emoji: "‚ùì", border: "border-gray-400", text: "text-gray-800" };
   // card.className = "bg-white rounded-lg shadow-md p-3 border-l-4 " + type.border;
   //card.className = "bg-white rounded-lg  shadow-md p-5 my-3 shadow-xl border-2 border-blue-500 border-l-4 " + type.border;
   card.className = `
  bg-white rounded-2xl
  border-2 border-gray-400
  shadow-lg
  hover:shadow-2xl
  transition
  cursor-pointer
  p-5 my-4
  ${type.border}
`.replace(/\s+/g, ' ');

    // Ïπ¥Îìú Ìó§Îçî
    const header = document.createElement("div");
    header.className = "flex justify-between items-start mb-1";
    const labelBox = document.createElement("div");
    labelBox.className = "flex items-center gap-2 font-semibold " + type.text + " text-base";
    labelBox.innerHTML = `
      <span>${type.emoji}</span>
      <span class="strategy-label w-38 truncate">${s.customLabel || type.label}</span>
      <input type="text" class="strategy-input hidden border px-1 py-0.5 rounded text-base w-38 truncate"
             value="${s.customLabel || type.label}"
             onblur='saveStrategyLabel(this,"${feature.id}", "${s.id}")'
             onkeydown="if(event.key==='Enter'){this.blur();}" />
    `;
    const actionBox = document.createElement("div");
    actionBox.className = "flex items-center gap-1";

    const toggleBtn = document.createElement("button");
    toggleBtn.innerHTML = s.collapsed ? "üìÅ" : "üìÇ";
    toggleBtn.title = "Toggle Strategy Body";
    toggleBtn.onclick = () => {
      const panel = document.getElementById('strategy-section');
      const prevScroll = panel.scrollTop;
      body.classList.toggle("hidden");
      s.collapsed = body.classList.contains("hidden");
      toggleBtn.innerHTML = s.collapsed ? "üìÅ" : "üìÇ";
      panel.scrollTop = prevScroll;
    };

    const upBtn = document.createElement("button");
    upBtn.textContent = "‚ñ≤";
    upBtn.title = "Move Up";
    upBtn.onclick = () => moveStrategyUp(feature.id, i);

    const downBtn = document.createElement("button");
    downBtn.textContent = "‚ñº";
    downBtn.title = "Move Down";
    downBtn.onclick = () => moveStrategyDown(feature.id, i);

    const delBtn = document.createElement("button");
    delBtn.textContent = "‚ùå";
    delBtn.title = "Delete";
    delBtn.className = "text-gray-400 hover:text-red-500 text-base";
    delBtn.onclick = () => removeStrategy(feature.id, s.id);

    const editBtn = document.createElement("button");
    editBtn.textContent = "‚úèÔ∏è";
    editBtn.title = "Edit";
    editBtn.className = "text-blue-600 text-base";
    editBtn.onclick = () => {
      const label = labelBox.querySelector(".strategy-label");
      const input = labelBox.querySelector(".strategy-input");
      if (label && input) {
        label.classList.add("hidden");
        input.classList.remove("hidden");
        input.focus();
        input.select();
      }
    };

    actionBox.appendChild(editBtn);
    actionBox.appendChild(toggleBtn);
    actionBox.appendChild(upBtn);
    actionBox.appendChild(downBtn);
    actionBox.appendChild(delBtn);

    header.appendChild(labelBox);
    header.appendChild(actionBox);
    card.appendChild(header);

    // Ïπ¥Îìú Î∞îÎîî
    const body = document.createElement("div");
    body.className = "strategy-body" + (s.collapsed ? " hidden" : "");
    body.appendChild(renderStrategyFormUI(feature, s));
    card.appendChild(body);

    strategyList.appendChild(card);
  });
  editor.appendChild(strategyList);

  // Ï†ÑÏ≤¥ ÌéºÏπòÍ∏∞/Ï†ëÍ∏∞ ÎèôÍ∏∞Ìôî
  collapseBtn.onclick = () => {
    const allBodies = strategyList.querySelectorAll(".strategy-body");
    const allHidden = Array.from(allBodies).every(div => div.classList.contains("hidden"));
    allBodies.forEach(div => div.classList.toggle("hidden", !allHidden));
    strategyList.querySelectorAll("button[title='Toggle Strategy Body']").forEach(btn => {
      btn.innerHTML = allHidden ? "üìÇ" : "üìÅ";
    });
    feature.strategies.forEach(s => s.collapsed = !allHidden);
    collapseBtn.innerHTML = allHidden ? "üìÇ" : "üìÅ";
  };

  // Add Î≤ÑÌäº
  const addBtnGroup = document.createElement("div");
  addBtnGroup.className = "flex flex-wrap justify-start gap-2 mb-4";
  function makeAddButton(icon, label, color, onClick) {
    const btn = document.createElement("button");
    btn.className = `flex items-center gap-1 px-3 py-1 rounded-full ${color.bg} ${color.text} text-base font-semibold hover:brightness-105 transition`;
    btn.innerHTML = `Ôºã ${icon} ${label}`;
    btn.onclick = onClick;
    return btn;
  }
  const colors = {
    rule: { bg: "bg-blue-100", text: "text-blue-800" },
    experiment: { bg: "bg-green-100", text: "text-green-800" },
    canary: { bg: "bg-yellow-100", text: "text-yellow-800" }
  };
  const addRuleBtn = makeAddButton("üéØ", "Rule", colors.rule, () => {
    feature.strategies.push({
      id: `r-${Date.now()}`,
      type: "rule",
      customLabel: "Rule",
      conditions: [],
      value: { ...feature.defaultValue },
      collapsed: true
    });
    renderStrategyEditor();
    renderPreview();
  });
  
  
  const addExpBtn = makeAddButton("üß™", "Experiment", colors.experiment, () => {
  feature.strategies.push({
    id: `e-${Date.now()}`,
    type: "experiment",
    customLabel: "Experiment",
    conditions: [],
    variants: [
      { name: "A", value: { ...feature.defaultValue }, rollout : 50},
      { name: "B", value: { ...feature.defaultValue }, rollout : 50}
    ],
    collapsed: true
  });
  renderStrategyEditor();
  renderPreview();
});
  
  
  const addCanaryBtn = makeAddButton("üê§", "Canary", colors.canary, () => {
  feature.strategies.push({
    id: `c-${Date.now()}`,
    type: "canary",
    customLabel: "Canary",
    conditions: [],
    value: { ...feature.defaultValue }, // ‚Üê Ïöî Î∂ÄÎ∂Ñ!
    rollout : 10,
    collapsed: true
  });
  renderStrategyEditor();
  renderPreview();
});
// ‚ñº Îß§Ìä∏Î¶≠Ïä§ Î≤ÑÌäº Ï∂îÍ∞Ä
const matrixBtn = document.createElement("button");
matrixBtn.textContent = "üóÇÔ∏è Matrix";
matrixBtn.className = "ml-3 px-3 py-1.5 rounded-lg bg-blue-50 text-blue-700 font-bold border border-blue-300 hover:bg-blue-100";
matrixBtn.onclick = openMatrixModal;


  addBtnGroup.appendChild(addRuleBtn);
  addBtnGroup.appendChild(addExpBtn);
  addBtnGroup.appendChild(addCanaryBtn);
  addBtnGroup.appendChild(matrixBtn);
  editor.appendChild(addBtnGroup);

  const saveStrategiesBtn = document.createElement("button");
  saveStrategiesBtn.className = "px-4 py-2 bg-gray-800 text-white font-semibold rounded hover:bg-gray-700";
  saveStrategiesBtn.textContent = "Save Strategies";
  saveStrategiesBtn.onclick = () => {
    showModal("Strategies Saved", "Your strategies have been saved successfully.");
  };
  editor.appendChild(saveStrategiesBtn);


}

function removeStrategy(featureId, strategyId) {
  const feature = appData.features.find(f => f.id === featureId);
  if (!feature || !feature.strategies) return;
  feature.strategies = feature.strategies.filter(s => s.id !== strategyId);
  renderStrategyEditor();
  renderPreview();
}
function moveStrategyUp(featureId, index) {
  const feature = appData.features.find(f => f.id === featureId);
  if (!feature || index <= 0) return;
  const temp = feature.strategies[index];
  feature.strategies[index] = feature.strategies[index - 1];
  feature.strategies[index - 1] = temp;
  renderStrategyEditor();
  renderPreview();
}
function moveStrategyDown(featureId, index) {
  const feature = appData.features.find(f => f.id === featureId);
  if (!feature || index >= feature.strategies.length - 1) return;
  const temp = feature.strategies[index];
  feature.strategies[index] = feature.strategies[index + 1];
  feature.strategies[index + 1] = temp;
  renderStrategyEditor();
  renderPreview();
}
function saveStrategyLabel(input, featureId, strategyId) {
  const newLabel = input.value.trim();
  const label = input.closest(".flex").querySelector(".strategy-label");
  const feature = appData.features.find(f => f.id === featureId);
  const strategy = feature?.strategies?.find(s => s.id === strategyId);
  if (label && newLabel && strategy) {
    label.textContent = newLabel;
    strategy.customLabel = newLabel;
    renderPreview();
  }
  input.classList.add("hidden");
  label.classList.remove("hidden");
}

// ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞è ÌôîÎ©¥ Î†åÎçî
let currentView = 'features';
function navigate(view) {
  currentView = view;
  renderMain();
  highlightNav(view);
}



function renderMain() {
  const container = document.getElementById('main-content');
  if (!container) return;
  if (currentView === 'features') {
    container.innerHTML = document.getElementById('features-view-template').innerHTML;
    renderFeatures();
    renderFilterBar();
    renderStrategyEditor();
    renderPreview();

    // üîç Í≤ÄÏÉâ Ïù∏Ìíã Ïù¥Î≤§Ìä∏ Îì±Î°ù!
    const search = document.getElementById("feature-search");
    if (search) search.oninput = renderFeatures;
    
  } 
  
   else if (currentView === 'devices') {
    container.innerHTML = document.getElementById('devices-view-template').innerHTML;
    renderDeviceFilterBar();
    renderDeviceListPanel();
    renderDeviceFeatureListPanel();
    renderDeviceFeatureDetailPanel();
  }
  else if (currentView === 'segments') {
  renderSegmentView();
}
  else {
    const name = currentView.charAt(0).toUpperCase() + currentView.slice(1);
    container.innerHTML = `
      <div class='w-full h-full flex items-center justify-center'>
        <div class='text-3xl text-gray-500 italic font-semibold text-center'>
          üöß ${name} is coming soon...
        </div>
      </div>`;
  }
}

function renderSegmentView() {
  const container = document.getElementById('main-content');
  container.innerHTML = `
    <div class="flex flex-1 h-[calc(100vh-6rem)] divide-x divide-gray-300">
      <!-- Ï¢å: ÏÑ∏Í∑∏Î®ºÌä∏ Î¶¨Ïä§Ìä∏ -->
      <section class="w-1/3 p-6 overflow-y-auto bg-white">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-semibold leading-none mb-0">Segments</h2>
          <button id="add-segment-btn" class="px-3 py-1 bg-blue-700 text-white rounded hover:bg-blue-900 text-base">+ Add</button>
        </div>
        <input id="segment-search" type="text" placeholder="Search segments..." class="mb-4 px-3 py-2 border border-gray-300 rounded-lg text-base bg-gray-100 focus:outline-none focus:border-blue-400 w-full" />
        <div class="space-y-3" id="segment-list"></div>
      </section>
      <!-- Ïö∞: ÏÑ∏Í∑∏ ÏÉÅÏÑ∏ -->
      <section class="flex-1 p-6 overflow-y-auto bg-white" id="segment-detail-panel"></section>
    </div>
  `;

  // ÏÉÅÌÉú Î≥ÄÏàò (ÌÅ¥Î°úÏ†Ä)
  let selectedSegmentId = null;

  function renderSegmentList() {
    const listDiv = document.getElementById("segment-list");
    const q = (document.getElementById("segment-search")?.value || "").trim().toLowerCase();
    let segments = appData.segments;
    if (q) segments = segments.filter(s => s.name.toLowerCase().includes(q) || s.description.toLowerCase().includes(q));
    listDiv.innerHTML = "";
    segments.forEach(seg => {
      const card = document.createElement("div");
      card.className = "rounded-2xl border px-4 py-3 shadow hover:shadow-xl cursor-pointer transition " +
        (seg.id === selectedSegmentId ? "border-blue-500 ring-2 ring-blue-300 bg-blue-50" : "border-gray-300 bg-white");
      card.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="font-bold text-base">${seg.name}</div>
          <button class="text-gray-400 hover:text-red-500" title="Delete" data-seg-id="${seg.id}">‚ùå</button>
        </div>
        <div class="text-xs text-gray-500 mt-1">${seg.description}</div>
        <div class="mt-2 text-xs">
          ${seg.conditions.map(c => `<span class="inline-block bg-gray-100 text-gray-600 rounded px-2 py-0.5 mr-1">${c.field} ${c.op} ${Array.isArray(c.value) ? c.value.join(',') : c.value}</span>`).join("")}
        </div>
      `;
      card.onclick = () => {
        selectedSegmentId = seg.id;
        renderSegmentList();
        renderSegmentDetail();
      };
      // Ïπ¥Îìú Ïïà ÏÇ≠Ï†ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏ ÏúÑÏûÑ
      card.querySelector("button[data-seg-id]").onclick = function(e) {
        e.stopPropagation();
        deleteSegment(seg.id);
      };
      listDiv.appendChild(card);
    });
  }

  function renderSegmentDetail() {
  const panel = document.getElementById("segment-detail-panel");
  if (!selectedSegmentId) {
    panel.innerHTML = `<div class="text-gray-400 p-8 text-center">No segment selected.</div>`;
    return;
  }
  const seg = appData.segments.find(s => s.id === selectedSegmentId);
  if (!seg) {
    panel.innerHTML = `<div class="text-red-400 p-8 text-center">Segment not found.</div>`;
    return;
  }

  // Ïù∏ÎùºÏù∏ Ìé∏Ïßë ÏÉÅÌÉú Í¥ÄÎ¶¨
  seg._editingName = !!seg._editingName;
  seg._editingDesc = !!seg._editingDesc;

  // 1. Ïú†Ï†Ä ÌïÑÎìúÎßå ÎìúÎ°≠Îã§Ïö¥Ïóê ÎÖ∏Ï∂ú
  const userFields = Object.keys(appData.users[0] || {})
    .filter(k => k !== "id" && k !== "name")
    .map(k => ({
      key: "user." + k,
      title: "User " + k.charAt(0).toUpperCase() + k.slice(1)
    }));

  // 2. Í∞Å Ïú†Ï†Ä ÌïÑÎìúÎ≥Ñ enum Í∞í ÏûêÎèô Ï∂îÏ∂ú
  const userFieldEnumMap = {};
  userFields.forEach(f => {
    const vals = Array.from(new Set(
      appData.users.map(u => u[f.key.replace("user.", "")])
    )).filter(v => v !== undefined && v !== null);
    if (vals.length > 1 && vals.length <= 10) {
      userFieldEnumMap[f.key] = vals;
    }
  });

  panel.innerHTML = `
    <div class="mb-4">
      <div class="flex items-center gap-2 mb-2">
        ${
          seg._editingName
            ? `<input id="seg-name-input" class="border rounded px-2 py-1 text-xl font-bold w-1/2" value="${seg.name}"/>
               <button class="text-xs text-green-700 font-semibold" id="save-name">Save</button>
               <button class="text-xs text-gray-400 font-semibold" id="cancel-name">Cancel</button>`
            : `<div class="text-2xl font-bold">${seg.name}</div>
               <button class="text-gray-400 hover:text-blue-500" id="edit-name" title="Edit name">‚úèÔ∏è</button>`
        }
      </div>
      <div class="flex items-center gap-2 mb-2">
        ${
          seg._editingDesc
            ? `<input id="seg-desc-input" class="border rounded px-2 py-1 text-gray-700 w-2/3" value="${seg.description || ""}"/>
               <button class="text-xs text-green-700 font-semibold" id="save-desc">Save</button>
               <button class="text-xs text-gray-400 font-semibold" id="cancel-desc">Cancel</button>`
            : `<div class="text-gray-500">${seg.description || ""}</div>
               <button class="text-gray-400 hover:text-blue-500" id="edit-desc" title="Edit description">‚úèÔ∏è</button>`
        }
      </div>
      <div class="flex flex-wrap gap-2 mb-3" id="condition-tags">
        ${
          seg.conditions.map((c, i) => {
            if (!c._editing) {
              return `
                <span class="bg-blue-100 text-blue-700 rounded px-2 py-0.5">
                  ${c.field} ${c.op} ${Array.isArray(c.value) ? c.value.join(',') : c.value}
                  <button class="ml-1 text-xs text-red-600 hover:underline" data-cond-idx="${i}">x</button>
                </span>
              `;
            } else {
              const hasEnum = !!userFieldEnumMap[c.field];
              return `
                <span class="flex items-center gap-2 bg-yellow-50 px-2 py-0.5 rounded">
                  <select id="cond-field-${i}" class="border rounded px-1">
                    ${userFields.map(f =>
                      `<option value="${f.key}" ${c.field === f.key ? "selected" : ""}>${f.title}</option>`
                    ).join("")}
                  </select>
                  <select id="cond-op-${i}" class="border rounded px-1">
                    ${["=", "!=", ">", "<", ">=", "<=", "in", "not in"].map(op =>
                      `<option value="${op}" ${c.op === op ? "selected" : ""}>${op}</option>`
                    ).join("")}
                  </select>
                  ${
                    hasEnum
                      ? `<select id="cond-value-${i}" class="border rounded px-1 w-24">
                          <option value="">Select</option>
                          ${userFieldEnumMap[c.field].map(v =>
                            `<option value="${v}" ${c.value == v ? "selected" : ""}>${v}</option>`
                          ).join("")}
                        </select>`
                      : `<input id="cond-value-${i}" class="border rounded px-1 w-24" value="${c.value !== null ? c.value : ""}"/>`
                  }
                  <button class="text-xs text-green-700 font-semibold" id="save-cond-${i}">Save</button>
                  <button class="text-xs text-gray-400 font-semibold" id="cancel-cond-${i}">Cancel</button>
                </span>
              `;
            }
          }).join("")
        }
      </div>
      <button class="px-3 py-1 bg-gray-200 text-gray-800 rounded hover:bg-gray-300" id="add-condition-btn">+ Add Condition</button>
    </div>
    <div class="mb-4">
      <div class="font-bold mb-1">Users in Segment</div>
      <div id="segment-users-list"></div>
    </div>
  `;

  // Ïù¥Î¶Ñ/ÏÑ§Î™Ö Ïù∏ÎùºÏù∏ ÏàòÏ†ï Ïù¥Î≤§Ìä∏
  if (panel.querySelector("#edit-name")) panel.querySelector("#edit-name").onclick = function() {
    seg._editingName = true; renderSegmentDetail();
  };
  if (panel.querySelector("#save-name")) panel.querySelector("#save-name").onclick = function() {
    seg.name = panel.querySelector("#seg-name-input").value.trim() || seg.name;
    seg._editingName = false; renderSegmentDetail();
  };
  if (panel.querySelector("#cancel-name")) panel.querySelector("#cancel-name").onclick = function() {
    seg._editingName = false; renderSegmentDetail();
  };

  if (panel.querySelector("#edit-desc")) panel.querySelector("#edit-desc").onclick = function() {
    seg._editingDesc = true; renderSegmentDetail();
  };
  if (panel.querySelector("#save-desc")) panel.querySelector("#save-desc").onclick = function() {
    seg.description = panel.querySelector("#seg-desc-input").value.trim();
    seg._editingDesc = false; renderSegmentDetail();
  };
  if (panel.querySelector("#cancel-desc")) panel.querySelector("#cancel-desc").onclick = function() {
    seg._editingDesc = false; renderSegmentDetail();
  };

  // Ï°∞Í±¥ ÏÇ≠Ï†ú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
  panel.querySelectorAll("button[data-cond-idx]").forEach(btn => {
    btn.onclick = function() {
      deleteCondition(seg.id, parseInt(btn.dataset.condIdx, 10));
    };
  });

  // Ï°∞Í±¥ Ï∂îÍ∞Ä Î≤ÑÌäº
  panel.querySelector("#add-condition-btn").onclick = function() {
    addCondition(seg.id);
  };

  // Ï°∞Í±¥ ÏûÖÎ†•Ï§Ñ Ïù¥Î≤§Ìä∏ (ÌïÑÎìú, Ïó∞ÏÇ∞Ïûê, Í∞í, Save/Cancel)
  seg.conditions.forEach((c, i) => {
    if (c._editing) {
      const fieldSel = panel.querySelector(`#cond-field-${i}`);
      const opSel = panel.querySelector(`#cond-op-${i}`);
      const hasEnum = !!userFieldEnumMap[c.field];
      const valInp = panel.querySelector(`#cond-value-${i}`);

      fieldSel.onchange = () => {
        c.field = fieldSel.value;
        c.value = "";
        renderSegmentDetail();
      };
      opSel.onchange = () => { c.op = opSel.value; };
      if (hasEnum) {
        valInp.onchange = () => { c.value = valInp.value; };
      } else {
        valInp.oninput = () => { c.value = valInp.value; };
      }
      panel.querySelector(`#save-cond-${i}`).onclick = function() {
        if (!c.value) {
          alert("Í∞íÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî");
          return;
        }
        c._editing = false;
        renderSegmentDetail();
      };
      panel.querySelector(`#cancel-cond-${i}`).onclick = function() {
        seg.conditions.splice(i, 1);
        renderSegmentDetail();
      };
    }
  });

  // Ï°∞Í±¥ Ï†ÅÏö© Ïú†Ï†Ä Î¶¨Ïä§Ìä∏
  const users = appData.users.filter(user => {
    return seg.conditions.every(cond => {
      if (cond._editing) return true; // ÏïÑÏßÅ ÎØ∏ÏôÑÎ£å Ï°∞Í±¥ÏùÄ Î¨¥Ïãú
      let val = cond.field.startsWith("user.") ? user[cond.field.replace("user.", "")] : undefined;
      if (Array.isArray(cond.value)) {
        if (cond.op === "in") return val && cond.value.includes(val) || (Array.isArray(val) && val.some(v => cond.value.includes(v)));
      }
      if (cond.op === "=") return String(val) === String(cond.value);
      if (cond.op === "!=") return String(val) !== String(cond.value);
      if (cond.op === ">") return Number(val) > Number(cond.value);
      if (cond.op === ">=") return Number(val) >= Number(cond.value);
      if (cond.op === "<") return Number(val) < Number(cond.value);
      if (cond.op === "<=") return Number(val) <= Number(cond.value);
      return false;
    });
  });

  const ul = document.createElement("ul");
  ul.className = "list-disc ml-4";
  users.forEach(u => {
    const li = document.createElement("li");
    li.innerHTML = `<span class="font-bold">${u.name}</span> <span class="text-xs text-gray-500">(${u.id}, ${u.country}, ${u.age}, ${u.gender})</span>`;
    ul.appendChild(li);
  });
  panel.querySelector("#segment-users-list").appendChild(ul);
}

  // ÏÑ∏Í∑∏Î®ºÌä∏ ÏÇ≠Ï†ú
  function deleteSegment(id) {
    if (confirm("Ï†ïÎßêÎ°ú ÏÇ≠Ï†úÌï†ÍπåÏöî?")) {
      appData.segments = appData.segments.filter(s => s.id !== id);
      if (selectedSegmentId === id) selectedSegmentId = null;
      renderSegmentList();
      renderSegmentDetail();
    }
  }

  // Ï°∞Í±¥ ÏÇ≠Ï†ú
  function deleteCondition(segId, condIdx) {
    const seg = appData.segments.find(s => s.id === segId);
    if (seg) {
      seg.conditions.splice(condIdx, 1);
      renderSegmentDetail();
    }
  }

  // Ï°∞Í±¥ Ï∂îÍ∞Ä
 function addCondition(segId) {
  const seg = appData.segments.find(s => s.id === segId);
  if (!seg) return;

  // user ÌïÑÎìúÎßå ÎìúÎ°≠Îã§Ïö¥ÏúºÎ°ú ÎÖ∏Ï∂ú!
  const userFields = Object.keys(appData.users[0] || {})
    .filter(k => k !== "id" && k !== "name")
    .map(k => ({
      key: "user." + k,
      title: "User " + k.charAt(0).toUpperCase() + k.slice(1)
    }));

  // Ï∂îÍ∞Ä ÏûÖÎ†•Ï§ÑÏù¥ Ïù¥ÎØ∏ ÏûàÎã§Î©¥ Ï§ëÎ≥µÏ∂îÍ∞Ä Î∞©ÏßÄ
  if (seg.conditions.some(c => c._editing)) return;

  seg.conditions.push({
    _editing: true,
    field: userFields[0].key,
    op: "=",
    value: ""
  });
  renderSegmentDetail();
}

  // ÏÑ∏Í∑∏Î®ºÌä∏ Ï∂îÍ∞Ä
document.getElementById("add-segment-btn").onclick = function() {
  // 1. Í≥†Ïú† ID/Ïù¥Î¶Ñ ÏûêÎèô
  const ts = Date.now();
  const id = "segment_" + ts;
  const name = "New Segment";
  const desc = "";
  // 2. ÎçîÎØ∏ Îç∞Ïù¥ÌÑ∞Î°ú Î∞îÎ°ú Ï∂îÍ∞Ä
  appData.segments.unshift({
    id,
    name,
    description: desc,
    conditions: []
  });
  // 3. Î∞îÎ°ú ÏÑ†ÌÉùÎêòÍ≤å
  selectedSegmentId = id;
  renderSegmentList();
  renderSegmentDetail();
};

  // Í≤ÄÏÉâ Ïó∞Îèô
  document.getElementById("segment-search").oninput = renderSegmentList;

  // ÏµúÏ¥à Î†åÎçîÎßÅ
  renderSegmentList();
  renderSegmentDetail();
}

function highlightNav(view) {
  currentView = view.toLowerCase(); // ÌòÑÏû¨ Î∑∞ Ï†ÄÏû•
  const buttons = document.querySelectorAll("nav button");
 
  buttons.forEach(btn => {
    const text = btn.innerText.toLowerCase();
    if (text.includes(currentView)) {
      btn.classList.add("bg-[#283040]", "text-blue-500", "font-bold");
    } else {
      btn.classList.remove("bg-[#283040]", "text-blue-500", "font-bold");
    }
  });
}
window.onload = function () {
  navigate("features");
}
</script>

<script>
function renderConditionRow(cond, index, strategy, rerenderCallback) {
  const row = document.createElement("div");
  row.className = "flex flex-wrap gap-2 items-center";

  const fieldSelect = document.createElement("select");
  fieldSelect.className = "border rounded px-2 py-1 text-base min-w-[160px] flex-1";
  filterFields.forEach(f => {
    const opt = document.createElement("option");
    opt.value = f.key;
    opt.textContent = f.title;
    if (cond.field === f.key) opt.selected = true;
    fieldSelect.appendChild(opt);
  });

  const opSelect = document.createElement("select");
  opSelect.className = "border rounded px-2 py-1 text-base min-w-[80px]";
  ["=", "!=", "in", "not in"].forEach(op => {
    const opt = document.createElement("option");
    opt.value = op;
    opt.textContent = op;
    if (cond.op === op) opt.selected = true;
    opSelect.appendChild(opt);
  });

  const valueBox = document.createElement("div");
  valueBox.className = "flex-1";

  function updateValueInput(fieldKey) {
    valueBox.innerHTML = "";
    const field = filterFields.find(f => f.key === fieldKey);
    if (!field) return;
    try {
      const source = appData[field.path];
      const values = [...new Set(source.map(x => field.field ? x[field.field] : x).filter(Boolean))];
      if (values.length > 0) {
        const select = document.createElement("select");
        select.className = "w-full border rounded px-2 py-1 text-base";
        values.forEach(v => {
          const opt = document.createElement("option");
          opt.value = v;
          opt.textContent = v;
          if (String(cond.value) === String(v)) opt.selected = true;
          select.appendChild(opt);
        });
        select.addEventListener("change", () => {
          cond.value = select.value;      // ‚≠ê Î∞òÎìúÏãú Ï°∞Í±¥Í∞í Ï†ÄÏû•!
          if (rerenderCallback) rerenderCallback();
          renderPreview();
        });
        valueBox.appendChild(select);

        // ‚≠ê Ïã†Í∑ú Ï°∞Í±¥ ÏÉùÏÑ±Ïãú ÏûêÎèô Ï≤´ Í∞í ÏßÄÏ†ï (ÎπàÍ∞íÏù¥Î©¥)
        if (!cond.value && values.length > 0) {
          cond.value = values[0];
        }
      } else {
        const input = document.createElement("input");
        input.type = "text";
        input.placeholder = "value";
        input.value = cond.value || "";
        input.className = "w-full border rounded px-2 py-1 text-base";
        input.addEventListener("input", () => {
          cond.value = input.value;      // ‚≠ê Î∞òÎìúÏãú Ï°∞Í±¥Í∞í Ï†ÄÏû•!
          if (rerenderCallback) rerenderCallback();
          renderPreview();
        });
        valueBox.appendChild(input);
      }
    } catch {
      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "value";
      input.value = cond.value || "";
      input.className = "w-full border rounded px-2 py-1 text-base";
      input.addEventListener("input", () => {
        cond.value = input.value;      // ‚≠ê Î∞òÎìúÏãú Ï°∞Í±¥Í∞í Ï†ÄÏû•!
        if (rerenderCallback) rerenderCallback();
        renderPreview();
      });
      valueBox.appendChild(input);
    }
  }

  fieldSelect.addEventListener("change", () => {
  cond.field = fieldSelect.value;
  // ÌïÑÎìúÍ∞Ä Î∞îÎÄåÎ©¥ valueÎèÑ Ìï¥Îãπ fieldÏùò Ï≤´ Í∞íÏúºÎ°ú ÎçÆÏñ¥ÏîÄ!
  const config = filterFields.find(f => f.key === cond.field);
  const candidates = config ? getFilterValues(config) : [];
  cond.value = candidates.length > 0 ? candidates[0] : "";
  updateValueInput(cond.field);
  renderPreview();
});


  const deleteBtn = document.createElement("button");
  deleteBtn.textContent = "‚úñÔ∏è";
  deleteBtn.className = "text-gray-400 hover:text-red-500 text-base";
  deleteBtn.title = "Delete";
  deleteBtn.onclick = () => {
    strategy.conditions.splice(index, 1);
    rerenderCallback && rerenderCallback();
    renderPreview();
  };

  row.appendChild(fieldSelect);
  row.appendChild(opSelect);
  row.appendChild(valueBox);
  row.appendChild(deleteBtn);

  // Ï°∞Í±¥ Í∞í Ïù∏Ìíã ÏÉùÏÑ± Î∞è ÎèôÍ∏∞Ìôî
  updateValueInput(cond.field);

  return row;
}

function renderOverrideForm(schema, valueObj) {
  const overrideBox = document.createElement("div");
  overrideBox.className = "space-y-2";
  const overrideTitle = document.createElement("div");
  overrideTitle.textContent = "Override Value";
  overrideTitle.className = "font-semibold text-base mb-1";
  overrideBox.appendChild(overrideTitle);

  for (const key in schema.properties) {
    const def = schema.properties[key];
    const fieldGroup = document.createElement("div");
    fieldGroup.className = "mb-2";
    const label = document.createElement("label");
    label.className = "block text-base font-medium";
    label.textContent = key;
    fieldGroup.appendChild(label);

    let input;
    if (def.enum) {
      input = document.createElement("select");
      input.className = "w-full border px-2 py-1 rounded text-base";
      def.enum.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if (valueObj[key] === opt) o.selected = true;
        input.appendChild(o);
      });
      input.onchange = (e) => {
        valueObj[key] = e.target.value;
        renderPreview();
      };
    } else if (def.type === "boolean") {
      input = document.createElement("select");
      input.className = "w-full border px-2 py-1 rounded text-base";
      ["true", "false"].forEach(val => {
        const o = document.createElement("option");
        o.value = val;
        o.textContent = val;
        if (String(valueObj[key]) === val) o.selected = true;
        input.appendChild(o);
      });
      input.onchange = (e) => {
        valueObj[key] = (e.target.value === "true");
        renderPreview();
      };
    } else {
      input = document.createElement("input");
      input.type = "text";
      input.className = "w-full border px-2 py-1 rounded text-base";
      input.value = valueObj[key] || "";
      input.oninput = (e) => {
        valueObj[key] = e.target.value;
        renderPreview();
      };
    }
    fieldGroup.appendChild(input);
    overrideBox.appendChild(fieldGroup);
  }
  return overrideBox;
}


function addConditionToStrategy(strategy) {
  // Í∏∞Î≥∏ ÌïÑÎìúÎäî platform.version, valueÎäî Ìï¥Îãπ ÌïÑÎìúÏùò Ï≤´ ÌõÑÎ≥¥Í∞í
  const fieldKey = filterFields[0].key;
  const candidates = getFilterValues(filterFields[0]);
  strategy.conditions.push({
    field: fieldKey,
    op: "=",
    value: candidates.length > 0 ? candidates[0] : ""
  });
}



function renderStrategyFormUI(feature, strategy) {
  const wrapper = document.createElement("div");
  wrapper.className = "mt-3 p-3 bg-white rounded space-y-4";
  
  const divider1 = document.createElement("hr");
  if (strategy.type === "rule")
  divider1.className = "my-3 border-blue-500";
  else if (strategy.type === "experiment")
  divider1.className = "my-3 border-green-500";
  else
  divider1.className = "my-3 border-yellow-500";
  wrapper.appendChild(divider1);

  // --- Conditions
  const conditionBox = document.createElement("div");
  conditionBox.className = "space-y-2";
  const conditionTitle = document.createElement("div");
  conditionTitle.textContent = "Conditions";
  conditionTitle.className = "font-semibold text-base mb-1";
  conditionBox.appendChild(conditionTitle);
  
  if (!strategy.conditions || strategy.conditions.length === 0) {
    addConditionToStrategy(strategy);
  }
  strategy.conditions.forEach((cond, index) => {
    if (!cond.field) cond.field = filterFields[0].key;
    const row = renderConditionRow(cond, index, strategy, () => {
      renderStrategyEditor();
      renderPreview();
    });
    conditionBox.appendChild(row);
  });
  const addConditionBtn = document.createElement("button");
  addConditionBtn.className = "mt-1 bg-blue-600 text-white px-3 py-1 rounded font-semibold hover:bg-blue-700";
  
  addConditionBtn.textContent = "+ Condition";
  addConditionBtn.onclick = () => {
        addConditionToStrategy(strategy);
    renderStrategyEditor();
    renderPreview();
  };
  conditionBox.appendChild(addConditionBtn);
  wrapper.appendChild(conditionBox);



if (strategy.type === "experiment" || strategy.type === "canary" ) {
  // Metrics Î∞∞Ïó¥ ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî
  if (!strategy.metrics) strategy.metrics = [];

  const metricBox = document.createElement("div");
  metricBox.className = "mb-2";
  const metricTitle = document.createElement("div");
  metricTitle.textContent = "Metrics";
  metricTitle.className = "font-semibold text-base mb-1";
  metricBox.appendChild(metricTitle);

  // Í∞Å metric Ìïú Ï§ÑÏî© (ÎìúÎ°≠Î∞ïÏä§+ÏÇ≠Ï†ú Î≤ÑÌäº, Î∞òÏùëÌòï)
  strategy.metrics.forEach((metricKey, idx) => {
    const metricRow = document.createElement("div");
    // gridÎ°ú Ïπ∏ ÎÑòÏπ® Î∞©ÏßÄ (ÎìúÎ°≠Î∞ïÏä§ 1fr, Î≤ÑÌäº auto)
    metricRow.className = "grid grid-cols-[1fr_auto] gap-1 mb-1 w-full";
    // ÎìúÎ°≠Î∞ïÏä§
    const select = document.createElement("select");
    select.className = "border px-2 py-1 rounded text-base w-full";
    select.style.minWidth = "0"; // flex/grid overflow Î∞©ÏßÄ
    select.innerHTML =
      appData.metrics.map(m =>
        `<option value="${m.key}" ${m.key===metricKey?'selected':''}>
          ${m.displayName} (${m.unit})
        </option>`
      ).join("");
    select.onchange = (e) => {
      strategy.metrics[idx] = e.target.value;
      renderStrategyEditor();
      renderPreview();
    };
    // ÏÇ≠Ï†ú Î≤ÑÌäº
    const delBtn = document.createElement("button");
    delBtn.textContent = "‚úñÔ∏è";
    delBtn.className = "text-red-500 hover:text-red-700 font-bold text-lg px-1";
    delBtn.onclick = (e) => {
      e.preventDefault();
      strategy.metrics.splice(idx, 1);
      renderStrategyEditor();
      renderPreview();
    };
    metricRow.appendChild(select);
    metricRow.appendChild(delBtn);
    metricBox.appendChild(metricRow);
  });

  // "Add Metric" Î≤ÑÌäº
  const addBtn = document.createElement("button");
  addBtn.className = "mt-1 bg-blue-600 text-white px-3 py-1 rounded font-semibold hover:bg-blue-700";
  addBtn.textContent = "+ Metric";
  addBtn.onclick = (e) => {
    e.preventDefault();
    // ÏïÑÏßÅ ÏÑ†ÌÉùÌïòÏßÄ ÏïäÏùÄ metricÎßå Ï∂îÍ∞Ä (Ï§ëÎ≥µ Î∞©ÏßÄ)
    const available = (appData.metrics || []).map(m=>m.key).filter(k=>!strategy.metrics.includes(k));
    if (available.length > 0) {
      strategy.metrics.push(available[0]);
      renderStrategyEditor();
      renderPreview();
    }
  };
  metricBox.appendChild(addBtn);

  wrapper.appendChild(metricBox);

  // ... Ïù¥ ÏïÑÎûòÎ°ú Í∏∞Ï°¥ variants, override Îì± ÏΩîÎìú Ïù¥Ïñ¥ÏÑú!
}


  const divider = document.createElement("hr");
  if (strategy.type === "rule")
  divider.className = "my-6 border-blue-500";
  else if (strategy.type === "experiment")
  divider.className = "my-6 border-green-500";
  else
  divider.className = "my-6 border-yellow-500";
  wrapper.appendChild(divider);

  // --- Override (Rule/Canary)
  if (strategy.type !== "experiment") {
  const overrideBox = renderOverrideForm(feature.schema, strategy.value);
  wrapper.appendChild(overrideBox);
}
  // --- Experiment: Variants
  if (strategy.type === "experiment") {
    const variantBox = document.createElement("div");
    variantBox.className = "space-y-2";
    const variantTitle = document.createElement("div");
    variantTitle.textContent = "Variants";
    variantTitle.className = "font-semibold text-base mb-1";
    variantBox.appendChild(variantTitle);
    
    
    
strategy.variants.forEach((variant, index) => {
  const row = document.createElement("div");
  
    let bgColor = "#E6F4FF";
  if (index === 1) bgColor = "#FFE9E6";
  if (index > 1)  bgColor = "#F4F6FB";
  row.style.background = bgColor;
  
  
  row.className = "flex flex-wrap items-end gap-4 bg-blue-50 p-3 pl-4 border border-gray-400 mb-1 shadow";
  // Ïù¥Î¶Ñ
  const nameGroup = document.createElement("div");
  nameGroup.className = "flex flex-col mr-3 mb-1";
  const nameLabel = document.createElement("label");
  nameLabel.className = "text-base font-semibold text-gray-700 mb-1";
  nameLabel.textContent = "Variant Name";
  nameGroup.appendChild(nameLabel);
  const nameInput = document.createElement("input");
  nameInput.className = "w-28 border rounded px-2 py-1 text-base font-semibold";
  nameInput.value = variant.name;
  nameInput.oninput = (e) => { variant.name = e.target.value; };
  nameGroup.appendChild(nameInput);

  // rollout
  const rolloutGroup = document.createElement("div");
  rolloutGroup.className = "flex flex-col mr-3 mb-1";
  const rolloutLabel = document.createElement("label");
  rolloutLabel.className = "text-base font-semibold text-gray-700 mb-1";
  rolloutLabel.textContent = "Rollout (%)";
  rolloutGroup.appendChild(rolloutLabel);
  const rolloutInput = document.createElement("input");
  rolloutInput.type = "number";
  rolloutInput.min = 0;
  rolloutInput.max = 100;
  rolloutInput.className = "w-24 border rounded px-2 py-1 text-base font-semibold";
  rolloutInput.value = variant.rollout;
  rolloutInput.oninput = (e) => { variant.rollout = parseInt(e.target.value, 10); };
  rolloutInput.onblur = (e) => { variant.rollout = parseInt(e.target.value, 10); renderPreview(); };
  rolloutGroup.appendChild(rolloutInput);

// 2. Í∞ÄÎ°úÏÑ†
const hr = document.createElement("hr");
hr.className = " border-t-2 border-gray-400 w-full";


  // Í∞íÎì§
  const valueContainer = document.createElement("div");
  valueContainer.className = "flex flex-wrap gap-2";
  for (const key in feature.schema.properties) {
    const def = feature.schema.properties[key];
    const group = document.createElement("div");
    group.className = "flex flex-col mb-1";
    const label = document.createElement("label");
    label.className = "text-base font-semibold text-gray-700 mb-1";
    label.textContent = key;
    let input;
    if (def.enum) {
      input = document.createElement("select");
      input.className = "w-28 border rounded px-2 py-1 text-base w-full min-w-[180px]";
      def.enum.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if (variant.value[key] === opt) o.selected = true;
        input.appendChild(o);
      });
      input.onchange = (e) => { variant.value[key] = e.target.value; renderPreview(); };
    } else if (def.type === "boolean") {
      input = document.createElement("select");
      input.className = "w-28 border rounded px-2 py-1 text-base w-full min-w-[180px]";
      
      
      ["true", "false"].forEach(val => {
        const o = document.createElement("option");
        o.value = val;
        o.textContent = val;
        if (String(variant.value[key]) === val) o.selected = true;
        input.appendChild(o);
      });
      input.onchange = (e) => { variant.value[key] = (e.target.value === "true"); renderPreview(); };
    } else {
      input = document.createElement("input");
      input.type = "text";
      input.className = "w-28 border rounded px-2 py-1 text-base w-full min-w-[180px]";
      input.value = variant.value[key] || "";
      input.oninput = (e) => { variant.value[key] = e.target.value; };
    }
    group.appendChild(label);
    group.appendChild(input);
    valueContainer.appendChild(group);
  }

  row.appendChild(nameGroup);
  row.appendChild(rolloutGroup);
  row.appendChild(hr);
  row.appendChild(valueContainer);
  variantBox.appendChild(row);
});
    
    
    
    wrapper.appendChild(variantBox);
  }
  // --- Canary: Rollout
  if (strategy.type === "canary") {
    const rolloutBox = document.createElement("div");
    rolloutBox.className = "space-y-1";
    const rolloutLabel = document.createElement("label");
    rolloutLabel.textContent = "Rollout (%)";
    rolloutLabel.className = "block text-base font-medium";
    const rolloutInput = document.createElement("input");
    rolloutInput.type = "number";
    rolloutInput.min = 0;
    rolloutInput.max = 100;
    rolloutInput.value = strategy.rollout || 0;
    rolloutInput.className = "w-full border rounded px-2 py-1 text-base";
    rolloutInput.oninput = (e) => {
      strategy.rollout = parseInt(e.target.value, 10);
    };
    
    
    rolloutInput.onblur = (e) => {
  strategy.rollout = parseInt(e.target.value, 10);
  renderPreview(); // ‚≠ê ÏûÖÎ†•ÏóêÏÑú ÎÇòÏò¨ ÎïåÎßå ÌîÑÎ¶¨Î∑∞ Í∞±Ïã†!
};
    

    rolloutBox.appendChild(rolloutLabel);
    rolloutBox.appendChild(rolloutInput);
    wrapper.appendChild(rolloutBox);
  }
  return wrapper;
}

function showModal(title = "Notice", message = "No content provided.") {
  document.getElementById("modalTitle").textContent = title;
  document.getElementById("modalMessage").textContent = message;
  document.getElementById("globalModal").classList.remove("hidden");
}
 
function closeModal() {
  document.getElementById("globalModal").classList.add("hidden");
}

// ---------------------- Feature Matrix Core ----------------------

const MATRIX_FIELDS = filterFields.map(f => ({
  key: f.key,
  label: f.title,
  values: () => getFilterValues(f)
}));
let selectedMatrixCellKey = null;

function openMatrixModal() {
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return showModal("Error", "Select a feature first.");
  document.getElementById("matrixFeatureName").textContent = feature.name;

  // ÎìúÎ°≠Îã§Ïö¥ Ï±ÑÏö∞Í∏∞
  const rowSel = document.getElementById("matrixRowField");
  const colSel = document.getElementById("matrixColField");
  rowSel.innerHTML = "";
  colSel.innerHTML = "";
  MATRIX_FIELDS.forEach(f => {
    rowSel.innerHTML += `<option value="${f.key}">${f.label}</option>`;
    colSel.innerHTML += `<option value="${f.key}">${f.label}</option>`;
  });
  rowSel.value = "deviceGroup.name";
  colSel.value = "country";
  rowSel.onchange = renderMatrixTable;
  colSel.onchange = renderMatrixTable;

  renderMatrixTable();
  document.getElementById("matrixModal").classList.remove("hidden");
}
function closeMatrixModal() {
  document.getElementById("matrixModal").classList.add("hidden");
  hideMatrixCellPopover();
}
function renderMatrixTable() {
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) {
    document.getElementById("matrixTable").innerHTML = "<div class='text-gray-400 italic p-6'>No feature selected.</div>";
    return;
  }
  const rowKey = document.getElementById("matrixRowField").value;
  const colKey = document.getElementById("matrixColField").value;
  const rows = getFilterValues(filterFields.find(f => f.key === rowKey));
  const cols = getFilterValues(filterFields.find(f => f.key === colKey));

  let html = `<table class="min-w-full border text-xs relative">
    <thead class="bg-gray-100"><tr>
      <th class="px-3 py-2"></th>
      ${cols.map(c=>`<th class="px-3 py-2 font-bold">${c}</th>`).join("")}
    </tr></thead>
    <tbody>
      ${rows.map((r, ri) => `
        <tr>
          <td class="px-3 py-2 font-bold bg-gray-50">${r}</td>
          ${cols.map((c, ci) => {
            const cellKey = `${rowKey}|${r}|${colKey}|${c}`;
            let cellStrat = (feature.strategies||[]).find(strat =>
              (strat.conditions||[]).some(cond => cond.field===rowKey && cond.value==r) &&
              (strat.conditions||[]).some(cond => cond.field===colKey && cond.value==c)
            );
            let status = "Default";
            let emoji = "‚ö™";
            let color = "";
            if (cellStrat) {
              status = cellStrat.type.charAt(0).toUpperCase()+cellStrat.type.slice(1);
              emoji = cellStrat.type==="rule"?"üéØ":cellStrat.type==="experiment"?"üß™":cellStrat.type==="canary"?"üê§":"‚ö™";
              color = cellStrat.type==="rule"?"bg-blue-50":
                      cellStrat.type==="experiment"?"bg-green-50":
                      cellStrat.type==="canary"?"bg-yellow-50":"";
            }
            // Ìè¨Ïª§Ïä§ ÏÖÄ Ïä§ÌÉÄÏùº
            let focusClass = cellKey === selectedMatrixCellKey
              ? "ring-2 ring-blue-500  z-10"
              : "";
            // üî• data-matrix-cell Ï∂îÍ∞Ä, cellElemÏùÄ Ï†ÑÎã¨ ÏïàÌï®!
            return `<td class="px-3 py-2 text-center font-semibold cursor-pointer ${color} ${focusClass}"
              data-matrix-cell="${cellKey}"
              onclick="showMatrixCellMenu('${rowKey}','${r}','${colKey}','${c}',${ri},${ci})">
              <span>${emoji}</span><br><span>${status}</span>
            </td>`;
          }).join("")}
        </tr>
      `).join("")}
    </tbody>
  </table>
  <div id="matrixCellMenu" class="absolute z-50"></div>
  `;
  document.getElementById("matrixTable").innerHTML = html;
}
// ÌåùÏò§Î≤Ñ(Ï†ÑÎûµÏú†Ìòï ‚Üí Í∞íÏûÖÎ†•) ------------------------------

window.showMatrixCellMenu = function(rowKey, rowVal, colKey, colVal, rowIdx, colIdx) {
  hideMatrixCellPopover();

  // 1. ÏÑ†ÌÉùÎêú ÏÖÄ Ï†ÄÏû• Î∞è Ìè¨Ïª§Ïä§ Í∞ïÏ°∞
  selectedMatrixCellKey = `${rowKey}|${rowVal}|${colKey}|${colVal}`;
  renderMatrixTable(); // Ìëú Îã§Ïãú Í∑∏Î¶º

  // 2. Î∞©Í∏à ÏÑ†ÌÉùÌïú tdÎ•º DOMÏóêÏÑú Ï∞æÏïÑ ÌåùÏóÖ ÏúÑÏπò Í≥ÑÏÇ∞
  const selector = `[data-matrix-cell="${rowKey}|${rowVal}|${colKey}|${colVal}"]`;
  const cellElem = document.querySelector(selector);
  if (!cellElem) return;

  const rect = cellElem.getBoundingClientRect();
  const left = rect.left + window.scrollX;
  const top = rect.bottom + window.scrollY + 2;

  const popover = document.getElementById("matrixCellPopover");
  popover.style.position = "absolute";
  popover.style.left = left + "px";
  popover.style.top = top + "px";
  popover.style.zIndex = 9999;
  popover.innerHTML = `
    <div class="bg-white border rounded shadow-lg p-2 flex flex-col gap-1 w-48"
         onclick="event.stopPropagation()">
      <button class="text-blue-700 hover:bg-blue-50 px-2 py-1 rounded text-left" onclick="showMatrixCellValueForm('${rowKey}','${rowVal}','${colKey}','${colVal}','rule');event.stopPropagation()">üéØ Rule</button>
      <button class="text-green-700 hover:bg-green-50 px-2 py-1 rounded text-left" onclick="showMatrixCellValueForm('${rowKey}','${rowVal}','${colKey}','${colVal}','experiment');event.stopPropagation()">üß™ Experiment</button>
      <button class="text-yellow-700 hover:bg-yellow-50 px-2 py-1 rounded text-left" onclick="showMatrixCellValueForm('${rowKey}','${rowVal}','${colKey}','${colVal}','canary');event.stopPropagation()">üê§ Canary</button>
      <button class="text-gray-500 hover:bg-gray-100 px-2 py-1 rounded text-left" onclick="editMatrixCellType('${rowKey}','${rowVal}','${colKey}','${colVal}','default');event.stopPropagation()">‚ùå Default</button>
    </div>
  `;
  popover.classList.remove("hidden");

  setTimeout(() => {
    window.addEventListener("mousedown", (e) => {
      if (!popover.contains(e.target)) hideMatrixCellPopover();
    }, { once:true });
  }, 100);
};



function hideMatrixCellPopover() {
  const popover = document.getElementById("matrixCellPopover");
  if (popover) {
    popover.innerHTML = "";
    popover.classList.add("hidden");
  }
  selectedMatrixCellKey = null;
  renderMatrixTable();
}
// Í∞íÏûÖÎ†•Ìèº
window.showMatrixCellValueForm = function(rowKey, rowVal, colKey, colVal, type) {
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return;
  const schema = feature.schema;
  let html = `<div class="bg-white border rounded shadow-lg p-4 w-72 space-y-2">`;
  html += `<div class="font-bold mb-2 text-base">${type.charAt(0).toUpperCase() + type.slice(1)} Settings</div>`;
  if (type === "rule" || type === "canary") {
    for (const key in schema.properties) {
      const def = schema.properties[key];
      html += `<label class="block mt-2">${key}`;
      if (def.enum) {
        html += `<select id="matxval_${key}" class="w-full border rounded px-2 py-1">` +
          def.enum.map(val=>`<option value="${val}">${val}</option>`).join("") +
          `</select>`;
      } else if (def.type === "boolean") {
        html += `<select id="matxval_${key}" class="w-full border rounded px-2 py-1">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>`;
      } else {
        html += `<input id="matxval_${key}" class="w-full border rounded px-2 py-1" value=""/>`;
      }
      html += `</label>`;
    }
    if (type === "canary") {
      html += `<label class="block mt-2">Rollout (%)<input id="matxval_rollout" type="number" min="0" max="100" value="10" class="w-full border rounded px-2 py-1"/></label>`;
    }
  }
  
  
else if (type === "experiment") {
  html += `<div class="font-bold text-base mb-1">A Variant</div>`;
  for (const key in schema.properties) {
    const def = schema.properties[key];
    html += `<label class="block">${key}`;
    if (def.enum) {
      html += `<select id="matxval_A_${key}" class="w-full border rounded px-2 py-1">` +
        def.enum.map(val=>`<option value="${val}">${val}</option>`).join("") +
        `</select>`;
    } else if (def.type === "boolean") {
      html += `<select id="matxval_A_${key}" class="w-full border rounded px-2 py-1">
        <option value="true">true</option>
        <option value="false">false</option>
      </select>`;
    } else {
      html += `<input id="matxval_A_${key}" class="w-full border rounded px-2 py-1" value=""/>`;
    }
    html += `</label>`;
  }
  html += `<label class="block">A (%)<input id="matxval_rolloutA" type="number" min="0" max="100" value="50" class="w-full border rounded px-2 py-1"/></label>`;

  html += `<div class="font-bold text-base mt-2 mb-1">B Variant</div>`;
  for (const key in schema.properties) {
    const def = schema.properties[key];
    html += `<label class="block">${key}`;
    if (def.enum) {
      html += `<select id="matxval_B_${key}" class="w-full border rounded px-2 py-1">` +
        def.enum.map(val=>`<option value="${val}">${val}</option>`).join("") +
        `</select>`;
    } else if (def.type === "boolean") {
      html += `<select id="matxval_B_${key}" class="w-full border rounded px-2 py-1">
        <option value="true">true</option>
        <option value="false">false</option>
      </select>`;
    } else {
      html += `<input id="matxval_B_${key}" class="w-full border rounded px-2 py-1" value=""/>`;
    }
    html += `</label>`;
  }
  html += `<label class="block">B (%)<input id="matxval_rolloutB" type="number" min="0" max="100" value="50" class="w-full border rounded px-2 py-1"/></label>`;
}
  
  
  html += `
    <div class="flex gap-2 mt-4">
      <button class="flex-1 bg-blue-700 text-white px-3 py-1 rounded" onclick="saveMatrixCellValue('${rowKey}','${rowVal}','${colKey}','${colVal}','${type}')">Save</button>
      <button class="flex-1 bg-gray-200 text-gray-700 px-3 py-1 rounded" onclick="hideMatrixCellPopover()">Cancel</button>
    </div>
  </div>`;
  const popover = document.getElementById("matrixCellPopover");
  popover.innerHTML = html;
  popover.classList.remove("hidden");
};




window.saveMatrixCellValue = function(rowKey, rowVal, colKey, colVal, type) {
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return;
  // Í∏∞Ï°¥ Ìï¥Îãπ Ï°∞Ìï© Ï†ÑÎûµ Ï†úÍ±∞
  feature.strategies = (feature.strategies||[]).filter(strat =>
    !((strat.conditions||[]).some(cond => cond.field===rowKey && cond.value==rowVal) &&
      (strat.conditions||[]).some(cond => cond.field===colKey && cond.value==colVal)
    )
  );
  if (type === "rule" || type === "canary") {
    const value = {};
    for (const key in feature.schema.properties) {
      const el = document.getElementById(`matxval_${key}`);
      if (!el) continue;
      const def = feature.schema.properties[key];
      if (def.enum) value[key] = el.value;
      else if (def.type === "boolean") value[key] = (el.value === "true");
      else value[key] = el.value;
    }
    let rollout = 10;
    if (type === "canary") {
      const rolloutEl = document.getElementById("matxval_rollout");
      rollout = rolloutEl ? parseInt(rolloutEl.value, 10) || 10 : 10;
    }
    hideMatrixCellPopover(); // ‚Üê Ïù¥Ï†ú Îã´Í∏∞!
    feature.strategies.push({
      id: (type[0]) + '-' + Date.now(),
      type,
      customLabel: type.charAt(0).toUpperCase() + type.slice(1),
      conditions: [
        { field: rowKey, op: "=", value: rowVal },
        { field: colKey, op: "=", value: colVal }
      ],
      value,
      ...(type === "canary" ? { rollout } : {}),
      collapsed: true
    });
  } else if (type === "experiment") {
    // ... (experimentÎèÑ Í∞í Ï∂îÏ∂ú ‚Üí ÌåùÏò§Î≤Ñ Îã´Í∏∞ ‚Üí Ï†ÄÏû• ÏàúÏÑú)
    // ÎèôÏùº Ìå®ÌÑ¥ Ï†ÅÏö©!
    const valueA = {};
    const valueB = {};
    for (const key in feature.schema.properties) {
      const def = feature.schema.properties[key];
      const elA = document.getElementById(`matxval_A_${key}`);
      const elB = document.getElementById(`matxval_B_${key}`);
      if (!elA || !elB) continue;
      if (def.enum) {
        valueA[key] = elA.value;
        valueB[key] = elB.value;
      } else if (def.type === "boolean") {
        valueA[key] = (elA.value === "true");
        valueB[key] = (elB.value === "true");
      } else {
        valueA[key] = elA.value;
        valueB[key] = elB.value;
      }
    }
    const rolloutA = parseInt(document.getElementById("matxval_rolloutA").value, 10) || 50;
    const rolloutB = parseInt(document.getElementById("matxval_rolloutB").value, 10) || 50;
    hideMatrixCellPopover(); // ‚Üê Ïù¥Ï†ú Îã´Í∏∞!
    feature.strategies.push({
      id: 'e-' + Date.now(),
      type: "experiment",
      customLabel: "Experiment",
      conditions: [
        { field: rowKey, op: "=", value: rowVal },
        { field: colKey, op: "=", value: colVal }
      ],
      variants: [
        { name: "A", value: valueA, rollout: rolloutA },
        { name: "B", value: valueB, rollout: rolloutB }
      ],
      collapsed: true
    });
  }
  renderMatrixTable();
  renderStrategyEditor();
  renderPreview();
};




// Ï†ÑÎûµ Ïú†Ìòï "Default" (ÏÇ≠Ï†ú)
window.editMatrixCellType = function(rowKey, rowVal, colKey, colVal, type) {
  hideMatrixCellPopover();
  const feature = appData.features.find(f => f.id === selectedFeatureId);
  if (!feature) return;
  feature.strategies = (feature.strategies||[]).filter(strat =>
    !((strat.conditions||[]).some(cond => cond.field===rowKey && cond.value==rowVal) &&
      (strat.conditions||[]).some(cond => cond.field===colKey && cond.value==colVal)
    )
  );
  renderMatrixTable();
  renderStrategyEditor();
  renderPreview();
};
function onBuildCommit() {
  showModal(
    "Commit to Repo",
    "This is a demo button."
  );
}
function onRemoteSend() {
  showModal(
    "Send to Remote",
    "This is a demo button."
  );
}

function renderDeviceFilterBar() {
  const filtersDiv = document.getElementById("device-filters");
  const dropdown = document.getElementById("add-device-filter-dropdown");

  // 1. ÌïÑÌÑ∞ div Î¶¨ÏÖã
  filtersDiv.innerHTML = "";

  // 2. Í∞Å ÌïÑÌÑ∞(Í∏∞Î≥∏/Ï∂îÍ∞Ä) Î†åÎçî
  for (const key in currentFilters) {
    const config = filterFields.find(f => f.key === key);
    if (!config) continue;

    const wrapper = document.createElement("div");
    wrapper.className = "flex items-center gap-2 bg-transparent px-2 py-1 rounded";

    const label = document.createElement("label");
    label.textContent = config.title;
    label.className = "font-semibold text-base text-gray-700";
    wrapper.appendChild(label);

    const select = document.createElement("select");
    select.className = "border rounded-lg px-2 py-1 font-bold text-base bg-blue-50 shadow focus:ring-2 focus:ring-blue-400";
    select.onchange = (e) => {
      currentFilters[key] = e.target.value === "All" ? undefined : e.target.value;
      selectedDeviceId = null;
      selectedDeviceFeatureId = null;
      renderDeviceFilterBar();
      renderDeviceListPanel();
      renderDeviceFeatureListPanel();
      renderDeviceFeatureDetailPanel();
    };

    const values = getFilterValues(config);
    [undefined, ...values].forEach(v => {
      const opt = document.createElement("option");
      opt.value = v || "All";
      opt.text = v || "All";
      if (currentFilters[key] === v || (v === undefined && currentFilters[key] === undefined)) {
        opt.selected = true;
      }
      select.appendChild(opt);
    });

    wrapper.appendChild(select);

    // Í∏∞Î≥∏ 4Í∞ú(Platform, Group, Device, Country) Ïô∏ÏóêÎäî ‚úïÎ≤ÑÌäº(ÏÇ≠Ï†ú) ÏßÄÏõê
    if (!["platform.version", "deviceGroup.name", "device.name", "country"].includes(key)) {
      const del = document.createElement("button");
      del.textContent = "‚úï";
      del.className = "ml-1 text-2xs font-semibold text-black hover:text-red-700";
      del.onclick = () => {
        delete currentFilters[key];
        renderDeviceFilterBar();
        renderDeviceListPanel();
        renderDeviceFeatureListPanel();
        renderDeviceFeatureDetailPanel();
      };
      wrapper.appendChild(del);
    }

    filtersDiv.appendChild(wrapper);
  }

  // 3. More(+Add Filter) Î≤ÑÌäº + ÎìúÎ°≠Îã§Ïö¥
  // (Ï§ëÎ≥µ Ï∂îÍ∞Ä Î∞©ÏßÄ)
  if (!document.getElementById("add-device-filter-dropdown")) {
    const addFilterDiv = document.createElement("div");
    addFilterDiv.className = "relative overflow-visible z-50";
    addFilterDiv.id = "add-device-filter-dropdown";

    const btn = document.createElement("button");
    btn.className = "px-4 py-1.5 bg-blue-600 text-white text-base font-semibold rounded-lg shadow hover:bg-blue-700 transition";
    btn.textContent = "More";
    btn.onclick = toggleDeviceFilterMenu;
    addFilterDiv.appendChild(btn);

    const menu = document.createElement("div");
    menu.id = "device-filter-menu";
    menu.className = "absolute right-0 mt-1 w-48 bg-white border border-gray-400 rounded shadow-lg hidden z-50";
    addFilterDiv.appendChild(menu);

    filtersDiv.appendChild(addFilterDiv);
  }
}


function toggleDeviceFilterMenu() {
  const menu = document.getElementById("device-filter-menu");
  menu.classList.toggle("hidden");
  renderDeviceFilterMenu();
}
function renderDeviceFilterMenu() {
  const menu = document.getElementById("device-filter-menu");
  menu.innerHTML = "";
  const unused = filterFields.filter(f => !(f.key in currentFilters));
  unused.forEach(f => {
    const btn = document.createElement("button");
    btn.textContent = f.title;
    btn.className = "w-full text-left px-4 py-2 text-base text-gray-800 hover:bg-[#26314f]";
    btn.onclick = () => {
      currentFilters[f.key] = undefined;
      menu.classList.add("hidden");
      renderDeviceFilterBar();
      renderDeviceListPanel();
      renderDeviceFeatureListPanel();
      renderDeviceFeatureDetailPanel();
    };
    menu.appendChild(btn);
  });
}



function getFilteredDevices() {
  let devices = appData.devices || [];
  const deviceGroups = appData.deviceGroups || [];
  const platforms = appData.platforms || [];

  let enrichedDevices = devices.map(dev => {
    const group = deviceGroups.find(g => g.devices?.includes(dev.id));
    // ÌîåÎû´Ìèº Îß§Ïπ≠: groupÏù¥ ÏÜåÏÜçÎêú Î™®Îì† ÌîåÎû´ÌèºÏóêÏÑú group.idÎ•º Ìè¨Ìï®ÌïòÎäî Í≤É(Îã§Ï§ë ÌîåÎû´Ìèº Í∞ÄÎä•)
    const matchingPlatforms = group
      ? platforms.filter(p => (p.deviceGroups || []).includes(group.id))
      : [];
    return { dev, group, platforms: matchingPlatforms };
  });

  return enrichedDevices.filter(row => {
    for (const field of filterFields) {
      const filterVal = currentFilters[field.key];
      if (!filterVal) continue;

      // ---- ÎèôÏ†Å path Ìï¥ÏÑù (ÌïµÏã¨!!) ----
      let value = undefined;
      if (field.key.startsWith("platform.")) {
        // Ïó¨Îü¨ ÌîåÎû´Ìèº Ï§ë 'ÌïòÎÇòÎùºÎèÑ' Í∞íÏù¥ ÏùºÏπòÌïòÎ©¥ OK
        const prop = field.key.split(".")[1];
        value = row.platforms.find(p => String(p[prop]) === String(filterVal));
        if (!value) return false;
      } else if (field.key.startsWith("deviceGroup.")) {
        const prop = field.key.split(".")[1];
        value = row.group ? row.group[prop] : undefined;
        if (String(value) !== String(filterVal)) return false;
      } else if (field.key.startsWith("device.")) {
        const prop = field.key.split(".")[1];
        value = row.dev ? row.dev[prop] : undefined;
        if (String(value) !== String(filterVal)) return false;
      } else if (field.key === "country") {
        // ÎîîÎ∞îÏù¥Ïä§Ïóî country ÏóÜÏùå (Ï†ÑÎûµ/ÌîÑÎ¶¨Î∑∞ÏóêÏÑúÎßå ÏÇ¨Ïö©)
      }
      // ...ÌïÑÏöîÏãú Ï∂îÍ∞Ä
    }
    return true;
  }).map(row => row.dev);
}

function renderDeviceListPanel() {
  const panel = document.getElementById('device-list-panel');
  if (!panel) return;

  const filteredDevices = getFilteredDevices();

  if (filteredDevices.length === 0) {
    panel.innerHTML = `<div class="text-gray-400 p-8 text-center">No devices found for current filter.</div>`;
    return;
  }

  panel.innerHTML = filteredDevices.map(dev => {
    // ÎîîÎ∞îÏù¥Ïä§ Í∑∏Î£π/ÌîåÎû´Ìèº Ï†ïÎ≥¥ Ï°∞Ìöå (for display)
    const group = (appData.deviceGroups || []).find(g => g.devices?.includes(dev.id));
    const platform = group ? (appData.platforms || []).find(p => p.id === group.platformId) : null;
    return `
      <div class="rounded-xl border px-4 py-3 mb-3 cursor-pointer
        ${selectedDeviceId===dev.id ? 'ring-2 ring-blue-500 bg-blue-50' : 'hover:bg-gray-100'}"
        onclick="handleSelectDevice('${dev.id}')">
        <div class="font-bold text-base">${dev.name}</div>
        <div class="text-xs text-gray-500 flex flex-wrap gap-2">
          ${platform ? `<span>${platform.name}</span>` : ""}
          ${group ? `<span>${group.name}</span>` : ""}
          <span>${dev.memory || '-'}GB</span>
          <span>${dev.tier || '-'}</span>
          <span>${dev.edition || '-'}</span>
        </div>
      </div>
    `;
  }).join("");
}


function handleSelectDevice(deviceId) {
  selectedDeviceId = deviceId;
  selectedDeviceFeatureId = null;
  // ‚úÖ ÏÉÅÎã® ÌïÑÌÑ∞(currentFilters) Í∞±Ïã†/ÎèôÍ∏∞Ìôî Ï†úÍ±∞!
  renderDeviceListPanel();
  renderDeviceFeatureListPanel();
  renderDeviceFeatureDetailPanel();
}
function handleSelectDeviceFeature(featureId) {
  selectedDeviceFeatureId = featureId;
  renderDeviceFeatureListPanel();
  renderDeviceFeatureDetailPanel();
}

function renderDeviceFeatureListPanel() {
  const panel = document.getElementById('device-feature-list-panel');
  if (!panel) return;
  if (!selectedDeviceId) {
    panel.innerHTML = "<div class='text-gray-400 p-8 text-center'>No device selected.</div>";
    return;
  }

  // ÏÑ†ÌÉù ÎîîÎ∞îÏù¥Ïä§, Í∑∏Î£π, ÌîåÎû´Ìèº Ï†ïÎ≥¥
  const dev = (appData.devices || []).find(d => d.id === selectedDeviceId);
  if (!dev) return;
  const group = (appData.deviceGroups || []).find(g => g.devices?.includes(dev.id));
  const platform = group ? (appData.platforms || []).find(p => (p.deviceGroups || []).includes(group.id)) : null;
  const features = appData.features || [];

  // Ï†ÑÎûµ ÌèâÍ∞ÄÏö© context (path key ÎèôÏãú Ìè¨Ìï®)
  let context = {};
  filterFields.forEach(f => {
    const key = f.key;
    if (key.startsWith("device.") && dev) {
      context[key] = dev[key.split(".")[1]];
    } else if (key.startsWith("deviceGroup.") && group) {
      context[key] = group[key.split(".")[1]];
    } else if (key.startsWith("platform.") && platform) {
      context[key] = platform[key.split(".")[1]];
    } else if (key === "country" && previewEnv && previewEnv.country) {
      context["country"] = previewEnv.country;
    }
  });
  Object.assign(context, dev, group, platform, previewEnv);

  panel.innerHTML = `
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-xl font-semibold leading-none mb-0">
        Feature List <span class="text-base text-blue-700 font-normal">(for ${dev.name})</span>
      </h2>
    </div>
    <div class="flex flex-col gap-4">
      ${features.map(f => {
        // Ï†ÑÎûµ ÌèâÍ∞Ä Í≤∞Í≥º
        const result = evaluateStrategyForPreview(f, context);
        const strategyType = result.type;

        // ÎåÄÌëú ÎùºÎ≤®(ÏßßÍ≥† ÍµµÍ≤å)
        let mainLabel = "";
        if (strategyType === "rule") {
          let ruleName = result.strat?.customLabel || "Rule";
          let displayName = ruleName.length > 20 ? ruleName.slice(0, 18) + "..." : ruleName;
          mainLabel = `<span title="${ruleName}" class="flex items-center gap-1 font-bold text-blue-700">üéØ ${displayName}</span>`;
        } else if (strategyType === "experiment") {
          let expName = result.strat?.customLabel || "Experiment";
          let displayName = expName.length > 20 ? expName.slice(0, 18) + "..." : expName;
          mainLabel = `<span title="${expName}" class="flex items-center gap-1 font-bold text-green-700">üß™ ${displayName}</span>`;
        } else if (strategyType === "canary") {
          let cnName = result.strat?.customLabel || "Canary";
          let displayName = cnName.length > 20 ? cnName.slice(0, 18) + "..." : cnName;
          let rollout = result.strat?.rollout ?? "";
          mainLabel = `
            <span title="${cnName}" class="flex items-center gap-1 font-bold text-yellow-700">
              üê§ ${displayName}
              <span class="ml-2 px-2 py-0.5 bg-yellow-100 text-yellow-900 text-xs rounded font-bold">Rollout: ${rollout}%</span>
            </span>`;
        } else {
          mainLabel = `<span class="text-gray-500 font-semibold">Default Values</span>`;
        }

        // Í∞í ÌÉúÍ∑∏ (ÌïÑÎìúÍ∞í, ÏµúÎåÄ 2Í∞ú, ÎÇòÎ®∏ÏßÄÎäî more)
        const valueObj = (
          strategyType === "canary"
            ? result.strat?.value
            : result.value || result.strat?.value || {}
        ) || {};
        const previewTags = Object.entries(valueObj)
          .slice(0, 2).map(([k, v]) => {
            let color = "bg-blue-100 text-blue-800";
            if (typeof v === "boolean") color = v ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
            return `<span class='inline-block ${color} px-2 py-0.5 rounded-full text-xs'>${k}: ${v}</span>`;
          }).join(" ") +
          (Object.keys(valueObj).length > 2
            ? ` <span class='text-xs text-gray-500'>+${Object.keys(valueObj).length - 2} more...</span>`
            : "");

        // Experiment Ï†ÑÎûµÏùº ÎïåÎßå variants Î≥ÑÎèÑ ÌëúÍ∏∞ (Î≥∏Î¨∏, ÏÑ§Î™Ö ÏúÑ)
        let variantRow = "";
        if (strategyType === "experiment" && Array.isArray(result.strat?.variants)) {
          let variants = result.strat.variants.map(v =>
            `<span class="inline-block bg-green-50 text-green-800 px-2 py-0.5 rounded-full text-xs mr-1">${v.name} <span class="text-gray-500">(${v.rollout}%)</span></span>`
          ).join("");
          if (variants) {
            variantRow = `<div class="flex flex-wrap items-center gap-1 mb-1">Variant: ${variants}</div>`;
          }
        }

        // ÌÜ†Í∏Ä (ÏùΩÍ∏∞Ï†ÑÏö©, Ïö∞Ï∏° Í≥†Ï†ï)
        let toggle = "";
        if (strategyType === "experiment") {
          // Ïã§Ìóò Ï†ÑÎûµÏù¥Î©¥ ÌÜ†Í∏Ä ÎåÄÏã† Ï§ëÎ¶ΩÏ†Å ÎåÄÏãú(-)
          toggle = `<span class="text-gray-400 font-extrabold text-xl select-none" title="Variants have different values">‚Äî</span>`;
        } else if ("enabled" in valueObj) {
          const isEnabled = valueObj.enabled;
          toggle = `
            <label class='relative inline-flex items-center cursor-not-allowed opacity-60'>
              <input type='checkbox' class='sr-only peer' disabled ${isEnabled ? "checked" : ""} />
              <div class='w-11 h-6 bg-gray-200 rounded-full peer peer-checked:bg-blue-600 transition-colors'></div>
              <div class='absolute left-[2px] top-[2px] bg-white w-5 h-5 rounded-full transition-transform peer-checked:translate-x-full'></div>
            </label>`;
        }

        return `
          <div class="rounded-2xl border flex flex-col gap-1 px-4 py-3 transition
            cursor-pointer shadow hover:shadow-xl
            ${f.id === selectedDeviceFeatureId ? "border-blue-500 ring-2 ring-blue-300 bg-blue-50" : "border-gray-400 bg-white"}"
            onclick="handleSelectDeviceFeature('${f.id}')">
            <div class="flex items-center mb-1 justify-between">
              <span class="text-lg font-semibold">${f.name}</span>
              ${toggle}
            </div>
            <div class="flex items-center gap-2 mb-1">${mainLabel}</div>
            <div class="flex flex-wrap gap-1 mb-1">${previewTags}</div>
            ${variantRow}
            <div class="text-xs text-gray-400">${f.description || ''}</div>
          </div>
        `;
      }).join('')}
    </div>
  `;
}


// ÌîÑÎ¶¨Î∑∞ ÌôòÍ≤Ω ÌïÑÌÑ∞Ïóê ÌëúÏãúÌï† ÌïÑÎìú(Ïó¨Í∏∞ÏÑúÎäî 'country'Îßå, ÌïÑÏöîÏãú Ï∂îÍ∞Ä)
const previewEnvFields = filterFields.filter(f =>
  ["country"].includes(f.key)
);

// ÌîÑÎ¶¨Î∑∞ ÌôòÍ≤Ω ÏÉÅÌÉú
let previewEnv = { country: undefined }; // ÎÇòÏ§ëÏóê region Îì± Ï∂îÍ∞Ä Í∞ÄÎä•

function renderDeviceFeatureDetailPanel() {
  const panel = document.getElementById('device-feature-detail-panel');
  if (!panel) return;

  // ÏÑ†ÌÉù ÎîîÎ∞îÏù¥Ïä§/ÌîºÏ≤ò ÏóÜÏúºÎ©¥ ÏïàÎÇ¥
  if (!selectedDeviceId || !selectedDeviceFeatureId) {
    panel.innerHTML = "<div class='text-gray-400 p-8 text-center'>No feature selected.</div>";
    return;
  }

  // ÎîîÎ∞îÏù¥Ïä§, Í∑∏Î£π, ÌîåÎû´Ìèº, ÌîºÏ≤ò Ï†ïÎ≥¥
  const dev = appData.devices.find(d => d.id === selectedDeviceId);
  const group = appData.deviceGroups.find(g => g.devices?.includes(selectedDeviceId));
  const platform = appData.platforms.find(p => group && (p.deviceGroups||[]).includes(group.id));
  const feature = (appData.features || []).find(f => f.id === selectedDeviceFeatureId);

  // ÌèâÍ∞ÄÏö© context: Ïπ¥ÎìúÏôÄ ÏôÑÏ†ÑÌûà ÎèôÏùºÌïòÍ≤å!
  let context = {};
  filterFields.forEach(f => {
    const key = f.key;
    if (key.startsWith("device.") && dev) {
      context[key] = dev[key.split(".")[1]];
    } else if (key.startsWith("deviceGroup.") && group) {
      context[key] = group[key.split(".")[1]];
    } else if (key.startsWith("platform.") && platform) {
      context[key] = platform[key.split(".")[1]];
    } else if (key === "country" && previewEnv && previewEnv.country) {
      context["country"] = previewEnv.country;
    }
  });
  Object.assign(context, dev, group, platform, previewEnv);

  // Ï†ÑÎûµ ÌèâÍ∞Ä
  const result = evaluateStrategyForPreview(feature, context);

  // Í∞í ÌÉúÍ∑∏
  const valueObj = (
    result.type === "canary"
      ? result.strat?.value
      : result.value || result.strat?.value || {}
  ) || {};
  const valueTags = Object.entries(valueObj)
    .map(([k, v]) => {
      let color = "bg-blue-100 text-blue-800";
      if (typeof v === "boolean") color = v ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
      return `<span class='inline-block ${color} px-2 py-0.5 rounded-full text-xs mr-1'>${k}: ${v}</span>`;
    }).join(" ");

  // Ï†ÑÎûµ Ïú†Ìòï ÎùºÎ≤®
  let stratLabel = "";
  if (result.type === "rule") {
    let ruleName = result.strat?.customLabel || "Rule";
    stratLabel = `<span class="inline-block font-bold text-blue-600">üéØ ${ruleName}</span>`;
  } else if (result.type === "experiment") {
    let expName = result.strat?.customLabel || "Experiment";
    stratLabel = `<span class="inline-block font-bold text-green-700">üß™ ${expName}</span>`;
  } else if (result.type === "canary") {
    let cnName = result.strat?.customLabel || "Canary";
    let rollout = result.strat?.rollout ?? "";
    stratLabel = `<span class="inline-block font-bold text-yellow-700">üê§ ${cnName} (${rollout}%)</span>`;
  } else {
    stratLabel = `<span class="inline-block font-semibold text-gray-500">Default Values</span>`;
  }

  // ÏÉÅÏÑ∏ ÎîîÎ∞îÏù¥Ïä§ Ï†ïÎ≥¥
  let deviceInfoHtml = `
    <div class="mb-2 bg-gray-50 border px-3 py-2 rounded text-xs text-gray-600">
      <b>Device:</b> ${dev.name} |
      <b>Group:</b> ${group ? group.name : '-'} |
      <b>Platform:</b> ${platform ? platform.version : '-'} |
      <b>Memory:</b> ${dev.memory || '-'}GB |
      <b>Tier:</b> ${dev.tier || '-'} |
      <b>Edition:</b> ${dev.edition || '-'}
    </div>
  `;

  // ÌîÑÎ¶¨Î∑∞ ÌôòÍ≤Ω ÌïÑÌÑ∞(Íµ≠Í∞Ä Îì±)
  let envFilterHtml = `<div class="mb-2 flex items-center gap-3">
    <span class="font-semibold text-base text-blue-800">Preview Environment:</span>`;
  previewEnvFields.forEach(f => {
    const values = getFilterValues(f);
    envFilterHtml += `
      <label class="font-semibold text-sm ml-2 mr-1">${f.title}:</label>
      <select class="border rounded px-2 py-1 text-base"
        onchange="onPreviewEnvChange('${f.key}', this.value)">
        <option value="">All</option>
        ${values.map(v => `<option value="${v}" ${previewEnv[f.key]===v?"selected":""}>${v}</option>`).join('')}
      </select>
    `;
  });
  envFilterHtml += `</div>`;

  // Ï†ÑÎûµ ÏÉÅÏÑ∏/preview ÏòÅÏó≠
  let previewHtml = "";
  if (result.type === "default") {
    previewHtml = `
      <div class="mb-2 text-gray-800"> 
        <span class="font-semibold">Default Settings Applied</span>
        <div class="text-gray-500 text-xs">No strategy matches the selected device and preview environment; default values are used.</div>
      </div>
      ${valueTags}
    `;
  } else if (result.type === "rule") {
    previewHtml = `
      <div class="mb-2">
        ${stratLabel}
        <div class="text-gray-500 text-xs mb-1">Conditions: ${result.strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
      </div>
      ${valueTags}
    `;
  } else if (result.type === "experiment") {
    const { strat } = result;
    previewHtml = `
      <div class="mb-2">
        ${stratLabel}
        <div class="text-gray-500 text-xs mb-1">Conditions: ${strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
      </div>
      <div class="space-y-2">
        ${strat.variants.map(variant => `
          <div class="flex items-center gap-2">
            <span class="px-2 py-0.5 bg-gray-200 rounded">${variant.name}</span>
            <span class="text-xs text-gray-500">Rollout: ${variant.rollout}%</span>
            ${Object.entries(variant.value || {}).map(([k, v]) => {
              let color = "bg-blue-100 text-blue-800";
              if (typeof v === "boolean") color = v ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800";
              return `<span class='inline-block ${color} px-2 py-0.5 rounded-full text-xs mr-1'>${k}: ${v}</span>`;
            }).join(" ")}
          </div>
        `).join("")}
      </div>
    `;
  } else if (result.type === "canary") {
    const { strat } = result;
    previewHtml = `
      <div class="mb-2">
        ${stratLabel}
        <div class="text-gray-500 text-xs mb-1">Conditions: ${strat.conditions.map(c => `${c.field} ${c.op} ${c.value}`).join(", ")}</div>
        <div class="text-base text-yellow-800 font-bold mb-2">Rollout: ${strat.rollout}%</div>
      </div>
      ${valueTags}
    `;
  }

  // ÌÜµÌï© Î†åÎçîÎßÅ
  panel.innerHTML = envFilterHtml + deviceInfoHtml + previewHtml;
}

function showStrategyResultModal(strat) {
  let modal = document.getElementById("strategyResultModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "strategyResultModal";
    modal.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50";
    modal.innerHTML = `
      <div class="bg-white p-7 rounded-2xl shadow-xl w-full max-w-2xl text-left relative" style="max-height:95vh; overflow-y:auto;">
        <button onclick="closeStrategyResultModal()" class="absolute top-2 right-4 text-2xl text-gray-400 hover:text-red-600 font-bold">‚úñÔ∏è</button>
        <h2 class="text-xl font-bold mb-2">Strategy Result</h2>
        <div class="modal-body"></div>
      </div>
    `;
    document.body.appendChild(modal);
  }

  // W-4~W0~W+4 (Ï¥ù 9Ï£º)
  const weekPast = 4, weekTest = 4, weekAfter = 4;
  const timelineLabels = [];
  for (let w = -weekPast; w <= weekAfter; ++w) {
    if (w === 0) timelineLabels.push("W0");
    else if (w > 0) timelineLabels.push(`W+${w}`);
    else timelineLabels.push(`W${w}`);
  }

  let metrics = strat.metrics || [];
  let metricList = metrics.map(key => {
    let m = (appData.metrics||[]).find(m=>m.key===key);
    return m ? `${m.displayName} (${m.unit})` : key;
  }).join(", ");

  let variantNames;
  if (strat.type === "canary") {
    const rollout = typeof strat.rollout === "number" ? strat.rollout : 10;
    variantNames = [
      `Canary (${rollout}%)`,
      `Base (${100 - rollout}%)`
    ];
  } else if (strat.type === "experiment") {
    variantNames = (strat.variants || []).map(v=>v.name);
  } else {
    variantNames = ["Group"];
  }

  const baseColors = ["#3b82f6", "#f59e42", "#10b981", "#f43f5e"];

  // metric Î∂ÑÎ¶¨
  let percentMetrics = [], numberMetrics = [], isPercentMetric = {};
  metrics.forEach(key => {
    let m = (appData.metrics||[]).find(m=>m.key===key);
    if (m && /(%|percent|per)/i.test(m.unit)) {
      percentMetrics.push(key); isPercentMetric[key] = true;
    } else {
      numberMetrics.push(key); isPercentMetric[key] = false;
    }
  });

  // Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
  const timelineData = {}, barData = {}, sumPerMetric = {};
  // ÏßëÍ≥ÑÎ≤îÏúÑ W1~W4 Ï†ïÌôïÌûà Ïû°Í∏∞
  const w1idx = timelineLabels.indexOf("W+1");
  const w4idx = timelineLabels.indexOf("W+4");

  metrics.forEach((key, mIdx) => {
    let isPercent = isPercentMetric[key];
    timelineData[key] = [];
    barData[key] = [];
    sumPerMetric[key] = [];
    variantNames.forEach((label, vIdx) => {
      // W-4~W+4(9Ï£º) ÎûúÎç§
      let timelineArr = [];
      for (let i = 0; i < timelineLabels.length; ++i) {
        timelineArr.push(
          isPercent ? Number((Math.random() * 100).toFixed(1)) : Math.floor(Math.random() * 900) + 100
        );
      }
      timelineData[key][vIdx] = timelineArr;
      // W+1~W+4 Íµ¨Í∞ÑÎßå Ï†ïÌôïÌûà Ïû°ÏïÑ ÏßëÍ≥Ñ (labelÏÉÅ W+1~W+4Í∞Ä Ïã§Ï†ú Ïã§ÌóòÍ∏∞Í∞Ñ)
      let periodVals = timelineArr.slice(w1idx, w4idx+1); // sliceÎäî ÎÅù+1ÍπåÏßÄ
      if (isPercent) {
        let avg = periodVals.length ? Number((periodVals.reduce((a, b) => a + b, 0) / periodVals.length).toFixed(1)) : 0;
        barData[key][vIdx] = [avg];
        sumPerMetric[key][vIdx] = avg;
      } else {
        let sum = periodVals.length ? periodVals.reduce((a, b) => a + b, 0) : 0;
        barData[key][vIdx] = [sum];
        sumPerMetric[key][vIdx] = sum;
      }
    });
  });

  // modal-body
  let tableHeader = metrics.map(key => {
    let m = (appData.metrics||[]).find(m=>m.key===key);
    return `<th class="border px-2 py-1">${m ? m.displayName : key}</th>`;
  }).join("");
  let tableRows = variantNames.map((label, vIdx) => `
    <tr>
      <td class="border px-2 py-1 font-bold">${label}</td>
      ${metrics.map((key, mIdx)=>{
        let m = (appData.metrics||[]).find(m=>m.key===key);
        let val = sumPerMetric[key][vIdx];
        return `<td class="border px-2 py-1">${val}${isPercentMetric[key] ? " %" : (m ? " "+m.unit : "")}</td>`;
      }).join("")}
    </tr>
  `).join("");

  modal.querySelector(".modal-body").innerHTML = `
    <div class="mb-2"><b>Metrics:</b> ${metricList}</div>
    <table class="w-full text-sm border mb-4">
      <thead><tr><th class="border px-2 py-1">Group</th>${tableHeader}</tr></thead>
      <tbody>${tableRows}</tbody>
    </table>
    <div class="mt-3">
      ${numberMetrics.length > 0 ? `
      <div class="mb-2 font-semibold">Number Metrics</div>
      <div style="width:600px; max-width:100%; margin:0 auto 32px auto;">
        <canvas id="resultChart_number" width="600" height="200"></canvas>
      </div>` : ""}
      ${percentMetrics.length > 0 ? `
      <div class="mb-2 font-semibold">Percent Metrics (%)</div>
      <div style="width:600px; max-width:100%; margin:0 auto 32px auto;">
        <canvas id="resultChart_percent" width="600" height="200"></canvas>
      </div>` : ""}
      <div style="overflow-y:auto; max-height:450px; width:100%; padding:0 4px;">
        <div style="display:flex; flex-direction:column; gap:32px; align-items:center;">
          ${metrics.map((key, mIdx) => `
            <div>
              <div class="font-semibold text-sm mb-2" style="margin-left:8px;">
                ${(appData.metrics||[]).find(m=>m.key===key)?.displayName || key}
              </div>
              <canvas id="timelineChart_${mIdx}" width="600" height="200"></canvas>
            </div>
          `).join("")}
        </div>
      </div>
    </div>
  `;
  modal.classList.remove("hidden");

  // ---- ÎßâÎåÄÍ∑∏ÎûòÌîÑ(ÏàòÏπòÌòï) ----
  if (numberMetrics.length > 0) {
    if (window._resultChart_number) window._resultChart_number.destroy();
    const ctx = document.getElementById('resultChart_number').getContext('2d');
    const barDatasetsNum = numberMetrics.map((key, mIdx) => ({
      label: (appData.metrics||[]).find(m=>m.key===key)?.displayName || key,
      data: variantNames.map((label, vIdx) => barData[key][vIdx][0]),
      backgroundColor: baseColors[mIdx % baseColors.length],
      borderWidth: 1
    }));
    window._resultChart_number = new Chart(ctx, {
      type: 'bar',
      data: { labels: variantNames, datasets: barDatasetsNum },
      options: {
        maintainAspectRatio: false,
        responsive: false,
        plugins: { legend: { display: true }},
        scales: { y: { beginAtZero: true, ticks: { stepSize: 100 } } }
      }
    });
  }

  // ---- ÎßâÎåÄÍ∑∏ÎûòÌîÑ(ÌçºÏÑºÌä∏Ìòï) ----
  if (percentMetrics.length > 0) {
    if (window._resultChart_percent) window._resultChart_percent.destroy();
    const ctx = document.getElementById('resultChart_percent').getContext('2d');
    const barDatasetsPct = percentMetrics.map((key, mIdx) => ({
      label: (appData.metrics||[]).find(m=>m.key===key)?.displayName || key,
      data: variantNames.map((label, vIdx) => barData[key][vIdx][0]),
      backgroundColor: baseColors[mIdx % baseColors.length],
      borderWidth: 1
    }));
    window._resultChart_percent = new Chart(ctx, {
      type: 'bar',
      data: { labels: variantNames, datasets: barDatasetsPct },
      options: {
        maintainAspectRatio: false,
        responsive: false,
        plugins: { legend: { display: true }},
        scales: { y: { beginAtZero: true, max: 100, ticks: { stepSize: 10 } } }
      }
    });
  }

  // ---- ÎùºÏù∏ Ï∞®Ìä∏(W-4~W+4): Zoom/Ìå¨ + W0(START) annotation ÌîåÎü¨Í∑∏Ïù∏ Ï†ÅÏö©!
  metrics.forEach((key, mIdx) => {
    if (window['_timelineChart'+mIdx]) window['_timelineChart'+mIdx].destroy();
    const tctx = document.getElementById('timelineChart_'+mIdx).getContext('2d');
    const timelineDatasets = variantNames.map((label, vIdx) => ({
      label: label,
      data: timelineData[key][vIdx],
      borderWidth: 2,
      borderColor: baseColors[vIdx % baseColors.length],
      backgroundColor: "transparent",
      fill: false,
      tension: 0.3,
      pointRadius: 2
    }));
    window['_timelineChart'+mIdx] = new Chart(tctx, {
      type: 'line',
      data: {
        labels: timelineLabels,
        datasets: timelineDatasets
      },
      options: {
        maintainAspectRatio: false,
        responsive: false,
        plugins: {
          legend: { display: true },
          zoom: {
            pan: { enabled: true, mode: 'x' },
            zoom: {
              wheel: { enabled: true },
              pinch: { enabled: true },
              mode: 'x'
            }
          },
          annotation: {
            annotations: {
              w0line: {
                type: 'line',
                scaleID: 'x',
                value: 'W0',
                borderColor: 'red',
                borderWidth: 2,
                borderDash: [8, 4],
                label: {
                  enabled: true,
                  content: 'START',
                  color: 'red',
                  position: 'start',
                  backgroundColor: 'rgba(255,255,255,0.8)'
                }
              }
            }
          }
        },
        scales: { 
          y: isPercentMetric[key]
            ? { beginAtZero: true, max: 100, ticks: { stepSize: 10 } }
            : { beginAtZero: true, ticks: { stepSize: 100 } }
        }
      }
    });
  });
}

function closeStrategyResultModal() {
  const modal = document.getElementById("strategyResultModal");
  if (modal) modal.classList.add("hidden");
}




</script>
</body>
<!-- Footer Bar (Build/Commit + Remote Send) -->
<div id="footer-bar" class="fixed left-0 bottom-0 w-full bg-blue-950 text-white flex items-center justify-end gap-4 px-8 py-3 shadow-lg z-50"
     style="height:55px;">
  <button id="btn-build-commit"
    class="bg-blue-700 hover:bg-blue-600 text-white font-bold px-5 py-2 rounded-xl shadow mr-1 transition"
    onclick="onBuildCommit()">
    <span class="mr-2">üî®</span> Commit to Repo
  </button>
  <button id="btn-remote-send"
    class="bg-green-600 hover:bg-green-500 text-white font-bold px-5 py-2 rounded-xl shadow transition"
    onclick="onRemoteSend()">
    <span class="mr-2">üöÄ</span> Send to Remote
  </button>
</div>
</html>